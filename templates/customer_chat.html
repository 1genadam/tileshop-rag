<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Chat - The Tile Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <!-- WebXR + Three.js for AR Tile Visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/webxr/VRButton.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .chat-container {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .message-bubble.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        
        .message-bubble.assistant {
            background-color: #f3f4f6;
            color: #1f2937;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }
        
        .aos-indicator {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: bounce 1.4s infinite both;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Dynamic Form Styles */
        .form-section {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .form-section h3 {
            color: #1f2937;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .phone-input {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .phone-input input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        
        .phone-input button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .phone-status {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .phone-status.found {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .phone-status.not-found {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        .project-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .project-options label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .project-options label:hover {
            background: #f9fafb;
        }
        
        .project-options input[type="radio"]:checked + label {
            background: #eff6ff;
            border-color: #3b82f6;
        }
        
        .selection-controls {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .selection-controls select {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        
        .dimensions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .dimensions input {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        
        .tile-selection {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .materials-summary {
            background: #f0f9ff;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e0f2fe;
        }
        
        .add-surface-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .calculated-display {
            background: #f3f4f6;
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
            font-weight: 500;
        }
        
        .form-toggle {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 3.5rem;
            height: 3.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 1000;
        }
        
        .form-panel {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 400px;
            max-height: 80vh;
            background: white;
            border-radius: 0.75rem 0.75rem 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 999;
            overflow-y: auto;
        }
        
        .form-panel.open {
            transform: translateY(0);
        }
        
        .form-panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem 0.75rem 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .form-panel-content {
            padding: 1rem;
        }
        
        @media (max-width: 640px) {
            .form-panel {
                width: 100%;
                max-width: 100%;
            }
        }
        
        /* Phase 4: Appointment System Styles */
        .appointment-card {
            background: #f0f9ff;
            border: 1px solid #e0f2fe;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .appointment-card.success {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }
        
        .appointment-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .appointment-header i {
            font-size: 1.5rem;
            color: #3b82f6;
        }
        
        .appointment-card.success .appointment-header i {
            color: #10b981;
        }
        
        .appointment-header h3 {
            margin: 0;
            color: #1f2937;
        }
        
        .appointment-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .appointment-types {
            margin-bottom: 1.5rem;
        }
        
        .appointment-type {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .appointment-type:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }
        
        .appointment-type.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .appointment-type h4 {
            margin: 0 0 0.5rem 0;
            color: #1f2937;
        }
        
        .appointment-type p {
            margin: 0 0 0.5rem 0;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .appointment-duration {
            color: #3b82f6;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .time-slots {
            margin-bottom: 1.5rem;
        }
        
        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }
        
        .time-slot {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            font-weight: 500;
        }
        
        .time-slot:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }
        
        .time-slot.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #3b82f6;
        }
        
        .appointment-form {
            border-top: 1px solid #e5e7eb;
            padding-top: 1.5rem;
        }
        
        .appointment-form .form-group {
            margin-bottom: 1rem;
        }
        
        .appointment-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .appointment-form input,
        .appointment-form textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        
        .appointment-form textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        
        .confirmation-details {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .confirmation-details p {
            margin: 0.5rem 0;
        }
        
        .next-steps {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .next-steps h4 {
            margin: 0 0 0.75rem 0;
            color: #1f2937;
        }
        
        .next-steps ul {
            margin: 0;
            padding-left: 1.5rem;
        }
        
        .next-steps li {
            margin-bottom: 0.5rem;
            color: #4b5563;
        }
        
        .frustration-debug {
            background: #f9fafb;
            border-radius: 0.25rem;
            padding: 0.5rem;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-4 flex items-center justify-center">
        <!-- Dynamic Form Toggle Button -->
        <button id="form-toggle" class="form-toggle" onclick="toggleFormPanel()">
            <i class="fas fa-clipboard-list"></i>
        </button>
        
        <!-- Dynamic Form Panel -->
        <div id="form-panel" class="form-panel">
            <div class="form-panel-header">
                <h2 class="text-lg font-semibold">üìã Project Details</h2>
                <button onclick="toggleFormPanel()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="form-panel-content">
                <!-- Phone Number Section -->
                <div class="form-section">
                    <h3>üì± Customer Information</h3>
                    <div class="phone-input">
                        <input type="tel" id="customer-phone" placeholder="Phone Number" maxlength="14">
                        <button onclick="lookupCustomer()">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div id="phone-status" class="phone-status" style="display: none;">
                        <span id="phone-status-text"></span>
                        <button id="different-number-btn" onclick="enterDifferentNumber()" style="display: none; margin-left: 1rem; padding: 0.25rem 0.75rem; background: transparent; border: 1px solid #6b7280; border-radius: 0.25rem; cursor: pointer;">
                            Enter Different Number
                        </button>
                        <button id="create-account-btn" onclick="showCreateAccountFields()" style="display: none; margin-left: 1rem; padding: 0.25rem 0.75rem; background: #10b981; color: white; border: 1px solid #10b981; border-radius: 0.25rem; cursor: pointer;">
                            Create Account
                        </button>
                    </div>
                    
                    <!-- Customer Information Fields - Hidden by default -->
                    <div id="customer-info-fields" style="display: none;">
                        <input type="text" id="customer-name" placeholder="Customer Name" class="w-full p-3 border border-gray-300 rounded-lg mb-2">
                        <input type="email" id="customer-email" placeholder="Email Address" class="w-full p-3 border border-gray-300 rounded-lg mb-2">
                        <input type="text" id="customer-address" placeholder="Address" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                </div>
                
                <!-- Project Selection -->
                <div class="form-section">
                    <h3>üè† Project Selection</h3>
                    <div class="project-options">
                        <label>
                            <input type="radio" name="project" value="new" checked>
                            <span>New Project</span>
                        </label>
                        <label style="display: none;" id="continue-project-option">
                            <input type="radio" name="project" value="continue">
                            <span>Continue Project:</span>
                            <select id="existing-projects" style="margin-left: 0.5rem;">
                                <option>Select existing project...</option>
                            </select>
                        </label>
                    </div>
                    <input type="text" id="project-name" placeholder="Project Name" class="w-full p-3 border border-gray-300 rounded-lg mb-2">
                    <input type="text" id="project-address" placeholder="Address" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                
                <!-- Current Selection -->
                <div class="form-section">
                    <h3>üî® Current Selection</h3>
                    <div class="selection-controls">
                        <select id="area-select" onchange="updateCurrentSelection()">
                            <option value="">Select Area...</option>
                            <option value="bathroom-1">Bathroom 1</option>
                            <option value="bathroom-2">Bathroom 2</option>
                            <option value="bathroom-3">Bathroom 3</option>
                            <option value="kitchen">Kitchen</option>
                            <option value="living-room">Living Room</option>
                            <option value="patio">Patio</option>
                            <option value="entry">Entry</option>
                            <option value="basement">Basement</option>
                            <option value="halls">Halls</option>
                        </select>
                        <select id="surface-select" onchange="updateCurrentSelection()">
                            <option value="">Select Surface...</option>
                            <option value="wall">Wall</option>
                            <option value="floor">Floor</option>
                            <option value="ceiling">Ceiling</option>
                            <option value="half-wall">1/2 Wall</option>
                            <option value="wainscoting">Wainscoting</option>
                            <option value="shower-floor">Shower Floor</option>
                            <option value="main-floor">Main Floor</option>
                            <option value="bathtub-surround">Bathtub Surround</option>
                            <option value="niche-interior">Niche Interior</option>
                            <option value="niche-trim">Niche Trim</option>
                            <option value="wall-framing-trim">Wall Framing Trim</option>
                            <option value="curb">Curb</option>
                            <option value="threshold">Threshold</option>
                            <option value="floor-molding">Floor Molding</option>
                        </select>
                    </div>
                    <div class="dimensions">
                        <input type="number" id="surface-length" placeholder="Length (ft)" step="0.1" onchange="calculateSurface()">
                        <input type="number" id="surface-width" placeholder="Width (ft)" step="0.1" onchange="calculateSurface()">
                        <input type="number" id="surface-height" placeholder="Height (ft)" step="0.1" onchange="calculateSurface()">
                    </div>
                    <div class="calculated-display" id="calculated-amount">
                        <span id="calculated-value">0</span> <span id="calculated-unit">sq ft</span>
                    </div>
                    <div class="tile-selection">
                        <span id="selected-tile-display">No Tile Selected</span>
                        <button onclick="changeTile()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-sync"></i> Change
                        </button>
                    </div>
                    <div class="materials-summary" id="materials-summary">
                        <div class="grout-info">
                            <strong>Grout:</strong> <span id="grout-recommendation">Select tile first</span>
                        </div>
                        <div class="cost-summary">
                            <strong>Total Cost:</strong> <span id="total-cost">$0.00</span>
                        </div>
                    </div>
                    <button class="add-surface-btn" onclick="addSurface()">
                        <i class="fas fa-plus"></i> Add Another Surface
                    </button>
                </div>
                
                <!-- Saved Surfaces -->
                <div class="form-section" id="saved-surfaces-section" style="display: none;">
                    <h3>üì¶ Saved Surfaces</h3>
                    <div id="saved-surfaces-list"></div>
                </div>
                
                <!-- Auto-save Status -->
                <div class="text-center text-sm text-gray-500 mt-4">
                    <span id="auto-save-status">Auto-save enabled</span>
                </div>
            </div>
        </div>
        
        <div class="chat-container w-full max-w-4xl h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-t-lg">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-user mr-3"></i>
                            Customer Consultation
                        </h1>
                        <p class="text-blue-100 mt-1">Professional tile consultation with AOS methodology</p>
                    </div>
                    <div class="text-right">
                        <div class="aos-indicator">
                            AOS Phase: <span id="aos-phase">Discovery</span>
                        </div>
                        <div class="text-sm text-blue-100 mt-1">Port: 8081</div>
                    </div>
                </div>
            </div>

            <!-- Hybrid Interface Info -->
            <div class="p-4 bg-gradient-to-r from-green-50 to-blue-50 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                        <span class="text-sm font-medium text-gray-700">Use the form panel to enter project details - I'll provide expert guidance based on your structured data</span>
                    </div>
                    <button onclick="toggleFormPanel()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                        <i class="fas fa-clipboard-list mr-2"></i>Open Form Panel
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="flex-grow overflow-y-auto p-6" id="chat-messages">
                <div class="space-y-4">
                    <div class="flex justify-start">
                        <div class="message-bubble assistant">
                            <p>Hi! I'm Alex from The Tile Shop. I've been helping customers create beautiful tile installations for over 8 years.</p>
                            <p class="mt-2">üëÜ <strong>Please use the form panel above to enter your project details</strong> - I'll provide expert guidance based on your structured data rather than asking endless questions.</p>
                            <p class="text-xs text-gray-500 mt-2">Using professional AOS methodology with hybrid form/LLM interface for 4/4 performance</p>
                        </div>
                    </div>
                </div>
                
                <!-- Typing Indicator -->
                <div class="flex justify-start hidden" id="typing-indicator">
                    <div class="message-bubble assistant">
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AOS Progress Tracker -->
            <div class="px-6 py-3 bg-gray-50 border-t border-gray-200">
                <div class="flex justify-between items-center text-sm">
                    <div class="flex space-x-4">
                        <span class="aos-step" id="step-greeting">
                            <i class="fas fa-handshake mr-1"></i>Greeting
                        </span>
                        <span class="aos-step" id="step-needs">
                            <i class="fas fa-clipboard-list mr-1"></i>Needs Assessment
                        </span>
                        <span class="aos-step" id="step-design">
                            <i class="fas fa-palette mr-1"></i>Design & Details
                        </span>
                        <span class="aos-step" id="step-close">
                            <i class="fas fa-handshake mr-1"></i>Close
                        </span>
                    </div>
                    <div class="text-gray-500">
                        Requirements: <span id="requirements-status">Collecting...</span>
                    </div>
                </div>
            </div>

            <!-- NEPQ Performance Tracker -->
            <div class="px-6 py-3 bg-purple-50 border-t border-purple-200" id="nepq-tracker" style="display: none;">
                <div class="flex justify-between items-center text-sm">
                    <div class="flex items-center space-x-4">
                        <span class="font-medium text-purple-800">NEPQ Performance:</span>
                        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full font-medium" id="nepq-overall-score">--/100</span>
                        <span class="text-purple-600" id="nepq-grade">--</span>
                    </div>
                    <button class="text-purple-600 hover:text-purple-800 text-xs" onclick="toggleNEPQDetails()">
                        <i class="fas fa-chart-bar mr-1"></i>View Details
                    </button>
                </div>
                
                <!-- NEPQ Stage Breakdown (Hidden by default) -->
                <div class="mt-3 hidden" id="nepq-details">
                    <div class="grid grid-cols-4 gap-2 text-xs">
                        <div class="bg-white rounded p-2 text-center">
                            <div class="font-medium text-purple-800">Connection</div>
                            <div class="text-lg font-bold" id="nepq-connection">--/10</div>
                        </div>
                        <div class="bg-white rounded p-2 text-center">
                            <div class="font-medium text-purple-800">Problem Awareness</div>
                            <div class="text-lg font-bold" id="nepq-problem-awareness">--/10</div>
                        </div>
                        <div class="bg-white rounded p-2 text-center">
                            <div class="font-medium text-purple-800">Consequence Discovery</div>
                            <div class="text-lg font-bold" id="nepq-consequence">--/10</div>
                        </div>
                        <div class="bg-white rounded p-2 text-center">
                            <div class="font-medium text-purple-800">Solution Awareness</div>
                            <div class="text-lg font-bold" id="nepq-solution">--/10</div>
                        </div>
                        <div class="bg-white rounded p-2 text-center">
                            <div class="font-medium text-purple-800">Qualifying Questions</div>
                            <div class="text-lg font-bold" id="nepq-qualifying">--/10</div>
                        </div>
                        <div class="bg-white rounded p-2 text-center">
                            <div class="font-medium text-purple-800">Objection Handling</div>
                            <div class="text-lg font-bold" id="nepq-objections">--/10</div>
                        </div>
                        <div class="bg-white rounded p-2 text-center">
                            <div class="font-medium text-purple-800">Commitment Stage</div>
                            <div class="text-lg font-bold" id="nepq-commitment">--/10</div>
                        </div>
                        <div class="bg-white rounded p-2 text-center">
                            <div class="font-medium text-purple-800">Metrics</div>
                            <div class="text-xs">
                                <div>Q: <span id="nepq-questions">0</span></div>
                                <div>Obj: <span id="nepq-objections-count">0</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Improvement Focus -->
                    <div class="mt-2 p-2 bg-yellow-50 rounded border border-yellow-200" id="nepq-improvements" style="display: none;">
                        <div class="font-medium text-yellow-800 text-xs mb-1">Focus Areas:</div>
                        <div class="text-xs text-yellow-700" id="nepq-focus-areas">--</div>
                    </div>
                </div>
            </div>

            <!-- Hybrid Form/LLM Structured Data Panel -->
            <div class="px-6 py-3 bg-gradient-to-r from-blue-50 to-indigo-50 border-t border-blue-200" id="project-organizer" style="display: none;">
                <!-- Project Setup Header -->
                <div class="bg-white rounded-lg p-4 mb-4 border border-blue-200 shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-bold text-blue-800">üìã Project Details</h3>
                        <div class="text-sm text-blue-600">Structured Data Entry</div>
                    </div>
                    
                    <!-- Project Basic Info -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                            <input type="text" id="project-name" placeholder="e.g., Master Bathroom Renovation" 
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   onchange="updateProjectData()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Room Type</label>
                            <select id="room-type" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    onchange="updateProjectData()">
                                <option value="">Select Room Type</option>
                                <option value="bathroom">Bathroom</option>
                                <option value="kitchen">Kitchen</option>
                                <option value="living-room">Living Room</option>
                                <option value="bedroom">Bedroom</option>
                                <option value="laundry-room">Laundry Room</option>
                                <option value="entryway">Entryway</option>
                                <option value="commercial">Commercial</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                            <input type="text" id="customer-name" placeholder="Your name" 
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   onchange="updateProjectData()">
                        </div>
                    </div>
                    
                    <!-- Room Dimensions -->
                    <div class="bg-gray-50 rounded-lg p-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Room Dimensions</label>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2">
                                <input type="number" id="room-length" placeholder="Length" step="0.1" min="0"
                                       class="w-20 border border-gray-300 rounded px-2 py-1 text-center focus:ring-2 focus:ring-blue-500"
                                       onchange="calculateRoomArea()">
                                <span class="text-gray-600">√ó</span>
                                <input type="number" id="room-width" placeholder="Width" step="0.1" min="0"
                                       class="w-20 border border-gray-300 rounded px-2 py-1 text-center focus:ring-2 focus:ring-blue-500"
                                       onchange="calculateRoomArea()">
                                <select id="dimension-unit" class="border border-gray-300 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500"
                                        onchange="calculateRoomArea()">
                                    <option value="feet">feet</option>
                                    <option value="meters">meters</option>
                                </select>
                            </div>
                            <div class="text-lg font-medium text-blue-800" id="calculated-area">= 0 sq ft</div>
                        </div>
                    </div>
                </div>
                
                <!-- Surface Selection Header -->
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-medium text-blue-800">üéØ Surface Planning</h3>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm" onclick="addSurfaceToProject()">
                        <i class="fas fa-plus mr-1"></i>Add Surface
                    </button>
                </div>
                
                <!-- Project Areas -->
                <div class="space-y-3" id="project-areas">
                    <!-- Areas will be dynamically added here -->
                </div>
                
                <!-- Project Summary -->
                <div class="mt-4 p-3 bg-white rounded-lg border border-blue-200" id="project-summary" style="display: none;">
                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <span class="font-medium text-blue-800">Total Project Cost:</span>
                            <span class="text-xl font-bold text-green-600 ml-2" id="total-project-cost">$0.00</span>
                        </div>
                        <div class="text-sm text-blue-600">
                            <span id="total-areas">0</span> areas ‚Ä¢ <span id="total-surfaces">0</span> surfaces ‚Ä¢ <span id="total-sq-ft">0</span> sq ft
                        </div>
                    </div>
                    
                    <!-- Design Generation Section -->
                    <div class="pt-3 border-t border-blue-200" id="design-generation-section" style="display: none;">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-medium text-purple-800">üé® AI Room Design</h4>
                            <div class="flex items-center space-x-2">
                                <select id="design-style" class="text-sm border border-gray-300 rounded px-2 py-1 focus:ring-2 focus:ring-purple-500">
                                    <option value="modern">Modern</option>
                                    <option value="traditional">Traditional</option>
                                    <option value="transitional">Transitional</option>
                                    <option value="industrial">Industrial</option>
                                    <option value="farmhouse">Farmhouse</option>
                                </select>
                                <button class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm flex items-center" 
                                        onclick="generateRoomDesign()" id="generate-design-btn">
                                    <i class="fas fa-magic mr-1"></i>Generate Design
                                </button>
                            </div>
                        </div>
                        
                        <!-- Design Preview -->
                        <div class="hidden" id="design-preview">
                            <div class="relative">
                                <img id="generated-design-image" class="w-full rounded-lg border-2 border-purple-300" />
                                <div class="absolute top-2 right-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-xs">
                                    AI Generated with DALL-E 3
                                </div>
                            </div>
                            
                            <!-- Design Details -->
                            <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div class="bg-purple-50 p-3 rounded">
                                    <h5 class="font-medium text-purple-800 mb-2">Room Specifications</h5>
                                    <div class="text-sm text-purple-700" id="room-specs"></div>
                                </div>
                                <div class="bg-green-50 p-3 rounded">
                                    <h5 class="font-medium text-green-800 mb-2">Tiles Used</h5>
                                    <div class="text-sm text-green-700" id="tiles-used"></div>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="mt-3 flex space-x-2">
                                <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm flex items-center" 
                                        onclick="regenerateDesign()">
                                    <i class="fas fa-redo mr-2"></i>Generate Another Design
                                </button>
                                <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm flex items-center" 
                                        onclick="saveDesignToProject()">
                                    <i class="fas fa-save mr-2"></i>Save Design
                                </button>
                                <button class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm flex items-center" 
                                        onclick="shareDesign()">
                                    <i class="fas fa-share mr-2"></i>Share
                                </button>
                            </div>
                        </div>
                        
                        <!-- Generation Loading -->
                        <div class="hidden text-center py-6" id="design-loading">
                            <div class="inline-flex items-center">
                                <svg class="animate-spin h-6 w-6 text-purple-600 mr-3" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span class="text-purple-800 font-medium">Generating your room design...</span>
                            </div>
                            <p class="text-purple-600 text-sm mt-2">This may take 10-30 seconds</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Surface Selection Modal (Hidden by default) -->
            <div class="hidden fixed inset-0 bg-black bg-opacity-50 z-50" id="surface-modal">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold text-gray-800">Select Surface Type</h3>
                                <button onclick="closeSurfaceModal()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            <p class="text-gray-600 mt-1">Choose the surface you want to tile in <span id="current-area-name" class="font-medium">this area</span></p>
                        </div>
                        
                        <div class="p-6">
                            <!-- Surface Categories -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Bathroom Surfaces -->
                                <div class="space-y-3">
                                    <h4 class="font-medium text-blue-800 border-b border-blue-200 pb-2">üöø Bathroom</h4>
                                    <div class="space-y-2">
                                        <button class="surface-option w-full text-left p-3 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50" 
                                                data-surface="shower-walls" data-category="bathroom">
                                            <div class="font-medium">Shower Walls</div>
                                            <div class="text-sm text-gray-600">Interior shower surfaces</div>
                                        </button>
                                        <button class="surface-option w-full text-left p-3 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50" 
                                                data-surface="bathroom-floor" data-category="bathroom">
                                            <div class="font-medium">Bathroom Floor</div>
                                            <div class="text-sm text-gray-600">Floor surface, slip-resistant</div>
                                        </button>
                                        <button class="surface-option w-full text-left p-3 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50" 
                                                data-surface="vanity-backsplash" data-category="bathroom">
                                            <div class="font-medium">Vanity Backsplash</div>
                                            <div class="text-sm text-gray-600">Behind sink area</div>
                                        </button>
                                        <button class="surface-option w-full text-left p-3 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50" 
                                                data-surface="tub-surround" data-category="bathroom">
                                            <div class="font-medium">Tub Surround</div>
                                            <div class="text-sm text-gray-600">Around bathtub area</div>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Kitchen Surfaces -->
                                <div class="space-y-3">
                                    <h4 class="font-medium text-green-800 border-b border-green-200 pb-2">üçΩÔ∏è Kitchen</h4>
                                    <div class="space-y-2">
                                        <button class="surface-option w-full text-left p-3 border border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50" 
                                                data-surface="kitchen-backsplash" data-category="kitchen">
                                            <div class="font-medium">Kitchen Backsplash</div>
                                            <div class="text-sm text-gray-600">Behind counters & stove</div>
                                        </button>
                                        <button class="surface-option w-full text-left p-3 border border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50" 
                                                data-surface="kitchen-floor" data-category="kitchen">
                                            <div class="font-medium">Kitchen Floor</div>
                                            <div class="text-sm text-gray-600">High-traffic floor area</div>
                                        </button>
                                        <button class="surface-option w-full text-left p-3 border border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50" 
                                                data-surface="island-backsplash" data-category="kitchen">
                                            <div class="font-medium">Island Backsplash</div>
                                            <div class="text-sm text-gray-600">Kitchen island sides</div>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Living Area Surfaces -->
                                <div class="space-y-3">
                                    <h4 class="font-medium text-purple-800 border-b border-purple-200 pb-2">üè° Living Areas</h4>
                                    <div class="space-y-2">
                                        <button class="surface-option w-full text-left p-3 border border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50" 
                                                data-surface="entryway-floor" data-category="living">
                                            <div class="font-medium">Entryway Floor</div>
                                            <div class="text-sm text-gray-600">Entry & foyer areas</div>
                                        </button>
                                        <button class="surface-option w-full text-left p-3 border border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50" 
                                                data-surface="fireplace-surround" data-category="living">
                                            <div class="font-medium">Fireplace Surround</div>
                                            <div class="text-sm text-gray-600">Around fireplace</div>
                                        </button>
                                        <button class="surface-option w-full text-left p-3 border border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50" 
                                                data-surface="accent-wall" data-category="living">
                                            <div class="font-medium">Accent Wall</div>
                                            <div class="text-sm text-gray-600">Decorative wall surface</div>
                                        </button>
                                        <button class="surface-option w-full text-left p-3 border border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50" 
                                                data-surface="laundry-room" data-category="living">
                                            <div class="font-medium">Laundry Room</div>
                                            <div class="text-sm text-gray-600">Utility room surfaces</div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vision Mode Selection (Hidden by default) -->
            <div class="hidden p-6 border-t border-gray-200 bg-purple-50" id="vision-mode-selector">
                <div class="text-center">
                    <h3 class="text-lg font-medium text-purple-800 mb-4">üì∏ How can I help with your tile?</h3>
                    
                    <div class="flex justify-center space-x-4 mb-4">
                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg flex items-center" 
                                onclick="selectVisionMode('similarity')">
                            <i class="fas fa-search mr-2"></i>
                            <div class="text-left">
                                <div class="font-medium">Find Similar Tiles</div>
                                <div class="text-xs opacity-90">Match against our database</div>
                            </div>
                        </button>
                        <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg flex items-center" 
                                onclick="selectVisionMode('store')">
                            <i class="fas fa-map-marker-alt mr-2"></i>
                            <div class="text-left">
                                <div class="font-medium">Find in Store</div>
                                <div class="text-xs opacity-90">Get aisle location & inventory</div>
                            </div>
                        </button>
                    </div>
                    
                    <button class="text-gray-600 hover:text-gray-800 text-sm" onclick="closeVisionSystem()">
                        <i class="fas fa-times mr-1"></i>Cancel
                    </button>
                </div>
            </div>

            <!-- Tile Vision Scanner (Hidden by default) -->
            <div class="hidden p-6 border-t border-gray-200 bg-purple-50" id="vision-scanner">
                <div class="text-center">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-purple-800">üì∏ <span id="vision-mode-title">Scan Your Tile</span></h3>
                        <div class="text-sm text-purple-600 font-medium" id="vision-mode-badge">Similarity Mode</div>
                    </div>
                    
                    <!-- Camera Controls -->
                    <div class="mb-4 space-x-3">
                        <button class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg" 
                                onclick="startCamera()" id="start-camera-btn">
                            <i class="fas fa-camera mr-2"></i>Start Camera
                        </button>
                        <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg hidden" 
                                onclick="captureImage()" id="capture-btn">
                            <i class="fas fa-capture mr-2"></i>Capture Tile
                        </button>
                        <button class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg hidden" 
                                onclick="stopCamera()" id="stop-camera-btn">
                            <i class="fas fa-stop mr-2"></i>Stop
                        </button>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg hidden" 
                                onclick="analyzeCapturedTile()" id="analyze-tile-btn">
                            <i class="fas fa-search mr-2"></i>Analyze Tile
                        </button>
                        <button class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg hidden" 
                                onclick="retakePhoto()" id="retake-btn">
                            <i class="fas fa-redo mr-2"></i>Retake
                        </button>
                    </div>
                    
                    <!-- Video Preview -->
                    <div class="relative inline-block">
                        <video id="camera-video" width="320" height="240" autoplay class="hidden border-2 border-purple-300 rounded-lg"></video>
                        <canvas id="capture-canvas" width="320" height="240" class="hidden"></canvas>
                        
                        <!-- Capture Preview -->
                        <div class="hidden mt-4" id="captured-preview">
                            <img id="captured-image" class="border-2 border-green-300 rounded-lg mx-auto" width="320" height="240" />
                            <div class="mt-2 space-x-3">
                                <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg" 
                                        onclick="analyzeCapturedTile()">
                                    <i class="fas fa-search mr-2"></i>Find This Tile
                                </button>
                                <button class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg" 
                                        onclick="retakePhoto()">
                                    <i class="fas fa-redo mr-2"></i>Retake
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analysis Results -->
                    <div class="hidden mt-4 p-4 bg-white rounded-lg border" id="vision-results">
                        <h4 class="font-medium text-gray-800 mb-2">üéØ Tile Matches Found:</h4>
                        <div id="tile-matches"></div>
                    </div>
                    
                    <!-- Instructions -->
                    <div class="mt-4 text-sm text-purple-600">
                        üí° <strong>Tips:</strong> Hold tile flat, ensure good lighting, fill frame with tile for best results
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="p-6 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                <div class="flex items-center space-x-3">
                    <div class="relative flex-grow">
                        <i class="fas fa-comment absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input class="w-full border border-gray-300 rounded-lg py-3 pl-10 pr-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" 
                               id="chat-input" placeholder="Tell me about your tile project..." type="text" maxlength="500">
                    </div>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg flex items-center transition duration-200" 
                            onclick="toggleProjectOrganizer()" id="project-toggle-btn">
                        <i class="fas fa-home mr-2"></i>Project
                    </button>
                    <button class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-4 rounded-lg flex items-center transition duration-200" 
                            onclick="toggleVisionScanner()" id="vision-toggle-btn">
                        <i class="fas fa-camera mr-2"></i>Scan Tile
                    </button>
                    <button class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg flex items-center transition duration-200" 
                            onclick="startARVisualization()" id="ar-toggle-btn">
                        <i class="fas fa-cube mr-2"></i>AR View
                    </button>
                    <button class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-medium py-3 px-6 rounded-lg flex items-center transition duration-200" 
                            id="send-button" onclick="sendMessage()">
                        <i class="fas fa-paper-plane mr-2"></i>Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AR Visualization Container -->
    <div id="ar-container" class="fixed inset-0 bg-black z-50 hidden">
        <div class="absolute top-4 left-4 right-4 z-10">
            <div class="bg-white bg-opacity-90 rounded-lg p-4 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h3 class="text-lg font-bold text-gray-800">AR Tile Visualization</h3>
                    <div class="flex space-x-2">
                        <button onclick="switchTilePattern('ceramic')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                            Ceramic
                        </button>
                        <button onclick="switchTilePattern('porcelain')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                            Porcelain
                        </button>
                        <button onclick="switchTilePattern('natural-stone')" class="bg-amber-500 text-white px-3 py-1 rounded text-sm hover:bg-amber-600">
                            Natural Stone
                        </button>
                    </div>
                </div>
                <button onclick="showTileSelector()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 mr-2">
                    Select Tile
                </button>
                <button onclick="exitARVisualization()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                    <i class="fas fa-times mr-1"></i>Exit AR
                </button>
            </div>
        
        <!-- Tile Selection Modal for AR -->
        <div id="ar-tile-selector" class="absolute top-20 left-4 right-4 bg-white rounded-lg p-4 shadow-lg hidden">
            <h4 class="text-lg font-bold mb-3">Select Tile for AR Preview</h4>
            
            <!-- Search by SKU -->
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Search by SKU</label>
                <input type="text" id="ar-sku-search" placeholder="Enter SKU (e.g., MCF-001)" 
                       class="w-full border border-gray-300 rounded px-3 py-2" 
                       onchange="searchTileForAR('sku', this.value)">
            </div>
            
            <!-- Search by Color -->
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Search by Color</label>
                <select id="ar-color-search" class="w-full border border-gray-300 rounded px-3 py-2" 
                        onchange="searchTileForAR('color', this.value)">
                    <option value="">Select Color</option>
                    <option value="white">White</option>
                    <option value="gray">Gray</option>
                    <option value="black">Black</option>
                    <option value="beige">Beige</option>
                    <option value="brown">Brown</option>
                    <option value="blue">Blue</option>
                    <option value="green">Green</option>
                    <option value="red">Red</option>
                </select>
            </div>
            
            <!-- Search by Description -->
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Search by Description</label>
                <input type="text" id="ar-desc-search" placeholder="e.g., modern subway tile" 
                       class="w-full border border-gray-300 rounded px-3 py-2" 
                       onchange="searchTileForAR('description', this.value)">
            </div>
            
            <!-- Search Results -->
            <div id="ar-search-results" class="mb-3 max-h-40 overflow-y-auto hidden">
                <div class="text-sm font-medium text-gray-700 mb-2">Available Tiles:</div>
                <div id="ar-tile-options" class="space-y-2"></div>
            </div>
            
            <div class="flex justify-end space-x-2">
                <button onclick="hideTileSelector()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Cancel
                </button>
                <button onclick="applySelectedTileToAR()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Apply to AR
                </button>
            </div>
        </div>
        </div>
        
        <!-- AR Scene Canvas -->
        <canvas id="ar-canvas" class="w-full h-full"></canvas>
        
        <!-- AR Controls -->
        <div class="absolute bottom-4 left-4 right-4 z-10">
            <div class="bg-white bg-opacity-90 rounded-lg p-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                    <div>
                        <label class="block text-gray-700 font-medium mb-1">Tile Size:</label>
                        <select id="ar-tile-size" onchange="updateTileSize()" class="w-full border rounded px-2 py-1">
                            <option value="12x12">12" √ó 12"</option>
                            <option value="18x18">18" √ó 18"</option>
                            <option value="24x24">24" √ó 24"</option>
                            <option value="6x24">6" √ó 24"</option>
                            <option value="12x24">12" √ó 24"</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-1">Pattern:</label>
                        <select id="ar-pattern" onchange="updateTilePattern()" class="w-full border rounded px-2 py-1">
                            <option value="straight">Straight Lay</option>
                            <option value="diagonal">Diagonal</option>
                            <option value="herringbone">Herringbone</option>
                            <option value="subway">Subway</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-1">Grout Color:</label>
                        <input type="color" id="ar-grout-color" value="#cccccc" onchange="updateGroutColor()" 
                               class="w-full border rounded px-1 py-1">
                    </div>
                    <div class="flex items-end">
                        <button onclick="saveARView()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
                            <i class="fas fa-save mr-1"></i>Save View
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let conversation_history = [];
        let socket = io();

        // WebXR AR System Variables
        let scene, camera, renderer, arSession;
        let currentTileGroup = null;
        let tileTextures = {};
        let arController = null;

        // AR System Initialization
        async function initARSystem() {
            try {
                // Check WebXR support
                if (!navigator.xr) {
                    console.log('WebXR not supported, falling back to camera-based AR');
                    return initCameraAR();
                }
                
                // Initialize Three.js scene
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                
                const canvas = document.getElementById('ar-canvas');
                renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.xr.enabled = true;
                
                // Load tile textures
                await loadTileTextures();
                
                // Set up AR environment
                setupAREnvironment();
                
                console.log('AR System initialized successfully');
                return true;
                
            } catch (error) {
                console.error('AR initialization failed:', error);
                return initCameraAR();
            }
        }

        // Fallback camera-based AR for non-WebXR devices
        async function initCameraAR() {
            try {
                const canvas = document.getElementById('ar-canvas');
                const ctx = canvas.getContext('2d');
                
                // Get camera stream
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                // Create video element for camera feed
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();
                
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    function drawFrame() {
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        // Add tile overlay (simplified for camera mode)
                        drawTileOverlay(ctx);
                        
                        requestAnimationFrame(drawFrame);
                    }
                    drawFrame();
                };
                
                console.log('Camera AR mode initialized');
                return true;
                
            } catch (error) {
                console.error('Camera AR failed:', error);
                alert('Camera access required for AR visualization. Please enable camera permissions.');
                return false;
            }
        }

        // Load tile textures for different materials
        async function loadTileTextures() {
            const loader = new THREE.TextureLoader();
            
            // Basic tile patterns (in production, these would be actual product images)
            tileTextures = {
                'ceramic': await loadTexture(loader, generateTileTexture('ceramic')),
                'porcelain': await loadTexture(loader, generateTileTexture('porcelain')),
                'natural-stone': await loadTexture(loader, generateTileTexture('natural-stone'))
            };
        }

        // Generate tile texture (placeholder - in production would load real images)
        function generateTileTexture(type) {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            
            // Different tile appearances
            const colors = {
                'ceramic': '#f0f0f0',
                'porcelain': '#e8e8e8',
                'natural-stone': '#d4c4a8'
            };
            
            ctx.fillStyle = colors[type] || '#f0f0f0';
            ctx.fillRect(0, 0, 256, 256);
            
            // Add tile pattern
            ctx.strokeStyle = '#cccccc';
            ctx.lineWidth = 2;
            ctx.strokeRect(4, 4, 248, 248);
            
            // Add texture variation for natural stone
            if (type === 'natural-stone') {
                for (let i = 0; i < 20; i++) {
                    ctx.fillStyle = `rgba(160, 140, 120, ${Math.random() * 0.3})`;
                    ctx.fillRect(
                        Math.random() * 256,
                        Math.random() * 256,
                        Math.random() * 50,
                        Math.random() * 50
                    );
                }
            }
            
            return canvas.toDataURL();
        }

        // Load texture helper
        function loadTexture(loader, dataUrl) {
            return new Promise((resolve) => {
                loader.load(dataUrl, resolve);
            });
        }

        // Set up AR environment with plane detection
        function setupAREnvironment() {
            // Add ambient light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            // Add directional light
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(0, 1, 1);
            scene.add(directionalLight);
            
            // Set up AR controller for hit testing
            arController = {
                hitTestResults: [],
                hitTestSource: null
            };
        }

        // Create tile grid on detected surface
        function createTileGrid(position, size = { width: 2, height: 2 }) {
            if (currentTileGroup) {
                scene.remove(currentTileGroup);
            }
            
            currentTileGroup = new THREE.Group();
            
            const tileSize = 0.3; // 30cm tiles
            const groutWidth = 0.005; // 5mm grout lines
            const totalTileSize = tileSize + groutWidth;
            
            const tilesX = Math.floor(size.width / totalTileSize);
            const tilesY = Math.floor(size.height / totalTileSize);
            
            // Create tile geometry
            const tileGeometry = new THREE.PlaneGeometry(tileSize, tileSize);
            
            // Get current tile material
            const tileType = getCurrentTileType();
            const tileMaterial = new THREE.MeshLambertMaterial({
                map: tileTextures[tileType] || tileTextures['ceramic'],
                transparent: true,
                opacity: 0.9
            });
            
            // Create tile grid
            for (let x = 0; x < tilesX; x++) {
                for (let y = 0; y < tilesY; y++) {
                    const tile = new THREE.Mesh(tileGeometry, tileMaterial);
                    
                    // Position tile
                    tile.position.set(
                        (x - tilesX/2) * totalTileSize,
                        0.001, // Slightly above surface
                        (y - tilesY/2) * totalTileSize
                    );
                    
                    tile.rotation.x = -Math.PI / 2; // Lay flat
                    currentTileGroup.add(tile);
                }
            }
            
            // Position group at hit location
            currentTileGroup.position.copy(position);
            scene.add(currentTileGroup);
        }

        // Get current tile type from UI
        function getCurrentTileType() {
            const buttons = document.querySelectorAll('[onclick^="switchTilePattern"]');
            for (let button of buttons) {
                if (button.classList.contains('bg-blue-600') || 
                    button.classList.contains('bg-green-600') || 
                    button.classList.contains('bg-amber-600')) {
                    return button.onclick.toString().match(/'([^']+)'/)[1];
                }
            }
            return 'ceramic';
        }

        // AR Interaction Functions
        async function startARVisualization() {
            const arContainer = document.getElementById('ar-container');
            arContainer.classList.remove('hidden');
            
            // Start camera immediately for AR view
            try {
                await initCameraAR();
                console.log('AR camera initialized successfully');
                
                // Add tile selection interface
                showTileSelectionInterface();
                
            } catch (error) {
                console.error('AR initialization failed:', error);
                alert('Camera access required for AR visualization. Please enable camera permissions and try again.');
                exitARVisualization();
                return;
            }
            
            // Start AR session
            try {
                if (navigator.xr && renderer.xr.enabled) {
                    arSession = await navigator.xr.requestSession('immersive-ar', {
                        requiredFeatures: ['hit-test'],
                        optionalFeatures: ['dom-overlay'],
                        domOverlay: { root: arContainer }
                    });
                    
                    renderer.xr.setSession(arSession);
                    
                    // Set up hit testing
                    const referenceSpace = await arSession.requestReferenceSpace('viewer');
                    arController.hitTestSource = await arSession.requestHitTestSource({ space: referenceSpace });
                    
                    // Start render loop
                    renderer.setAnimationLoop(renderAR);
                }
            } catch (error) {
                console.error('AR session failed:', error);
                // Continue with camera-based AR
            }
            
            // Add click/tap handler for placing tiles
            const canvas = document.getElementById('ar-canvas');
            canvas.addEventListener('click', onARClick);
        }

        // AR render loop
        function renderAR(timestamp, frame) {
            if (frame && arController.hitTestSource) {
                const hitTestResults = frame.getHitTestResults(arController.hitTestSource);
                arController.hitTestResults = hitTestResults;
                
                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    const pose = hit.getPose(renderer.xr.getReferenceSpace());
                    
                    // Update cursor or preview position
                    if (pose) {
                        // Show where tiles would be placed
                        updateARCursor(pose.transform.position);
                    }
                }
            }
            
            renderer.render(scene, camera);
        }

        // Handle AR click/tap
        function onARClick(event) {
            if (arController.hitTestResults.length > 0) {
                const hit = arController.hitTestResults[0];
                const pose = hit.getPose(renderer.xr.getReferenceSpace());
                
                if (pose) {
                    const position = new THREE.Vector3(
                        pose.transform.position.x,
                        pose.transform.position.y,
                        pose.transform.position.z
                    );
                    
                    // Get room dimensions from form data
                    const roomData = getRoomDimensions();
                    createTileGrid(position, roomData);
                    
                    // Send tile placement data to chat
                    sendARDataToChat(position, roomData);
                }
            }
        }

        // Get room dimensions from hybrid form
        function getRoomDimensions() {
            const length = parseFloat(document.getElementById('room-length')?.value) || 3;
            const width = parseFloat(document.getElementById('room-width')?.value) || 3;
            return { width: length, height: width };
        }

        // Send AR visualization data to chat
        function sendARDataToChat(position, roomData) {
            const tileType = getCurrentTileType();
            const tileSize = document.getElementById('ar-tile-size')?.value || '12x12';
            const pattern = document.getElementById('ar-pattern')?.value || 'straight';
            
            const message = `I'm visualizing ${tileType} tiles (${tileSize}) in a ${pattern} pattern for a ${roomData.width}√ó${roomData.height} space. The AR placement looks great!`;
            
            // Add structured context for the LLM
            const structuredData = {
                action: 'ar_visualization_placed',
                tile_type: tileType,
                tile_size: tileSize,
                pattern: pattern,
                room_dimensions: roomData,
                ar_position: position
            };
            
            // Send to chat system
            fetch('/api/chat/structured-context', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(structuredData)
            });
            
            // Add to chat UI
            addMessage(message, 'user');
        }

        // Update AR cursor/preview
        function updateARCursor(position) {
            // Update UI to show where tiles will be placed
            // This would add a preview cursor in the AR scene
        }

        // AR Control Functions
        function switchTilePattern(type) {
            // Update UI buttons
            document.querySelectorAll('[onclick^="switchTilePattern"]').forEach(btn => {
                btn.className = btn.className.replace(/bg-(blue|green|amber)-600/, 'bg-gray-400');
            });
            
            const clickedBtn = event.target.closest('button');
            if (type === 'ceramic') clickedBtn.className = clickedBtn.className.replace('bg-gray-400', 'bg-blue-600');
            if (type === 'porcelain') clickedBtn.className = clickedBtn.className.replace('bg-gray-400', 'bg-green-600');
            if (type === 'natural-stone') clickedBtn.className = clickedBtn.className.replace('bg-gray-400', 'bg-amber-600');
            
            // Update AR visualization
            if (currentTileGroup && tileTextures[type]) {
                currentTileGroup.children.forEach(tile => {
                    tile.material.map = tileTextures[type];
                    tile.material.needsUpdate = true;
                });
            }
        }

        function updateTileSize() {
            const size = document.getElementById('ar-tile-size').value;
            // Recreate tile grid with new size
            if (currentTileGroup) {
                const position = currentTileGroup.position.clone();
                const roomData = getRoomDimensions();
                createTileGrid(position, roomData);
            }
        }

        function updateTilePattern() {
            const pattern = document.getElementById('ar-pattern').value;
            // Update tile layout pattern
            if (currentTileGroup) {
                const position = currentTileGroup.position.clone();
                const roomData = getRoomDimensions();
                createTileGrid(position, roomData);
            }
        }

        function updateGroutColor() {
            const color = document.getElementById('ar-grout-color').value;
            // Update grout lines (would modify tile spacing/borders)
            console.log('Grout color updated to:', color);
        }

        function saveARView() {
            // Capture AR view and save to project data
            const tileData = {
                type: getCurrentTileType(),
                size: document.getElementById('ar-tile-size').value,
                pattern: document.getElementById('ar-pattern').value,
                grout_color: document.getElementById('ar-grout-color').value,
                room_dimensions: getRoomDimensions()
            };
            
            // Save to hybrid form data
            saveProjectVisualization(tileData);
            
            // Show confirmation
            alert('AR visualization saved to your project!');
        }

        function exitARVisualization() {
            const arContainer = document.getElementById('ar-container');
            arContainer.classList.add('hidden');
            
            // Stop AR session
            if (arSession) {
                arSession.end();
                arSession = null;
            }
            
            // Clean up
            if (renderer) {
                renderer.setAnimationLoop(null);
            }
            
            // Stop camera stream if using camera mode
            const canvas = document.getElementById('ar-canvas');
            const stream = canvas.srcObject;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }

        // Tile Selection Functions for AR
        let selectedTileForAR = null;
        
        function showTileSelector() {
            document.getElementById('ar-tile-selector').classList.remove('hidden');
        }
        
        function hideTileSelector() {
            document.getElementById('ar-tile-selector').classList.add('hidden');
        }
        
        async function searchTileForAR(searchType, query) {
            if (!query.trim()) {
                document.getElementById('ar-search-results').classList.add('hidden');
                return;
            }
            
            try {
                let searchQuery = '';
                if (searchType === 'sku') {
                    searchQuery = `sku:${query}`;
                } else if (searchType === 'color') {
                    searchQuery = `${query} color tile`;
                } else if (searchType === 'description') {
                    searchQuery = query;
                }
                
                // Use sample tiles for now (can be connected to real search later)
                displaySampleTileOptions(searchType, query);
                
            } catch (error) {
                console.error('Error searching tiles:', error);
                displaySampleTileOptions(searchType, query);
            }
        }
        
        function displaySampleTileOptions(searchType, query) {
            const sampleTiles = [
                { sku: 'MCF-001', name: 'Modern Ceramic Floor Tile', price: 4.99, image_url: '/static/placeholder-tile.jpg' },
                { sku: 'PPT-002', name: 'Premium Porcelain Tile', price: 7.50, image_url: '/static/placeholder-tile.jpg' },
                { sku: 'NSL-003', name: 'Natural Stone Look Tile', price: 6.25, image_url: '/static/placeholder-tile.jpg' },
                { sku: 'WST-004', name: 'White Subway Tile', price: 3.99, image_url: '/static/placeholder-tile.jpg' },
                { sku: 'GRT-005', name: 'Gray Textured Tile', price: 5.49, image_url: '/static/placeholder-tile.jpg' }
            ];
            
            // Filter based on search
            let filteredTiles = sampleTiles;
            if (searchType === 'sku' && query) {
                filteredTiles = sampleTiles.filter(tile => 
                    tile.sku.toLowerCase().includes(query.toLowerCase())
                );
            } else if (searchType === 'color' && query) {
                filteredTiles = sampleTiles.filter(tile => 
                    tile.name.toLowerCase().includes(query.toLowerCase())
                );
            } else if (searchType === 'description' && query) {
                filteredTiles = sampleTiles.filter(tile => 
                    tile.name.toLowerCase().includes(query.toLowerCase())
                );
            }
            
            displayTileOptions(filteredTiles);
        }
        
        function displayTileOptions(tiles) {
            const resultsDiv = document.getElementById('ar-search-results');
            const optionsDiv = document.getElementById('ar-tile-options');
            
            if (tiles.length === 0) {
                resultsDiv.classList.add('hidden');
                return;
            }
            
            optionsDiv.innerHTML = '';
            tiles.forEach((tile, index) => {
                const tileOption = document.createElement('div');
                tileOption.className = 'p-2 border rounded cursor-pointer hover:bg-blue-50';
                tileOption.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-medium">${tile.name}</div>
                            <div class="text-sm text-gray-600">SKU: ${tile.sku} | $${tile.price}/sq ft</div>
                        </div>
                        <button onclick="selectTileForAR('${tile.sku}', '${tile.name}', '${tile.image_url}')" 
                                class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                            Select
                        </button>
                    </div>
                `;
                optionsDiv.appendChild(tileOption);
            });
            
            resultsDiv.classList.remove('hidden');
        }
        
        function selectTileForAR(sku, name, imageUrl) {
            selectedTileForAR = { sku, name, imageUrl };
            
            // Update UI to show selection
            const optionsDiv = document.getElementById('ar-tile-options');
            optionsDiv.querySelectorAll('.bg-green-50').forEach(el => el.classList.remove('bg-green-50'));
            
            // Highlight selected tile
            event.target.closest('.p-2').classList.add('bg-green-50');
            
            console.log('Selected tile for AR:', selectedTileForAR);
        }
        
        function applySelectedTileToAR() {
            if (!selectedTileForAR) {
                alert('Please select a tile first');
                return;
            }
            
            // Apply the selected tile to the AR scene
            console.log('Applying tile to AR:', selectedTileForAR);
            
            // Update tile pattern based on selection
            updateARTilePattern(selectedTileForAR);
            
            // Hide selector
            hideTileSelector();
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'absolute top-32 left-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded';
            successMsg.innerHTML = `
                <strong>Success!</strong> Applied ${selectedTileForAR.name} (${selectedTileForAR.sku}) to AR view.
                <button onclick="this.parentElement.remove()" class="float-right text-green-900">&times;</button>
            `;
            document.getElementById('ar-container').appendChild(successMsg);
            
            setTimeout(() => {
                if (successMsg.parentElement) {
                    successMsg.remove();
                }
            }, 5000);
        }
        
        function updateARTilePattern(tile) {
            // Update the AR visualization with the selected tile
            console.log('Updating AR pattern with:', tile);
            
            // Determine pattern type based on tile name
            let pattern = 'ceramic'; // default
            if (tile.name.toLowerCase().includes('porcelain')) {
                pattern = 'porcelain';
            } else if (tile.name.toLowerCase().includes('stone')) {
                pattern = 'natural-stone';
            }
            
            switchTilePattern(pattern);
        }
        
        function showTileSelectionInterface() {
            // Auto-show the tile selector when AR starts
            setTimeout(() => {
                showTileSelector();
            }, 1000);
        }

        // Helper function for camera-based tile overlay
        function drawTileOverlay(ctx) {
            const centerX = ctx.canvas.width / 2;
            const centerY = ctx.canvas.height / 2;
            const tileSize = 80;
            const tilesX = 4;
            const tilesY = 3;
            
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            
            for (let x = 0; x < tilesX; x++) {
                for (let y = 0; y < tilesY; y++) {
                    const tileX = centerX - (tilesX * tileSize / 2) + (x * tileSize);
                    const tileY = centerY - (tilesY * tileSize / 2) + (y * tileSize);
                    
                    ctx.fillRect(tileX, tileY, tileSize - 2, tileSize - 2);
                    ctx.strokeRect(tileX, tileY, tileSize - 2, tileSize - 2);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Enter key support
            document.getElementById('chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;

            const customerName = document.getElementById('customer-name').value.trim();
            const customerPhone = document.getElementById('customer-phone').value.trim();

            // Add user message to chat
            addMessage(message, 'user');
            input.value = '';

            // Show typing indicator
            showTypingIndicator(true);

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: message,
                        conversation_history: conversation_history,
                        customer_name: customerName,
                        customer_phone: customerPhone
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Add assistant response
                    addMessage(data.response, 'assistant');
                    
                    // Update AOS tracking
                    updateAOSStatus(data.aos_phase, data.requirements_complete);
                    
                    // Update NEPQ scoring if available
                    if (data.nepq_analysis) {
                        updateNEPQScoring(data.nepq_analysis);
                    }
                    
                    // Check for vision suggestions in LLM response
                    checkForVisionSuggestion(data.response);
                    
                    // Update conversation history
                    conversation_history.push(
                        { role: 'user', content: message },
                        { role: 'assistant', content: data.response }
                    );
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('Sorry, I encountered a connection error. Please try again.', 'assistant');
            }

            showTypingIndicator(false);
        }

        function addMessage(content, role) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            messageDiv.innerHTML = `
                <div class="message-bubble ${role}">
                    <p>${content}</p>
                    <p class="text-xs ${role === 'user' ? 'text-blue-100' : 'text-gray-500'} mt-2">
                        ${new Date().toLocaleTimeString()}
                    </p>
                </div>
            `;
            
            messagesContainer.querySelector('.space-y-4').appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator(show) {
            const indicator = document.getElementById('typing-indicator');
            if (show) {
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }

        function updateAOSStatus(phase, requirementsComplete) {
            // Update phase indicator
            document.getElementById('aos-phase').textContent = phase || 'Discovery';
            
            // Update requirements status
            const requirementsStatus = document.getElementById('requirements-status');
            if (requirementsComplete) {
                requirementsStatus.textContent = 'Complete ‚úì';
                requirementsStatus.className = 'text-green-600 font-medium';
            } else {
                requirementsStatus.textContent = 'Collecting...';
                requirementsStatus.className = 'text-gray-500';
            }
            
            // Update step indicators (simplified)
            const steps = ['greeting', 'needs', 'design', 'close'];
            const currentStepIndex = steps.indexOf(phase?.toLowerCase()) || 0;
            
            steps.forEach((step, index) => {
                const element = document.getElementById(`step-${step}`);
                if (index <= currentStepIndex) {
                    element.className = 'aos-step text-green-600 font-medium';
                } else {
                    element.className = 'aos-step text-gray-400';
                }
            });
        }

        function updateNEPQScoring(nepqAnalysis) {
            // Show NEPQ tracker
            const tracker = document.getElementById('nepq-tracker');
            tracker.style.display = 'block';
            
            // Update overall score and grade
            document.getElementById('nepq-overall-score').textContent = `${Math.round(nepqAnalysis.overall_score || 0)}/100`;
            document.getElementById('nepq-grade').textContent = nepqAnalysis.performance_grade || '--';
            
            // Update stage scores
            const stageScores = nepqAnalysis.stage_scores || {};
            document.getElementById('nepq-connection').textContent = `${stageScores.connection || 0}/10`;
            document.getElementById('nepq-problem-awareness').textContent = `${stageScores.problem_awareness || 0}/10`;
            document.getElementById('nepq-consequence').textContent = `${stageScores.consequence_discovery || 0}/10`;
            document.getElementById('nepq-solution').textContent = `${stageScores.solution_awareness || 0}/10`;
            document.getElementById('nepq-qualifying').textContent = `${stageScores.qualifying_questions || 0}/10`;
            document.getElementById('nepq-objections').textContent = `${stageScores.objection_handling || 0}/10`;
            document.getElementById('nepq-commitment').textContent = `${stageScores.commitment_stage || 0}/10`;
            
            // Update metrics
            const metrics = nepqAnalysis.metrics || {};
            document.getElementById('nepq-questions').textContent = metrics.questions_asked || 0;
            document.getElementById('nepq-objections-count').textContent = metrics.objections_encountered || 0;
            
            // Update improvement focus
            const improvementFocus = nepqAnalysis.improvement_focus || [];
            if (improvementFocus.length > 0) {
                document.getElementById('nepq-improvements').style.display = 'block';
                document.getElementById('nepq-focus-areas').textContent = improvementFocus.join(', ');
            }
            
            // Color code the overall score
            const overallScoreElement = document.getElementById('nepq-overall-score');
            const score = nepqAnalysis.overall_score || 0;
            if (score >= 80) {
                overallScoreElement.className = 'bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium';
            } else if (score >= 60) {
                overallScoreElement.className = 'bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium';
            } else {
                overallScoreElement.className = 'bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium';
            }
        }

        function toggleNEPQDetails() {
            const details = document.getElementById('nepq-details');
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
            } else {
                details.classList.add('hidden');
            }
        }

        // Tile Vision Scanner Functions
        let cameraStream = null;
        let capturedImageData = null;
        let currentVisionMode = 'similarity'; // 'similarity' or 'store'

        function toggleVisionScanner() {
            const modeSelector = document.getElementById('vision-mode-selector');
            const toggleBtn = document.getElementById('vision-toggle-btn');
            
            if (modeSelector.classList.contains('hidden')) {
                // Show mode selection
                modeSelector.classList.remove('hidden');
                toggleBtn.innerHTML = '<i class="fas fa-times mr-2"></i>Close Scanner';
                toggleBtn.className = toggleBtn.className.replace('bg-purple-600', 'bg-red-600').replace('hover:bg-purple-700', 'hover:bg-red-700');
            } else {
                // Close everything
                closeVisionSystem();
            }
        }

        function selectVisionMode(mode) {
            currentVisionMode = mode;
            
            // Hide mode selector, show scanner
            document.getElementById('vision-mode-selector').classList.add('hidden');
            document.getElementById('vision-scanner').classList.remove('hidden');
            
            // Update UI based on mode
            const modeTitle = document.getElementById('vision-mode-title');
            const modeBadge = document.getElementById('vision-mode-badge');
            
            if (mode === 'similarity') {
                modeTitle.textContent = 'Find Similar Tiles';
                modeBadge.textContent = 'üîç Similarity Mode';
                modeBadge.className = 'text-sm text-blue-600 font-medium';
            } else if (mode === 'store') {
                modeTitle.textContent = 'Find in Store';
                modeBadge.textContent = 'üìç Store Location Mode';
                modeBadge.className = 'text-sm text-green-600 font-medium';
            }
        }

        function closeVisionSystem() {
            // Hide all vision components
            document.getElementById('vision-mode-selector').classList.add('hidden');
            document.getElementById('vision-scanner').classList.add('hidden');
            
            // Reset toggle button
            const toggleBtn = document.getElementById('vision-toggle-btn');
            toggleBtn.innerHTML = '<i class="fas fa-camera mr-2"></i>Scan Tile';
            toggleBtn.className = toggleBtn.className.replace('bg-red-600', 'bg-purple-600').replace('hover:bg-red-700', 'hover:bg-purple-700');
            
            // Stop camera
            stopCamera();
        }

        async function startCamera() {
            try {
                const video = document.getElementById('camera-video');
                const startBtn = document.getElementById('start-camera-btn');
                const captureBtn = document.getElementById('capture-btn');
                const stopBtn = document.getElementById('stop-camera-btn');

                // Request camera access with higher quality
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1920, min: 1280 },
                        height: { ideal: 1080, min: 720 },
                        facingMode: 'environment', // Use back camera on mobile
                        focusMode: 'continuous', // Enable autofocus
                        exposureMode: 'continuous' // Auto exposure for better lighting
                    } 
                });

                video.srcObject = cameraStream;
                video.classList.remove('hidden');
                
                // Update button visibility
                startBtn.classList.add('hidden');
                captureBtn.classList.remove('hidden');
                stopBtn.classList.remove('hidden');

                console.log('Camera started successfully');
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Could not access camera. Please check permissions and try again.');
            }
        }

        function captureImage() {
            try {
                const video = document.getElementById('camera-video');
                const canvas = document.getElementById('capture-canvas');
                const ctx = canvas.getContext('2d');
                const capturedImg = document.getElementById('captured-image');
                const preview = document.getElementById('captured-preview');

                // Draw video frame to canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Get image data as base64
                capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
                
                // Show preview
                capturedImg.src = capturedImageData;
                preview.classList.remove('hidden');
                video.classList.add('hidden');

                // Update buttons
                document.getElementById('capture-btn').classList.add('hidden');
                document.getElementById('analyze-tile-btn').classList.remove('hidden');
                document.getElementById('retake-btn').classList.remove('hidden');
                
                console.log('Image captured successfully');
                
            } catch (error) {
                console.error('Error capturing image:', error);
                alert('Error capturing image. Please try again.');
            }
        }

        function retakePhoto() {
            const video = document.getElementById('camera-video');
            const preview = document.getElementById('captured-preview');
            const captureBtn = document.getElementById('capture-btn');
            const results = document.getElementById('vision-results');

            // Hide preview and results
            preview.classList.add('hidden');
            results.classList.add('hidden');
            
            // Show video and capture button
            video.classList.remove('hidden');
            captureBtn.classList.remove('hidden');
            
            // Hide analyze and retake buttons
            document.getElementById('analyze-tile-btn').classList.add('hidden');
            document.getElementById('retake-btn').classList.add('hidden');
            
            capturedImageData = null;
        }

        async function analyzeCapturedTile() {
            if (!capturedImageData) {
                alert('No image captured. Please capture a tile image first.');
                return;
            }

            try {
                // Show loading state
                const analyzeBtn = document.getElementById('analyze-tile-btn');
                const originalText = analyzeBtn.innerHTML;
                analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...';
                analyzeBtn.disabled = true;

                // Call the vision API
                const response = await fetch('/api/vision/analyze-tile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: capturedImageData
                    })
                });

                const result = await response.json();

                // Restore button
                analyzeBtn.innerHTML = originalText;
                analyzeBtn.disabled = false;

                if (result.success) {
                    // Display results
                    displayTileAnalysisResults(result);
                    
                    // Add analysis to chat
                    const message = `${result.message || 'I analyzed your tile image and found some great matches!'}`;
                    addMessage(message, 'assistant');
                    
                    // Hide buttons after successful analysis
                    document.getElementById('analyze-tile-btn').classList.add('hidden');
                } else {
                    alert(`Analysis failed: ${result.error}`);
                }

            } catch (error) {
                console.error('Error analyzing tile:', error);
                alert('Error analyzing tile. Please try again.');
                
                // Restore button
                const analyzeBtn = document.getElementById('analyze-tile-btn');
                analyzeBtn.innerHTML = '<i class="fas fa-search mr-2"></i>Analyze Tile';
                analyzeBtn.disabled = false;
            }
        }

        function displayTileAnalysisResults(result) {
            const resultsDiv = document.getElementById('vision-results');
            const matchesDiv = document.getElementById('tile-matches');
            
            resultsDiv.classList.remove('hidden');
            
            // Show AI description if available
            let resultsHtml = '';
            if (result.description) {
                resultsHtml += `
                    <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <h4 class="font-bold text-blue-800 mb-2">AI Analysis:</h4>
                        <p class="text-blue-700">${result.description}</p>
                    </div>
                `;
            }
            
            // Show tile matches
            if (result.matches && result.matches.length > 0) {
                resultsHtml += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                
                result.matches.forEach((match, index) => {
                    const confidenceColor = match.confidence > 0.8 ? 'text-green-600' : 
                                          match.confidence > 0.6 ? 'text-yellow-600' : 'text-red-600';
                    
                    resultsHtml += `
                        <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-semibold text-gray-800">${match.name}</h3>
                                <span class="text-sm ${confidenceColor}">${Math.round(match.confidence * 100)}% match</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-2">SKU: ${match.sku}</p>
                            <p class="text-gray-600 text-sm mb-2">${match.description}</p>
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-green-600">$${match.price}/sq ft</span>
                                <span class="text-sm text-blue-600">${match.location}</span>
                            </div>
                        </div>
                    `;
                });
                
                resultsHtml += '</div>';
            } else {
                resultsHtml += '<p class="text-gray-600">No similar tiles found in our inventory.</p>';
            }
            
            matchesDiv.innerHTML = resultsHtml;
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            // Reset UI
            const video = document.getElementById('camera-video');
            const preview = document.getElementById('captured-preview');
            const results = document.getElementById('vision-results');
            
            video.classList.add('hidden');
            preview.classList.add('hidden');
            results.classList.add('hidden');
            
            // Reset buttons
            document.getElementById('start-camera-btn').classList.remove('hidden');
            document.getElementById('capture-btn').classList.add('hidden');
            document.getElementById('stop-camera-btn').classList.add('hidden');
            
            capturedImageData = null;
            console.log('Camera stopped');
        }

        async function analyzeCapturedTile() {
            if (!capturedImageData) {
                alert('No image captured. Please capture an image first.');
                return;
            }

            try {
                // Show loading state
                const resultsDiv = document.getElementById('vision-results');
                const matchesDiv = document.getElementById('tile-matches');
                
                resultsDiv.classList.remove('hidden');
                
                if (currentVisionMode === 'similarity') {
                    matchesDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Finding similar tiles...</div>';
                } else {
                    matchesDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Locating tile in store...</div>';
                }

                // Choose API endpoint based on mode
                const apiEndpoint = currentVisionMode === 'similarity' ? '/api/vision/analyze-tile' : '/api/vision/find-in-store';
                
                // Send image to vision API
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: capturedImageData
                    })
                });

                const result = await response.json();

                if (currentVisionMode === 'similarity') {
                    handleSimilarityResults(result, matchesDiv);
                } else {
                    handleStoreLocationResults(result, matchesDiv);
                }

            } catch (error) {
                console.error('Error analyzing tile:', error);
                document.getElementById('tile-matches').innerHTML = `
                    <div class="text-center text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Error analyzing tile. Please try again.</p>
                    </div>
                `;
            }
        }

        function handleSimilarityResults(result, matchesDiv) {
            if (result.success && result.matches && result.matches.length > 0) {
                // Display similarity matches
                let matchesHtml = '';
                
                result.matches.forEach((match, index) => {
                    const confidenceColor = match.confidence === 'High' ? 'text-green-600' : 
                                          match.confidence === 'Medium' ? 'text-yellow-600' : 'text-red-600';
                    
                    matchesHtml += `
                        <div class="border-l-4 border-blue-400 pl-4 py-2 mb-3 bg-gray-50 rounded">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h5 class="font-medium text-gray-900">${match.name}</h5>
                                    <p class="text-sm text-gray-600">SKU: ${match.sku}</p>
                                    <p class="text-sm text-gray-600">Category: ${match.category}</p>
                                    <p class="text-sm ${confidenceColor} font-medium">${match.confidence} Confidence (${match.similarity}%)</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-lg text-blue-600">$${match.price}</p>
                                    <button class="mt-1 bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded" 
                                            onclick="selectTileMatch('${match.sku}', '${match.name}', 'similarity')">
                                        Select This Tile
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                matchesDiv.innerHTML = matchesHtml;
                
            } else {
                matchesDiv.innerHTML = `
                    <div class="text-center text-gray-600">
                        <i class="fas fa-search-minus text-2xl mb-2"></i>
                        <p>No similar tiles found in our database.</p>
                        <p class="text-sm">Try a different angle or lighting.</p>
                    </div>
                `;
            }
        }

        function handleStoreLocationResults(result, matchesDiv) {
            if (result.success) {
                const tile = result.tile_identification;
                const location = result.store_location;
                const inventory = result.inventory;
                const storeInfo = result.store_info;
                
                const availabilityColor = inventory.availability_color === 'green' ? 'text-green-600' :
                                        inventory.availability_color === 'yellow' ? 'text-yellow-600' :
                                        inventory.availability_color === 'orange' ? 'text-orange-600' : 'text-red-600';
                
                matchesDiv.innerHTML = `
                    <div class="bg-white rounded-lg p-4 border-2 border-green-400">
                        <!-- Tile Identification -->
                        <div class="border-b pb-3 mb-3">
                            <h5 class="font-bold text-lg text-gray-900">${tile.name}</h5>
                            <p class="text-sm text-gray-600">SKU: ${tile.sku}</p>
                            <p class="text-sm text-blue-600">Identified with ${tile.confidence} confidence</p>
                        </div>
                        
                        <!-- Store Location -->
                        <div class="border-b pb-3 mb-3">
                            <h6 class="font-medium text-gray-800 mb-2">üìç Store Location:</h6>
                            <div class="bg-blue-50 p-3 rounded">
                                <p class="font-medium">Aisle ${location.aisle}, Bay ${location.bay}, Shelf ${location.shelf}</p>
                                ${location.display_board ? `<p class="text-sm text-blue-600">Display Board: ${location.display_board}</p>` : ''}
                                <p class="text-sm text-gray-600 mt-1">${storeInfo.department}</p>
                                <p class="text-xs text-gray-500">${storeInfo.category_description}</p>
                            </div>
                        </div>
                        
                        <!-- Inventory -->
                        <div class="mb-3">
                            <h6 class="font-medium text-gray-800 mb-2">üì¶ Inventory:</h6>
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-medium ${availabilityColor}">${inventory.availability}</p>
                                    <p class="text-sm text-gray-600">Quantity: ${inventory.quantity} units</p>
                                    <p class="text-xs text-gray-500">Last updated: ${inventory.last_updated}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex space-x-2 pt-3 border-t">
                            <button class="bg-green-600 hover:bg-green-700 text-white text-sm px-4 py-2 rounded flex-1" 
                                    onclick="selectTileMatch('${tile.sku}', '${tile.name}', 'store')">
                                <i class="fas fa-map-marker-alt mr-1"></i>Get Directions
                            </button>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded flex-1" 
                                    onclick="selectTileMatch('${tile.sku}', '${tile.name}', 'info')">
                                <i class="fas fa-info-circle mr-1"></i>Product Info
                            </button>
                        </div>
                    </div>
                `;
                
            } else {
                matchesDiv.innerHTML = `
                    <div class="text-center text-gray-600">
                        <i class="fas fa-search-minus text-2xl mb-2"></i>
                        <p>Could not locate this tile in our store.</p>
                        <p class="text-sm">${result.message || 'Try a different angle or lighting.'}</p>
                    </div>
                `;
            }
        }

        function selectTileMatch(sku, name, action) {
            let message = '';
            
            if (action === 'similarity') {
                message = `I found this tile: ${name} (SKU: ${sku}). Can you show me similar options and help me with pricing?`;
            } else if (action === 'store') {
                message = `I need directions to find ${name} (SKU: ${sku}) in your store. Can you guide me to Aisle location?`;
            } else if (action === 'info') {
                message = `I'm interested in ${name} (SKU: ${sku}). Can you tell me more about this tile and help me calculate what I need?`;
            } else {
                message = `I found this tile: ${name} (SKU: ${sku}). Can you help me with this product?`;
            }
            
            // Add to chat input
            document.getElementById('chat-input').value = message;
            
            // Close vision scanner
            closeVisionSystem();
            
            // Auto-send the message
            sendMessage();
        }

        function checkForVisionSuggestion(response) {
            // Check if LLM suggests using camera
            const visionTriggers = [
                'scan that tile with your camera',
                'camera scanning',
                'would you like to scan',
                'I can help you scan',
                'use the camera to identify'
            ];
            
            const responseLower = response.toLowerCase();
            const shouldSuggestVision = visionTriggers.some(trigger => responseLower.includes(trigger));
            
            if (shouldSuggestVision) {
                // Add visual suggestion prompt
                setTimeout(() => {
                    addVisionSuggestionPrompt();
                }, 1000);
            }
        }

        function addVisionSuggestionPrompt() {
            const messagesContainer = document.getElementById('chat-messages');
            const suggestionDiv = document.createElement('div');
            suggestionDiv.className = 'flex justify-center my-4';
            
            suggestionDiv.innerHTML = `
                <div class="bg-purple-100 border border-purple-300 rounded-lg p-4 max-w-md text-center">
                    <div class="text-purple-800 font-medium mb-2">
                        <i class="fas fa-camera mr-2"></i>Ready to scan your tile?
                    </div>
                    <div class="space-x-2">
                        <button class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-sm" 
                                onclick="toggleVisionScanner(); this.parentElement.parentElement.parentElement.remove();">
                            <i class="fas fa-camera mr-1"></i>Start Scanning
                        </button>
                        <button class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm" 
                                onclick="this.parentElement.parentElement.parentElement.remove();">
                            <i class="fas fa-times mr-1"></i>Not Now
                        </button>
                    </div>
                </div>
            `;
            
            messagesContainer.querySelector('.space-y-4').appendChild(suggestionDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Hybrid Form/LLM Structured Data Functions
        let structuredProjectData = {
            projectName: '',
            customerName: '',
            roomType: '',
            roomLength: 0,
            roomWidth: 0,
            dimensionUnit: 'feet',
            totalArea: 0,
            surfaces: [],
            totalCost: 0,
            lastUpdated: null
        };
        let currentSurfaceId = null;

        function toggleProjectOrganizer() {
            const organizer = document.getElementById('project-organizer');
            if (organizer.style.display === 'none') {
                organizer.style.display = 'block';
                // Send LLM context about opening structured data panel
                notifyLLMAboutStructuredData('opened_panel');
            } else {
                organizer.style.display = 'none';
            }
        }

        function updateProjectData() {
            structuredProjectData.projectName = document.getElementById('project-name').value;
            structuredProjectData.customerName = document.getElementById('customer-name').value;
            structuredProjectData.roomType = document.getElementById('room-type').value;
            structuredProjectData.lastUpdated = new Date();
            
            // Trigger LLM acknowledgment if significant data entered
            if (structuredProjectData.projectName && structuredProjectData.roomType) {
                notifyLLMAboutStructuredData('project_details_updated');
            }
            
            // Auto-send to backend for persistence
            saveStructuredProjectData();
        }

        function calculateRoomArea() {
            const length = parseFloat(document.getElementById('room-length').value) || 0;
            const width = parseFloat(document.getElementById('room-width').value) || 0;
            const unit = document.getElementById('dimension-unit').value;
            
            structuredProjectData.roomLength = length;
            structuredProjectData.roomWidth = width;
            structuredProjectData.dimensionUnit = unit;
            
            // Calculate area in square feet
            let areaInSqFt = length * width;
            if (unit === 'meters') {
                areaInSqFt = areaInSqFt * 10.764; // Convert sq meters to sq feet
            }
            
            structuredProjectData.totalArea = areaInSqFt;
            
            // Update display
            const displayUnit = unit === 'feet' ? 'sq ft' : 'sq ft (converted from sq m)';
            document.getElementById('calculated-area').textContent = `= ${areaInSqFt.toFixed(1)} ${displayUnit}`;
            
            // Trigger LLM acknowledgment if meaningful dimensions
            if (length > 0 && width > 0) {
                notifyLLMAboutStructuredData('dimensions_entered');
            }
            
            updateProjectSummary();
            saveStructuredProjectData();
        }

        function addSurfaceToProject() {
            const roomType = structuredProjectData.roomType;
            if (!roomType) {
                alert('Please select a room type first.');
                return;
            }
            
            // Open surface selection modal with context
            currentSurfaceId = 'surface-' + Date.now();
            document.getElementById('current-area-name').textContent = `${structuredProjectData.projectName || 'your project'}`;
            document.getElementById('surface-modal').classList.remove('hidden');
        }

        function notifyLLMAboutStructuredData(action) {
            // Send context to LLM about structured data changes
            let contextMessage = '';
            
            switch(action) {
                case 'opened_panel':
                    contextMessage = `Customer opened the structured data panel. Current project: ${structuredProjectData.projectName || 'Untitled'}, Room: ${structuredProjectData.roomType || 'Not selected'}, Area: ${structuredProjectData.totalArea.toFixed(1)} sq ft`;
                    break;
                case 'project_details_updated':
                    contextMessage = `Customer updated project details - Name: "${structuredProjectData.projectName}", Room Type: "${structuredProjectData.roomType}"`;
                    break;
                case 'dimensions_entered':
                    contextMessage = `Customer entered room dimensions: ${structuredProjectData.roomLength} √ó ${structuredProjectData.roomWidth} ${structuredProjectData.dimensionUnit} (${structuredProjectData.totalArea.toFixed(1)} sq ft total)`;
                    break;
                case 'surface_added':
                    contextMessage = `Customer added a new surface to their project. Current surfaces: ${structuredProjectData.surfaces.length}`;
                    break;
            }
            
            if (contextMessage) {
                // Add system message to chat for LLM context
                addSystemContextMessage(contextMessage);
                
                // Trigger LLM response acknowledging the structured data
                sendStructuredDataUpdate(action);
            }
        }

        function addSystemContextMessage(message) {
            // Add invisible context message for LLM (not displayed to user)
            const messagesContainer = document.getElementById('chat-messages');
            const contextDiv = document.createElement('div');
            contextDiv.className = 'hidden';
            contextDiv.setAttribute('data-context', 'structured-data');
            contextDiv.textContent = `[SYSTEM CONTEXT] ${message}`;
            messagesContainer.appendChild(contextDiv);
        }

        function sendStructuredDataUpdate(action) {
            // Send AJAX request to update LLM with structured data context
            fetch('/api/chat/structured-context', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: action,
                    projectData: structuredProjectData,
                    phone: window.customerPhone || 'unknown'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.llm_response) {
                    // Add LLM acknowledgment to chat
                    addMessageToChat(data.llm_response, 'assistant');
                }
            })
            .catch(error => {
                console.error('Error updating structured context:', error);
            });
        }

        function saveStructuredProjectData() {
            // Save to backend database
            fetch('/api/project/structured-save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    phone: window.customerPhone || 'unknown',
                    projectData: structuredProjectData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Project data saved successfully');
                }
            })
            .catch(error => {
                console.error('Error saving project data:', error);
            });
        }

        // DALL-E 3 Room Design Generation Functions
        let currentDesignData = null;

        function generateRoomDesign() {
            // Check if we have project data with tiles
            if (!structuredProjectData.surfaces || structuredProjectData.surfaces.length === 0) {
                alert('Please add surfaces and select tiles before generating a design.');
                return;
            }
            
            // Check if tiles are selected
            const surfacesWithTiles = structuredProjectData.surfaces.filter(s => s.selectedTile);
            if (surfacesWithTiles.length === 0) {
                alert('Please scan and select tiles for your surfaces before generating a design.');
                return;
            }
            
            // Show loading state
            document.getElementById('design-loading').classList.remove('hidden');
            document.getElementById('design-preview').classList.add('hidden');
            document.getElementById('generate-design-btn').disabled = true;
            
            const designData = {
                roomType: structuredProjectData.roomType,
                dimensions: {
                    length: structuredProjectData.roomLength,
                    width: structuredProjectData.roomWidth,
                    unit: structuredProjectData.dimensionUnit
                },
                surfaces: surfacesWithTiles,
                stylePreference: document.getElementById('design-style').value
            };
            
            // Call DALL-E 3 API
            fetch('/api/design/generate-room-layout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(designData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayGeneratedDesign(data);
                    
                    // Add LLM message about the generated design
                    const designMessage = `I've generated a ${data.room_info.style} ${data.room_info.type} design for you! The AI visualization shows your selected tiles in a photorealistic room layout. Take a look at how your tiles will look together in the space.`;
                    addMessage(designMessage, 'assistant');
                } else {
                    alert(`Failed to generate design: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error generating design:', error);
                alert('Error generating design. Please try again.');
            })
            .finally(() => {
                document.getElementById('design-loading').classList.add('hidden');
                document.getElementById('generate-design-btn').disabled = false;
            });
        }

        function displayGeneratedDesign(designData) {
            currentDesignData = designData;
            
            // Show the design image
            document.getElementById('generated-design-image').src = designData.design_url;
            
            // Fill in room specifications
            const roomSpecs = document.getElementById('room-specs');
            roomSpecs.innerHTML = `
                <div><strong>Room:</strong> ${designData.room_info.type}</div>
                <div><strong>Style:</strong> ${designData.room_info.style}</div>
                <div><strong>Size:</strong> ${designData.room_info.dimensions.length || 0} √ó ${designData.room_info.dimensions.width || 0} ${designData.room_info.dimensions.unit || 'feet'}</div>
                <div><strong>Surfaces:</strong> ${designData.room_info.total_surfaces} areas tiled</div>
            `;
            
            // Fill in tiles used
            const tilesUsed = document.getElementById('tiles-used');
            const tilesList = designData.tile_details.map(tile => 
                `<div class="mb-1">
                    <strong>${tile.surface}:</strong> ${tile.tile_name} (${tile.sku})
                    <br><span class="text-xs">$${tile.price}/sq ft ‚Ä¢ ${tile.area.toFixed(1)} sq ft</span>
                </div>`
            ).join('');
            tilesUsed.innerHTML = tilesList;
            
            // Show the design preview
            document.getElementById('design-preview').classList.remove('hidden');
        }

        function regenerateDesign() {
            // Change style and regenerate
            const currentStyle = document.getElementById('design-style').value;
            const styles = ['modern', 'traditional', 'transitional', 'industrial', 'farmhouse'];
            const currentIndex = styles.indexOf(currentStyle);
            const nextIndex = (currentIndex + 1) % styles.length;
            document.getElementById('design-style').value = styles[nextIndex];
            
            generateRoomDesign();
        }

        function saveDesignToProject() {
            if (!currentDesignData) return;
            
            // Save design to project data
            structuredProjectData.generatedDesign = {
                imageUrl: currentDesignData.design_url,
                style: currentDesignData.room_info.style,
                generatedAt: currentDesignData.generated_at,
                tileDetails: currentDesignData.tile_details
            };
            
            saveStructuredProjectData();
            
            // Show success message
            const successMsg = "Design saved to your project! I can reference this design in our conversation and help you with next steps.";
            addMessage(successMsg, 'assistant');
        }

        function shareDesign() {
            if (!currentDesignData) return;
            
            // Create shareable summary
            const designSummary = `Check out my AI-generated ${currentDesignData.room_info.style} ${currentDesignData.room_info.type} design! Created with DALL-E 3 using actual tile selections from The Tile Shop.`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'My Tile Design',
                    text: designSummary,
                    url: currentDesignData.design_url
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(`${designSummary}\nDesign: ${currentDesignData.design_url}`);
                alert('Design details copied to clipboard!');
            }
        }

        function updateProjectSummary() {
            // ... existing updateProjectSummary code ...
            
            // Show design generation section if we have surfaces with tiles
            const surfacesWithTiles = structuredProjectData.surfaces.filter(s => s.selectedTile);
            const designSection = document.getElementById('design-generation-section');
            
            if (surfacesWithTiles.length > 0 && structuredProjectData.roomType) {
                designSection.style.display = 'block';
            } else {
                designSection.style.display = 'none';
            }
        }

        function addNewArea() {
            const areaName = prompt('Enter area name (e.g., "Master Bathroom", "Kitchen", "Living Room"):');
            if (!areaName) return;

            const areaId = 'area-' + Date.now();
            const newArea = {
                id: areaId,
                name: areaName,
                surfaces: [],
                totalCost: 0
            };

            projectData.areas.push(newArea);
            renderProjectArea(newArea);
            updateProjectSummary();
        }

        function renderProjectArea(area) {
            const areasContainer = document.getElementById('project-areas');
            const areaDiv = document.createElement('div');
            areaDiv.id = area.id;
            areaDiv.className = 'bg-white rounded-lg border border-blue-200 p-4';
            
            areaDiv.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-medium text-blue-800">${area.name}</h4>
                    <div class="flex space-x-2">
                        <button class="text-green-600 hover:text-green-800 text-sm" onclick="addSurface('${area.id}')">
                            <i class="fas fa-plus mr-1"></i>Add Surface
                        </button>
                        <button class="text-red-600 hover:text-red-800 text-sm" onclick="removeArea('${area.id}')">
                            <i class="fas fa-trash mr-1"></i>Remove
                        </button>
                    </div>
                </div>
                <div class="space-y-2" id="${area.id}-surfaces">
                    ${area.surfaces.length === 0 ? '<p class="text-gray-500 text-sm italic">No surfaces added yet. Click "Add Surface" to get started.</p>' : ''}
                </div>
                <div class="mt-3 pt-3 border-t border-blue-100">
                    <div class="flex justify-between text-sm">
                        <span class="text-blue-600">Area Total:</span>
                        <span class="font-medium text-blue-800" id="${area.id}-total">$0.00</span>
                    </div>
                </div>
            `;
            
            areasContainer.appendChild(areaDiv);
        }

        function addSurface(areaId) {
            currentAreaId = areaId;
            const area = projectData.areas.find(a => a.id === areaId);
            document.getElementById('current-area-name').textContent = area.name;
            document.getElementById('surface-modal').classList.remove('hidden');
        }

        function closeSurfaceModal() {
            document.getElementById('surface-modal').classList.add('hidden');
            currentAreaId = null;
        }

        // Add event listeners for surface selection
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.surface-option').forEach(button => {
                button.addEventListener('click', function() {
                    const surfaceType = this.getAttribute('data-surface');
                    const category = this.getAttribute('data-category');
                    const surfaceName = this.querySelector('.font-medium').textContent;
                    
                    selectSurface(surfaceType, surfaceName, category);
                });
            });
        });

        function selectSurface(surfaceType, surfaceName, category) {
            if (!currentAreaId) return;

            const area = projectData.areas.find(a => a.id === currentAreaId);
            const surfaceId = currentAreaId + '-surface-' + Date.now();
            
            const newSurface = {
                id: surfaceId,
                type: surfaceType,
                name: surfaceName,
                category: category,
                dimensions: { length: 0, width: 0, sqft: 0 },
                selectedTile: null,
                cost: 0
            };

            area.surfaces.push(newSurface);
            renderSurface(area, newSurface);
            updateProjectSummary();
            closeSurfaceModal();

            // Prompt for dimensions
            setTimeout(() => {
                promptForDimensions(surfaceId);
            }, 500);
        }

        function renderSurface(area, surface) {
            const surfacesContainer = document.getElementById(area.id + '-surfaces');
            
            // Remove "no surfaces" message if it exists
            const noSurfacesMsg = surfacesContainer.querySelector('.italic');
            if (noSurfacesMsg) {
                noSurfacesMsg.remove();
            }
            
            const surfaceDiv = document.createElement('div');
            surfaceDiv.id = surface.id;
            surfaceDiv.className = 'bg-gray-50 rounded p-3 border border-gray-200';
            
            const categoryColor = surface.category === 'bathroom' ? 'blue' : 
                                surface.category === 'kitchen' ? 'green' : 'purple';
            
            surfaceDiv.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="bg-${categoryColor}-100 text-${categoryColor}-800 px-2 py-1 rounded-full text-xs font-medium">
                                ${surface.category}
                            </span>
                            <span class="font-medium text-gray-800">${surface.name}</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-600">Dimensions:</span>
                                <span class="font-medium ml-1" id="${surface.id}-dimensions">Not set</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Tile:</span>
                                <span class="font-medium ml-1" id="${surface.id}-tile">Not selected</span>
                            </div>
                        </div>
                        
                        <div class="mt-2 flex space-x-2">
                            <button class="text-blue-600 hover:text-blue-800 text-xs" onclick="promptForDimensions('${surface.id}')">
                                <i class="fas fa-ruler mr-1"></i>Set Dimensions
                            </button>
                            <button class="text-green-600 hover:text-green-800 text-xs" onclick="selectTileForSurface('${surface.id}')">
                                <i class="fas fa-camera mr-1"></i>Scan Tile
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-right ml-4">
                        <div class="font-medium text-green-600" id="${surface.id}-cost">$0.00</div>
                        <button class="text-red-600 hover:text-red-800 text-xs mt-1" onclick="removeSurface('${area.id}', '${surface.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            surfacesContainer.appendChild(surfaceDiv);
        }

        function promptForDimensions(surfaceId) {
            const surface = findSurfaceById(surfaceId);
            if (!surface) return;

            const length = parseFloat(prompt(`Enter length for ${surface.name} (in feet):`));
            const width = parseFloat(prompt(`Enter width for ${surface.name} (in feet):`));
            
            if (isNaN(length) || isNaN(width) || length <= 0 || width <= 0) {
                alert('Please enter valid dimensions.');
                return;
            }

            surface.dimensions = {
                length: length,
                width: width,
                sqft: length * width
            };

            document.getElementById(surfaceId + '-dimensions').textContent = `${length}' √ó ${width}' (${surface.dimensions.sqft} sq ft)`;
            calculateSurfaceCost(surface);
            updateProjectSummary();
        }

        function selectTileForSurface(surfaceId) {
            window.currentSurfaceId = surfaceId;
            toggleVisionScanner();
        }

        function findSurfaceById(surfaceId) {
            for (const area of projectData.areas) {
                const surface = area.surfaces.find(s => s.id === surfaceId);
                if (surface) return surface;
            }
            return null;
        }

        function calculateSurfaceCost(surface) {
            if (!surface.selectedTile || !surface.dimensions.sqft) {
                surface.cost = 0;
            } else {
                // Add 10% waste factor
                const totalSqft = surface.dimensions.sqft * 1.1;
                surface.cost = totalSqft * (surface.selectedTile.price || 5.99); // Default price $5.99/sqft
            }

            document.getElementById(surface.id + '-cost').textContent = `$${surface.cost.toFixed(2)}`;
        }

        function removeSurface(areaId, surfaceId) {
            const area = projectData.areas.find(a => a.id === areaId);
            area.surfaces = area.surfaces.filter(s => s.id !== surfaceId);
            
            document.getElementById(surfaceId).remove();
            
            // Add "no surfaces" message if needed
            if (area.surfaces.length === 0) {
                const surfacesContainer = document.getElementById(areaId + '-surfaces');
                surfacesContainer.innerHTML = '<p class="text-gray-500 text-sm italic">No surfaces added yet. Click "Add Surface" to get started.</p>';
            }
            
            updateProjectSummary();
        }

        function removeArea(areaId) {
            if (!confirm('Are you sure you want to remove this area and all its surfaces?')) return;
            
            projectData.areas = projectData.areas.filter(a => a.id !== areaId);
            document.getElementById(areaId).remove();
            updateProjectSummary();
        }

        function updateProjectSummary() {
            let totalCost = 0;
            let totalAreas = projectData.areas.length;
            let totalSurfaces = 0;
            let totalSqft = 0;

            projectData.areas.forEach(area => {
                let areaCost = 0;
                area.surfaces.forEach(surface => {
                    totalSurfaces++;
                    totalSqft += surface.dimensions.sqft || 0;
                    areaCost += surface.cost;
                });
                area.totalCost = areaCost;
                totalCost += areaCost;
                
                // Update area total
                const areaTotal = document.getElementById(area.id + '-total');
                if (areaTotal) {
                    areaTotal.textContent = `$${areaCost.toFixed(2)}`;
                }
            });

            projectData.totalCost = totalCost;

            // Update project summary
            document.getElementById('total-project-cost').textContent = `$${totalCost.toFixed(2)}`;
            document.getElementById('total-areas').textContent = totalAreas;
            document.getElementById('total-surfaces').textContent = totalSurfaces;
            document.getElementById('total-sq-ft').textContent = totalSqft.toFixed(1);

            // Show/hide project summary
            const summary = document.getElementById('project-summary');
            if (totalAreas > 0) {
                summary.style.display = 'block';
            } else {
                summary.style.display = 'none';
            }
        }

        // Save AR visualization data to project
        function saveProjectVisualization(tileData) {
            // Create a project visualization record
            const visualizationData = {
                timestamp: new Date().toISOString(),
                ar_visualization: {
                    tile_type: tileData.type,
                    tile_size: tileData.size,
                    pattern: tileData.pattern,
                    grout_color: tileData.grout_color,
                    room_dimensions: tileData.room_dimensions
                }
            };
            
            // Store in local storage for this session
            const existingData = localStorage.getItem('project_visualizations') || '[]';
            const visualizations = JSON.parse(existingData);
            visualizations.push(visualizationData);
            localStorage.setItem('project_visualizations', JSON.stringify(visualizations));
            
            // Send to backend if customer info is available
            const customerPhone = document.getElementById('customer-phone')?.value;
            if (customerPhone) {
                fetch('/api/project/ar-visualization', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_number: customerPhone,
                        visualization_data: visualizationData
                    })
                }).catch(error => {
                    console.error('Failed to save visualization to backend:', error);
                });
            }
            
            console.log('AR visualization saved:', visualizationData);
        }

        // Socket.io connection handlers
        socket.on('connect', function() {
            console.log('Connected to customer chat server');
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from customer chat server');
        });
    </script>
    
    <!-- Form Panel JavaScript -->
    <script src="/static/chat.js"></script>
</body>
</html>