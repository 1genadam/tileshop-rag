{% extends "base.html" %}

{% block title %}Dashboard - Tile Shop Intelligence{% endblock %}

{% block content %}
<div class="grid grid-4">
    <!-- Unified System Services Table -->
    <div class="card span-3">
        <h3><i class="fas fa-cogs"></i> System Services Dashboard</h3>
        
        <!-- Unified Controls -->
        <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <!-- Services Toggle Switch -->
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span style="font-weight: 500; color: #374151;">All Services:</span>
                    <div class="toggle-switch" onclick="toggleAllServices()">
                        <input type="checkbox" id="services-toggle" style="display: none;">
                        <label for="services-toggle" class="toggle-label">
                            <span class="toggle-slider"></span>
                            <span class="toggle-text-off">OFF</span>
                            <span class="toggle-text-on">ON</span>
                        </label>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="restartAllServices()">
                    <i class="fas fa-sync"></i> Restart All Services
                </button>
                <button class="btn btn-secondary" onclick="refreshAllStatus()">
                    <i class="fas fa-refresh"></i> Refresh Status
                </button>
                <button class="btn btn-info" onclick="runComprehensiveHealthCheck()">
                    <i class="fas fa-heartbeat"></i> Health Check All (17 Services)
                </button>
                <div id="bulk-operation-status" style="margin-left: auto; font-weight: bold;"></div>
            </div>
        </div>
        
        <!-- Unified Services Table -->
        <div class="services-table-container">
            <table class="services-table">
                <thead>
                    <tr>
                        <th style="width: 60px;">#</th>
                        <th style="width: 180px;">Service</th>
                        <th style="width: 120px;">Status</th>
                        <th>Description</th>
                        <th style="width: 60px;">Health</th>
                        <th style="width: 60px;">Logs</th>
                        <th style="width: 60px;">Debug</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- MICROSERVICES SECTION -->
                    <tr class="section-header">
                        <td colspan="7" style="background: #667eea; color: white; font-weight: bold; padding: 12px; text-align: left;">
                            üîß MICROSERVICES
                        </td>
                    </tr>
                    <!-- Service 0: Docker Engine -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">0</td>
                        <td style="white-space: nowrap;">
                            <i class="fas fa-cube" style="margin-right: 8px; color: #3b82f6;"></i>
                            docker_engine
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="docker_engine-dot"></div>
                                <span id="docker_engine-text">Checking...</span>
                            </div>
                        </td>
                        <td id="docker_engine-info">Container orchestration and infrastructure platform</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkServiceHealth('docker_engine')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showServiceLogs('docker_engine')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugService('docker_engine')">üîß</button>
                        </td>
                    </tr>

                    <!-- Service 1: Relational Database -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">1</td>
                        <td style="white-space: nowrap;">
                            <i class="fas fa-server" style="margin-right: 8px; color: #10b981;"></i>
                            relational_db
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="relational_db-dot"></div>
                                <span id="relational_db-text">Checking...</span>
                            </div>
                        </td>
                        <td id="relational_db-info">Primary relational database for structured data</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkServiceHealth('relational_db')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showServiceLogs('relational_db')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugService('relational_db')">üîß</button>
                        </td>
                    </tr>

                    <!-- Service 2: Vector Database -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">2</td>
                        <td style="white-space: nowrap;">
                            <i class="fas fa-database" style="margin-right: 8px; color: #8b5cf6;"></i>
                            vector_db
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="vector_db-dot"></div>
                                <span id="vector_db-text">Checking...</span>
                            </div>
                        </td>
                        <td id="vector_db-info">Vector database with embeddings and AI capabilities</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkServiceHealth('vector_db')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showServiceLogs('vector_db')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugService('vector_db')">üîß</button>
                        </td>
                    </tr>

                    <!-- Service 3: Web Crawler -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">3</td>
                        <td style="white-space: nowrap;">
                            <i class="fas fa-spider" style="margin-right: 8px; color: #f59e0b;"></i>
                            crawler
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="crawler-dot"></div>
                                <span id="crawler-text">Checking...</span>
                            </div>
                        </td>
                        <td id="crawler-info">AI-powered web crawling service</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkServiceHealth('crawler')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showServiceLogs('crawler')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugService('crawler')">üîß</button>
                        </td>
                    </tr>

                    <!-- Service 4: LLM API -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">4</td>
                        <td style="white-space: nowrap;">
                            <i class="fas fa-brain" style="margin-right: 8px; color: #ef4444;"></i>
                            llm_api
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="llm_api-dot"></div>
                                <span id="llm_api-text">Checking...</span>
                            </div>
                        </td>
                        <td id="llm_api-info">Large language model API for AI processing</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkServiceHealth('llm_api')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showServiceLogs('llm_api')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugService('llm_api')">üîß</button>
                        </td>
                    </tr>

                    <!-- Service 5: Web Server -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">5</td>
                        <td style="white-space: nowrap;">
                            <i class="fas fa-globe" style="margin-right: 8px; color: #06b6d4;"></i>
                            web_server
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="web_server-dot"></div>
                                <span id="web_server-text">Checking...</span>
                            </div>
                        </td>
                        <td id="web_server-info">Flask application server and dashboard interface</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkServiceHealth('web_server')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showServiceLogs('web_server')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugService('web_server')">üîß</button>
                        </td>
                    </tr>

                    <!-- Service 6: API Gateway -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">6</td>
                        <td style="white-space: nowrap;">
                            <i class="fas fa-exchange-alt" style="margin-right: 8px; color: #84cc16;"></i>
                            api_gateway
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="api_gateway-dot"></div>
                                <span id="api_gateway-text">Checking...</span>
                            </div>
                        </td>
                        <td id="api_gateway-info">API management and routing service</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkServiceHealth('api_gateway')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showServiceLogs('api_gateway')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugService('api_gateway')">üîß</button>
                        </td>
                    </tr>

                    <!-- Service 7: Intelligence Platform -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">7</td>
                        <td style="white-space: nowrap;">
                            <i class="fas fa-cog" style="margin-right: 8px; color: #6366f1;"></i>
                            intelligence_platform
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="intelligence_platform-dot"></div>
                                <span id="intelligence_platform-text">Checking...</span>
                            </div>
                        </td>
                        <td id="intelligence_platform-info">AI-powered orchestration and management interface</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkServiceHealth('intelligence_platform')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showServiceLogs('intelligence_platform')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugService('intelligence_platform')">üîß</button>
                        </td>
                    </tr>

                    <!-- RUNTIME ENVIRONMENT SECTION -->
                    <tr class="section-header">
                        <td colspan="7" style="background: #10b981; color: white; font-weight: bold; padding: 12px; text-align: left;">
                            üèÉ RUNTIME ENVIRONMENT
                        </td>
                    </tr>

                    <!-- Runtime 8: Virtual Environment -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">8</td>
                        <td style="white-space: nowrap;">
                            <i class="fas fa-box" style="margin-right: 8px; color: #3776ab;"></i>
                            virtual_environment
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="virtual_environment-runtime-dot"></div>
                                <span id="virtual_environment-runtime-text">Checking...</span>
                            </div>
                        </td>
                        <td id="virtual_environment-runtime-info">Python virtual environment (autogen_env)</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkRuntimeHealth('virtual_environment')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showRuntimeLogs('virtual_environment')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugRuntime('virtual_environment')">üîß</button>
                        </td>
                    </tr>

                    <!-- Runtime 9: Dependencies -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">9</td>
                        <td style="white-space: nowrap;">
                            <i class="fas fa-puzzle-piece" style="margin-right: 8px; color: #f59e0b;"></i>
                            dependencies
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="dependencies-runtime-dot"></div>
                                <span id="dependencies-runtime-text">Checking...</span>
                            </div>
                        </td>
                        <td id="dependencies-runtime-info">Package dependencies (psycopg2, flask, docker, requests)</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkRuntimeHealth('dependencies')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showRuntimeLogs('dependencies')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugRuntime('dependencies')">üîß</button>
                        </td>
                    </tr>

                    <!-- Runtime 10: Docker Daemon -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">10</td>
                        <td style="white-space: nowrap;">
                            <i class="fab fa-docker" style="margin-right: 8px; color: #2496ed;"></i>
                            docker_daemon
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="docker_daemon-runtime-dot"></div>
                                <span id="docker_daemon-runtime-text">Checking...</span>
                            </div>
                        </td>
                        <td id="docker_daemon-runtime-info">Docker daemon and container engine</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkRuntimeHealth('docker_daemon')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showRuntimeLogs('docker_daemon')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugRuntime('docker_daemon')">üîß</button>
                        </td>
                    </tr>

                    <!-- Runtime 11: Infrastructure -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">11</td>
                        <td style="white-space: nowrap;">
                            <i class="fas fa-network-wired" style="margin-right: 8px; color: #6b7280;"></i>
                            infrastructure
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="infrastructure-runtime-dot"></div>
                                <span id="infrastructure-runtime-text">Checking...</span>
                            </div>
                        </td>
                        <td id="infrastructure-runtime-info">System infrastructure and network connectivity</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkRuntimeHealth('infrastructure')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showRuntimeLogs('infrastructure')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugRuntime('infrastructure')">üîß</button>
                        </td>
                    </tr>

                    <!-- PRE-WARMING SYSTEMS SECTION -->
                    <tr class="section-header">
                        <td colspan="7" style="background: #f59e0b; color: white; font-weight: bold; padding: 12px; text-align: left;">
                            ‚ö° PRE-WARMING SYSTEMS
                        </td>
                    </tr>

                    <!-- Pre-warming 12: Python Subprocess -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">12</td>
                        <td style="white-space: nowrap;">
                            <i class="fab fa-python" style="margin-right: 8px; color: #3776ab;"></i>
                            python_subprocess
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="python_subprocess-prewarm-dot"></div>
                                <span id="python_subprocess-prewarm-text">Checking...</span>
                            </div>
                        </td>
                        <td id="python_subprocess-prewarm-info">Python subprocess startup and initialization</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkPrewarmHealth('python_subprocess')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showPrewarmLogs('python_subprocess')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugPrewarm('python_subprocess')">üîß</button>
                        </td>
                    </tr>

                    <!-- Pre-warming 13: Relational Database Connection -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">13</td>
                        <td style="white-space: nowrap;">
                            <i class="fas fa-server" style="margin-right: 8px; color: #10b981;"></i>
                            relational_db_prewarm
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="relational_db_prewarm-prewarm-dot"></div>
                                <span id="relational_db_prewarm-prewarm-text">Checking...</span>
                            </div>
                        </td>
                        <td id="relational_db_prewarm-prewarm-info">Relational database connection pre-warming</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkPrewarmHealth('relational_db_prewarm')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showPrewarmLogs('relational_db_prewarm')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugPrewarm('relational_db_prewarm')">üîß</button>
                        </td>
                    </tr>

                    <!-- Pre-warming 14: Sitemap Validation -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">14</td>
                        <td style="white-space: nowrap;">
                            <i class="fas fa-sitemap" style="margin-right: 8px; color: #3b82f6;"></i>
                            sitemap_validation
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="sitemap_validation-prewarm-dot"></div>
                                <span id="sitemap_validation-prewarm-text">Checking...</span>
                            </div>
                        </td>
                        <td id="sitemap_validation-prewarm-info">Sitemap validation and URL verification</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkPrewarmHealth('sitemap_validation')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showPrewarmLogs('sitemap_validation')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugPrewarm('sitemap_validation')">üîß</button>
                        </td>
                    </tr>

                    <!-- Pre-warming 15: Vector Database Connection -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">15</td>
                        <td style="white-space: nowrap;">
                            <i class="fas fa-database" style="margin-right: 8px; color: #8b5cf6;"></i>
                            vector_db_prewarm
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="vector_db_prewarm-prewarm-dot"></div>
                                <span id="vector_db_prewarm-prewarm-text">Checking...</span>
                            </div>
                        </td>
                        <td id="vector_db_prewarm-prewarm-info">Vector database connection pre-warming</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkPrewarmHealth('vector_db_prewarm')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showPrewarmLogs('vector_db_prewarm')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugPrewarm('vector_db_prewarm')">üîß</button>
                        </td>
                    </tr>

                    <!-- Pre-warming 16: Crawler Service -->
                    <tr>
                        <td style="text-align: center; font-weight: bold;">16</td>
                        <td style="white-space: nowrap;">
                            <i class="fas fa-spider" style="margin-right: 8px; color: #f59e0b;"></i>
                            crawler_service_prewarm
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="status-dot gray" id="crawler_service_prewarm-prewarm-dot"></div>
                                <span id="crawler_service_prewarm-prewarm-text">Checking...</span>
                            </div>
                        </td>
                        <td id="crawler_service_prewarm-prewarm-info">Crawler service pre-warming and readiness</td>
                        <td>
                            <button class="btn btn-xs btn-success" onclick="checkPrewarmHealth('crawler_service_prewarm')">üîç</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="showPrewarmLogs('crawler_service_prewarm')">üìã</button>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-warning" onclick="debugPrewarm('crawler_service_prewarm')">üîß</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
</div>

<!-- Data Quality Alert -->
<div class="card" id="quality-alert-card" style="display: block;">
    <h3><i class="fas fa-exclamation-triangle"></i> Data Quality Alert</h3>
    <div id="quality-alert-content">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <div class="status-dot red" id="quality-alert-dot"></div>
            <div>
                <div style="font-weight: bold; color: #dc2626;" id="quality-alert-title">Data Extraction Issues Detected</div>
                <div style="font-size: 0.875rem; color: #6b7280;" id="quality-alert-summary"></div>
            </div>
        </div>
        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
            <div style="font-weight: 500; margin-bottom: 0.5rem;">Quality Statistics (Last 10 Records):</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; font-size: 0.875rem;">
                <div>
                    <strong id="quality-total-products">0</strong> Total Products
                </div>
                <div>
                    <strong id="quality-high-quality">0</strong> High Quality (‚â•10 fields)
                </div>
                <div>
                    <strong id="quality-low-quality">0</strong> Poor Quality (&lt;10 fields)
                </div>
                <div>
                    <strong id="quality-percentage">0%</strong> Success Rate
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-primary btn-sm" onclick="refreshQualityCheck()">
                <i class="fas fa-sync"></i> Refresh Check
            </button>
            <button class="btn btn-secondary btn-sm" onclick="dismissQualityAlert()">
                <i class="fas fa-times"></i> Dismiss
            </button>
        </div>
    </div>
</div>

<!-- Data Acquisition Control -->
<div class="card">
    <h3><i class="fas fa-download"></i> Data Acquisition Control</h3>
    <div class="grid grid-2">
        <div>
            <div class="form-group">
                <label>Target Website URL:</label>
                <input type="url" class="form-control" id="target-url" value="https://www.tileshop.com" placeholder="Enter website URL for data acquisition">
                <div id="url-validation" style="margin-top: 0.5rem; font-size: 0.875rem;"></div>
            </div>
            <div class="form-group">
                <label>Discovered Sitemap:</label>
                <div id="sitemap-display" style="padding: 0.75rem; background: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 0.875rem; min-height: 40px; display: flex; align-items: center;">
                    <span id="sitemap-url" style="color: #6b7280;">Enter URL above to detect sitemap...</span>
                    <button class="btn btn-xs btn-secondary" id="detect-sitemap-btn" onclick="detectSitemap()" style="margin-left: auto; display: none;">
                        <i class="fas fa-search"></i> Detect
                    </button>
                </div>
                <div id="sitemap-status" style="margin-top: 0.5rem; font-size: 0.875rem;"></div>
            </div>
            <div class="form-group">
                <label>Sitemap Download Status:</label>
                <div id="sitemap-download-container" style="padding: 0.75rem; background: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span id="sitemap-download-stage" style="font-weight: 500;">Ready</span>
                        <span id="sitemap-download-progress-text" style="font-size: 0.875rem; color: #6b7280;">0%</span>
                    </div>
                    <div class="progress-bar" style="margin-bottom: 0.5rem;">
                        <div class="progress-fill" id="sitemap-download-progress-bar" style="width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <div id="sitemap-download-message" style="font-size: 0.875rem; color: #4b5563;">
                        Click "Download Sitemap" to begin download and filtering process
                    </div>
                    <div id="sitemap-download-details" style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem; display: none;">
                    </div>
                    <div style="margin-top: 0.75rem;">
                        <button class="btn btn-primary btn-xs" id="download-sitemap-btn" onclick="downloadSitemap()" disabled>
                            <i class="fas fa-download"></i> Download Sitemap
                        </button>
                        <button class="btn btn-secondary btn-xs" onclick="refreshSitemapStatus()" style="margin-left: 0.5rem;">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Sitemap Statistics:</label>
                <div id="sitemap-stats-container" style="padding: 0.75rem; background: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.1rem; font-weight: bold; color: #3b82f6;" id="sitemap-total-count">-</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">Total URLs</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.1rem; font-weight: bold; color: #f59e0b;" id="sitemap-pending-count">-</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">Pending</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.1rem; font-weight: bold; color: #10b981;" id="sitemap-learned-count">-</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">Learned</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.1rem; font-weight: bold; color: #8b5cf6;" id="sitemap-inserted-count">-</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">Inserted</div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; color: #4b5563;">
                        <span id="sitemap-status-message">No sitemap data available</span>
                        <span id="sitemap-completion-rate" style="font-weight: 500;">0%</span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Current Filter Criteria:</label>
                <div style="padding: 0.75rem; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; font-family: monospace; font-size: 0.875rem;">
                    <div style="margin-bottom: 0.5rem; font-weight: 600; color: #0c4a6e;">‚úÖ Include URLs that contain:</div>
                    <div style="margin-left: 1rem; color: #0369a1;">‚Ä¢ <code>tileshop.com/products</code> (main product pages)</div>
                    
                    <div style="margin: 0.75rem 0 0.5rem 0; font-weight: 600; color: #991b1b;">‚ùå Exclude URLs that contain:</div>
                    <div style="margin-left: 1rem; color: #dc2626;">
                        ‚Ä¢ <code>tileshop.com/products/,-w-,</code> (special collection URLs)<br>
                        ‚Ä¢ <code>sample</code> (sample pages)
                    </div>
                    
                    <div style="margin-top: 0.75rem; padding-top: 0.5rem; border-top: 1px solid #bae6fd; font-size: 0.8rem; color: #0369a1;">
                        <strong>Typical Result:</strong> ~775 product URLs from 4,700+ total sitemap entries (16.5% filtered)
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Acquisition Mode:</label>
                <select class="form-control" id="acquisition-mode">
                    <option value="test">Test Mode (10 URLs)</option>
                    <option value="sitemap" selected>Complete Sitemap Learning Mode</option>
                    <option value="category">Category-Based Learning Mode</option>
                </select>
            </div>
            <div class="form-group" id="category-selection-group" style="display: none;">
                <label>Product Category:</label>
                <select class="form-control" id="acquisition-category">
                    <option value="">Loading categories...</option>
                </select>
                <small class="form-text text-muted">
                    <i class="fas fa-info-circle"></i> 
                    Select a specific product category to crawl with optimized parsing for that product type.
                </small>
            </div>
            <div class="form-group">
                <label>URL Limit:</label>
                <input type="number" class="form-control" id="acquisition-limit" value="4775" min="1" max="4775">
            </div>
            <div class="form-group">
                <label>Batch Size:</label>
                <input type="number" class="form-control" id="acquisition-batch-size" value="10" min="1" max="100" 
                       title="Number of URLs to process simultaneously in each batch">
                <small class="form-text text-muted">
                    <i class="fas fa-info-circle"></i> 
                    Controls how many products are processed in parallel. Higher values = faster processing but more resource usage.
                </small>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="acquisition-fresh"> Fresh start (ignore previous progress)
                </label>
            </div>
        </div>
        <div>
            <div id="acquisition-status">
                <p><strong>Status:</strong> <span id="acquisition-status-text">Idle</span></p>
                <p><strong>Mode:</strong> <span id="acquisition-mode-text">-</span></p>
                <p><strong>Progress:</strong> <span id="acquisition-progress">0%</span> 
                   <span id="acquisition-eta" style="color: #666; margin-left: 1rem;">ETA: --</span></p>
                <div class="progress-bar">
                    <div class="progress-fill" id="acquisition-progress-bar" style="width: 0%"></div>
                </div>
                <div class="acquisition-stats-grid">
                    <p><strong>Processed:</strong> <span id="acquisition-count">0</span> / <span id="acquisition-total">0</span></p>
                    <p><strong>Successful:</strong> <span id="acquisition-success" style="color: #16a34a;">0</span></p>
                    <p><strong>Errors:</strong> <span id="acquisition-errors" style="color: #dc2626;">0</span></p>
                </div>
                <div style="margin: 0.5rem 0;">
                    <p><strong>Average Read Speed:</strong> <span id="acquisition-speed">-- pages/min</span> 
                       <span style="margin-left: 1rem;"><strong>Counter:</strong> <span id="acquisition-counter">--</span>s</span>
                       <span style="margin-left: 1rem;"><strong>Runtime:</strong> <span id="acquisition-runtime">--</span></span></p>
                </div>
                <p><strong>Current URL:</strong></p>
                <div id="current-url-container" style="position: relative;">
                    <div id="current-url" style="font-family: monospace; font-size: 0.8rem; background: #f3f4f6; padding: 0.5rem; border-radius: 4px; word-break: break-all; max-height: 60px; overflow-y: auto; transition: background-color 0.3s;">
                        Services loading...
                    </div>
                    <div id="url-status-indicator" style="position: absolute; top: 0.5rem; right: 0.5rem; width: 8px; height: 8px; border-radius: 50%; background: #ccc; transition: background-color 0.3s;"></div>
                </div>
            </div>
            
            <div style="margin-top: 1rem; display: flex; gap: 1rem; align-items: center;">
                <button class="btn btn-success" id="start-acquisition" onclick="startAcquisition()">
                    <i class="fas fa-play"></i> Start Learning
                </button>
                <button class="btn btn-danger" id="stop-acquisition" onclick="stopAcquisition()" disabled>
                    <i class="fas fa-stop"></i> Stop
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Database Sync Control -->
<div class="card">
    <h3><i class="fas fa-sync"></i> Database Sync</h3>
    <div class="grid grid-2">
        <div>
            <div id="sync-status">
                <p><strong>Source (Relational DB):</strong> <span id="source-status">Checking...</span></p>
                <p><strong>Target (Vector DB):</strong> <span id="target-status">Checking...</span></p>
                <p><strong>Sync Status:</strong> <span id="sync-ready">-</span></p>
                <p><strong>Last Sync:</strong> <span id="last-sync">Never</span></p>
            </div>
        </div>
        <div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="force-full-sync"> Force full sync (slower)
                </label>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-start;">
                <button class="btn btn-success" id="sync-data-btn" onclick="syncData()">
                    <i class="fas fa-sync"></i> Sync Data
                </button>
                <button class="btn btn-secondary" onclick="testSyncConnections()">
                    <i class="fas fa-plug"></i> Test Connections
                </button>
                <button class="btn btn-info" onclick="showSyncComparison()">
                    <i class="fas fa-balance-scale"></i> Compare Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Data Intelligence Analytics -->
<div class="card">
    <h3><i class="fas fa-chart-bar"></i> Learning Analytics</h3>
    <div class="grid grid-4">
        <div>
            <h4 style="color: #3b82f6;">Total Acquired</h4>
            <p style="font-size: 2rem; font-weight: bold;" id="total-products">-</p>
        </div>
        <div>
            <h4 style="color: #10b981;">Success Rate</h4>
            <p style="font-size: 2rem; font-weight: bold;" id="success-rate">-</p>
        </div>
        <div>
            <h4 style="color: #f59e0b;">Avg Processing Time</h4>
            <p style="font-size: 2rem; font-weight: bold;" id="avg-scrape-time">-</p>
        </div>
        <div>
            <h4 style="color: #ef4444;">Recent (24h)</h4>
            <p style="font-size: 2rem; font-weight: bold;" id="recent-products">-</p>
        </div>
    </div>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin: 1rem 0; padding: 1rem; background: #f8fafc; border-radius: 6px;">
        <div>
            <h4 style="color: #6366f1; font-size: 0.9rem;">Total Learning Time</h4>
            <p style="font-size: 1.5rem; font-weight: bold;" id="total-scrape-time">-</p>
        </div>
        <div>
            <h4 style="color: #8b5cf6; font-size: 0.9rem;">Available URLs</h4>
            <p style="font-size: 1.5rem; font-weight: bold;" id="available-urls">-</p>
        </div>
        <div>
            <h4 style="color: #06b6d4; font-size: 0.9rem;">Coverage</h4>
            <p style="font-size: 1.5rem; font-weight: bold;" id="url-coverage">-</p>
        </div>
    </div>
</div>

<!-- System Statistics -->
<div class="card">
    <h3><i class="fas fa-server"></i> System Statistics</h3>
    <div class="grid grid-2" style="gap: 2rem;">
        <div>
            <h4 style="color: #3b82f6; margin-bottom: 1rem;"><i class="fas fa-microchip"></i> CPU Usage</h4>
            <div style="margin-bottom: 0.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Current:</span>
                    <span id="cpu-usage" style="font-weight: bold;">-</span>
                </div>
                <div class="progress-bar" style="margin-top: 0.25rem;">
                    <div class="progress-fill" id="cpu-progress" style="width: 0%; background: linear-gradient(90deg, #10b981, #059669);"></div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem; color: #666;">
                <div>Cores: <span id="cpu-cores">-</span></div>
                <div>Load Avg: <span id="cpu-load">-</span></div>
            </div>
        </div>
        <div>
            <h4 style="color: #f59e0b; margin-bottom: 1rem;"><i class="fas fa-memory"></i> Memory Usage</h4>
            <div style="margin-bottom: 0.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Used:</span>
                    <span id="memory-usage" style="font-weight: bold;">-</span>
                </div>
                <div class="progress-bar" style="margin-top: 0.25rem;">
                    <div class="progress-fill" id="memory-progress" style="width: 0%; background: linear-gradient(90deg, #f59e0b, #d97706);"></div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem; color: #666;">
                <div>Total: <span id="memory-total">-</span></div>
                <div>Available: <span id="memory-available">-</span></div>
            </div>
        </div>
    </div>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 6px;">
        <div>
            <h4 style="color: #ef4444; font-size: 0.9rem;"><i class="fas fa-hdd"></i> Disk Usage</h4>
            <p style="font-size: 1.3rem; font-weight: bold;" id="disk-usage">-</p>
            <div class="progress-bar" style="margin-top: 0.25rem; height: 4px;">
                <div class="progress-fill" id="disk-progress" style="width: 0%; background: linear-gradient(90deg, #ef4444, #dc2626);"></div>
            </div>
        </div>
        <div>
            <h4 style="color: #8b5cf6; font-size: 0.9rem;"><i class="fas fa-database"></i> DB Connections</h4>
            <p style="font-size: 1.3rem; font-weight: bold;" id="db-connections">-</p>
        </div>
        <div>
            <h4 style="color: #06b6d4; font-size: 0.9rem;"><i class="fas fa-clock"></i> Uptime</h4>
            <p style="font-size: 1.3rem; font-weight: bold;" id="system-uptime">-</p>
        </div>
    </div>
</div>

<!-- SKU Lookup Section -->
<div class="card">
    <h3><i class="fas fa-search"></i> SKU Lookup</h3>
    <p style="color: #666; margin-bottom: 1rem;">Search for a specific product by SKU to view its database information</p>
    
    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
        <input 
            type="text" 
            id="sku-input" 
            placeholder="Enter SKU (e.g., 684287, 683996, etc.)"
            style="flex: 1; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;"
            onkeypress="if(event.key==='Enter') lookupSku()"
        >
        <button class="btn btn-primary" onclick="lookupSku()">
            <i class="fas fa-search"></i> Search
        </button>
    </div>
    
    <div id="sku-results" style="display: none;">
        <div id="sku-product-info" style="background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem;">
            <!-- Product information will be displayed here -->
        </div>
    </div>
    
    <div id="sku-error" style="display: none; color: #ef4444; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 1rem;">
        <!-- Error messages will be displayed here -->
    </div>
    
    <div id="sku-loading" style="display: none; text-align: center; padding: 2rem; color: #666;">
        <i class="fas fa-spinner fa-spin"></i> Searching database...
    </div>
    
    <!-- Product Management Actions -->
    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
        <div style="display: flex; gap: 1rem; justify-content: center;">
            <button class="btn btn-primary" onclick="viewProducts()">
                <i class="fas fa-table"></i> View Products
            </button>
            <button class="btn btn-secondary" onclick="exportProducts()">
                <i class="fas fa-download"></i> Export CSV
            </button>
        </div>
    </div>
</div>

<!-- Recent Logs -->
<div class="card">
    <h3><i class="fas fa-terminal"></i> Recent Activity</h3>
    <div id="activity-log" style="background: #1f2937; color: #e5e7eb; padding: 1rem; border-radius: 6px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.875rem;">
        <div>Waiting for activity...</div>
    </div>
</div>

<!-- Logs Modal -->
<div class="modal" id="logs-modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 id="logs-title">Container Logs</h3>
            <button class="modal-close" onclick="closeLogs()">&times;</button>
        </div>
        <div id="logs-content" style="background: #1f2937; color: #e5e7eb; padding: 1rem; border-radius: 6px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.875rem; white-space: pre-wrap;">
        </div>
    </div>
</div>

<!-- AI Terminal Modal -->
<div class="modal" id="ai-terminal-modal">
    <div class="modal-content" style="max-width: 900px; height: 80vh;">
        <div class="modal-header">
            <h3><i class="fas fa-headset"></i> Customer Service Assistant</h3>
            <button class="modal-close" onclick="closeAITerminal()">&times;</button>
        </div>
        <div style="display: flex; flex-direction: column; height: calc(100% - 60px);">
            <!-- Chat History -->
            <div id="ai-chat-history" style="flex: 1; background: #1f2937; color: #e5e7eb; padding: 1rem; border-radius: 6px; overflow-y: auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin-bottom: 1rem;">
                <div class="ai-message system">
                    <strong>ü§ñ Customer Service Assistant:</strong> Hello! I'm here to help with your Tile Shop intelligence platform questions and issues. I can assist with:
                    <br>‚Ä¢ Troubleshooting learning process errors
                    <br>‚Ä¢ Product data questions and analysis
                    <br>‚Ä¢ Error log interpretation
                    <br>‚Ä¢ Usage guidance and support
                    <br><br>How can I help you today?
                </div>
            </div>
            
            <!-- Input Area -->
            <div style="display: flex; gap: 0.5rem;">
                <input 
                    type="text" 
                    id="ai-input" 
                    placeholder="Describe your issue or ask about product data..."
                    style="flex: 1; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;"
                    onkeypress="if(event.key==='Enter') sendAIMessage()"
                />
                <button class="btn btn-primary" onclick="sendAIMessage()">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Products Modal -->
<div class="modal" id="products-modal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h3>Product Database</h3>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="btn btn-xs btn-primary" onclick="loadProductsTable()" style="display: flex; align-items: center; gap: 0.25rem;">
                    <i class="fas fa-sync"></i> Refresh
                </button>
                <button class="modal-close" onclick="closeProducts()">&times;</button>
            </div>
        </div>
        <div id="products-content">
            <div class="form-group">
                <input type="text" class="form-control" id="product-search" placeholder="Search products..." onkeyup="searchProducts()">
            </div>
            <div id="products-table" style="max-height: 500px; overflow-y: auto;">
                Loading products...
            </div>
        </div>
    </div>
</div>

<!-- Health Check Modal -->
<div class="modal" id="health-check-modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3><i class="fas fa-heartbeat"></i> System Health Check</h3>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="btn btn-xs btn-secondary" onclick="copyHealthResults()" title="Copy to clipboard">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="modal-close" onclick="closeHealthCheck()">&times;</button>
            </div>
        </div>
        <div id="health-check-content" style="background: #f8f9fa; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.9rem; white-space: pre-wrap; max-height: 500px; overflow-y: auto;">
            Loading health check results...
        </div>
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef; text-align: center; color: #6c757d; font-size: 0.8rem;">
            Health check will remain open until closed manually
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let acquisitionRunning = false;
    let globalSitemapStats = null;
    
    function initPage() {
        // Initial load and start periodic refresh (optimized for performance)
        loadDashboardData();
        setInterval(loadDashboardData, 60000); // Refresh every 60 seconds (reduced frequency)
        
        // Initialize sitemap detection on page load
        detectSitemapOnLoad();
        
        // Auto-start disabled for faster dashboard loading
        // Users can manually start learning when needed
        
        // Add URL input listener for automatic sitemap detection
        const urlInput = document.getElementById('target-url');
        if (urlInput) {
            urlInput.addEventListener('input', debounce(detectSitemap, 1000));
        }
        
        // Add acquisition mode dropdown listener to update limit
        const acquisitionModeSelect = document.getElementById('acquisition-mode');
        if (acquisitionModeSelect) {
            acquisitionModeSelect.addEventListener('change', function() {
                const limitInput = document.getElementById('acquisition-limit');
                if (this.value === 'sitemap') {
                    // Use real total URL count from sitemap stats, fallback to 4775 if not available
                    const totalUrls = globalSitemapStats ? globalSitemapStats.total_urls : 4775;
                    limitInput.value = totalUrls;
                } else if (this.value === 'test') {
                    limitInput.value = 10;
                }
            });
        }
    }
    
    
    function setServiceStatus(serviceId, status, text) {
        // Hide progress bar when status is determined
        hideServiceProgress(serviceId);
        
        // Update status text and dot
        const statusElement = document.getElementById(serviceId + '-text');
        const dotElement = document.getElementById(serviceId + '-dot');
        
        if (statusElement) {
            statusElement.textContent = text;
        }
        
        if (dotElement) {
            dotElement.className = 'status-dot ' + (status === 'running' ? 'green' : status === 'pending' ? 'yellow' : 'red');
        }
        
        // Show progress bar for pending states
        if (status === 'pending' || status === 'checking') {
            showServiceProgress(serviceId);
        }
    }
    
    function setEnvironmentStatus(envId, status, text, details) {
        // Hide progress bar when status is determined
        hideEnvironmentProgress(envId);
        
        // Update status elements
        const statusElement = document.getElementById(envId + '-text');
        const dotElement = document.getElementById(envId + '-dot');
        const detailsElement = document.getElementById(envId + '-details');
        
        if (statusElement) {
            statusElement.textContent = text;
        }
        
        if (dotElement) {
            dotElement.className = 'status-dot ' + (status === 'healthy' ? 'green' : status === 'warning' ? 'yellow' : 'red');
        }
        
        if (detailsElement && details) {
            detailsElement.textContent = details;
        }
        
        // Show progress bar for pending/checking states
        if (status === 'checking' || text.includes('Checking') || text.includes('...')) {
            showEnvironmentProgress(envId);
        }
    }
    
    // Sitemap Detection Functions
    async function detectSitemapOnLoad() {
        const urlInput = document.getElementById('target-url');
        if (urlInput && urlInput.value) {
            await detectSitemap();
        }
    }
    
    async function detectSitemap() {
        const urlInput = document.getElementById('target-url');
        const sitemapDisplay = document.getElementById('sitemap-url');
        const sitemapStatus = document.getElementById('sitemap-status');
        const detectBtn = document.getElementById('detect-sitemap-btn');
        
        if (!urlInput || !urlInput.value) {
            sitemapDisplay.textContent = 'Enter URL above to detect sitemap...';
            sitemapDisplay.style.color = '#6b7280';
            sitemapStatus.textContent = '';
            detectBtn.style.display = 'none';
            return;
        }
        
        const url = urlInput.value.trim();
        if (!url.match(/^https?:\/\/.+/)) {
            sitemapDisplay.textContent = 'Please enter a valid HTTP/HTTPS URL';
            sitemapDisplay.style.color = '#ef4444';
            sitemapStatus.textContent = '';
            detectBtn.style.display = 'none';
            return;
        }
        
        // Show loading state
        sitemapDisplay.textContent = 'Detecting sitemap...';
        sitemapDisplay.style.color = '#3b82f6';
        sitemapStatus.textContent = '';
        detectBtn.style.display = 'none';
        
        try {
            const response = await fetch('/api/acquisition/detect-sitemap', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            });
            
            const result = await response.json();
            
            if (result.success && result.sitemap_url) {
                sitemapDisplay.textContent = result.sitemap_url;
                sitemapDisplay.style.color = '#10b981';
                sitemapStatus.innerHTML = `<span style="color: #10b981;">‚úì Sitemap found</span>`;
                
                // Enable download button when sitemap is found
                const downloadBtn = document.getElementById('download-sitemap-btn');
                if (downloadBtn) {
                    downloadBtn.disabled = false;
                }
            } else {
                sitemapDisplay.textContent = 'No sitemap found';
                sitemapDisplay.style.color = '#f59e0b';
                sitemapStatus.innerHTML = `<span style="color: #f59e0b;">‚ö† ${result.message || 'Sitemap not detected'}</span>`;
                detectBtn.style.display = 'inline-block';
                
                // Disable download button when sitemap not found
                const downloadBtn = document.getElementById('download-sitemap-btn');
                if (downloadBtn) {
                    downloadBtn.disabled = true;
                }
            }
        } catch (error) {
            sitemapDisplay.textContent = 'Error detecting sitemap';
            sitemapDisplay.style.color = '#ef4444';
            sitemapStatus.innerHTML = `<span style="color: #ef4444;">‚ùå ${error.message}</span>`;
            detectBtn.style.display = 'inline-block';
        }
    }
    
    // Debounce function to limit API calls
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    async function loadDashboardData() {
        try {
            // Load only essential data for better performance
            
            // Load acquisition status (most important for user)
            const acquisitionStatus = await apiCall('/api/acquisition/status');
            if (acquisitionStatus.success) {
                updateAcquisitionStatus(acquisitionStatus.status);
            }
            
            // Load sitemap status (important for learning)
            const sitemapStatus = await apiCall('/api/acquisition/sitemap-status');
            if (sitemapStatus.success) {
                updateSitemapStats(sitemapStatus);
            }
            
            // Load database stats (lightweight)
            const dbStats = await apiCall('/api/database/stats');
            if (dbStats.success && dbStats.stats.table_exists) {
                updateDatabaseStats(dbStats.stats);
            }
            
            // Load Docker status less frequently
            if (Math.random() < 0.3) { // Only 30% of the time
                const dockerStatus = await apiCall('/api/docker/status');
                if (dockerStatus.success) {
                    updateDockerStatus(dockerStatus.containers);
                }
            }
            
        } catch (error) {
            console.error('Dashboard data loading error:', error);
        }
    }
    
    function updateDockerStatus(containers) {
        // All services are now returned directly by the API with their service names
        const allServices = [
            'docker_engine',
            'relational_db',
            'vector_db', 
            'crawler',
            'llm_api',
            'web_server',
            'api_gateway',
            'intelligence_platform'
        ];
        
        let allRunning = true;
        let anyRunning = false;
        let runningCount = 0;
        let totalServices = allServices.length;
        
        allServices.forEach(serviceId => {
            const serviceData = containers[serviceId];
            const dot = document.getElementById(serviceId + '-dot');
            const text = document.getElementById(serviceId + '-text');
            const info = document.getElementById(serviceId + '-info');
            
            if (serviceData) {
                // Check service status based on health and status
                if (serviceData.status === 'running' || serviceData.health === 'healthy') {
                    dot.className = 'status-dot green';
                    text.textContent = 'Running';
                    anyRunning = true;
                    runningCount++;
                    
                    // Update service info with message and URLs when running
                    if (info) {
                        let infoText = serviceData.message || 'Service is running';
                        
                        // Add URLs for database interfaces
                        if (serviceId === 'relational_db') {
                            infoText += ' - pgAdmin: http://localhost:5050';
                        } else if (serviceId === 'vector_db') {
                            infoText += ' - Supabase Studio: http://localhost:54323';
                        } else if (serviceId === 'crawler') {
                            infoText += ' - API: http://localhost:11235';
                        } else if (serviceId === 'api_gateway') {
                            infoText += ' - Gateway: http://localhost:8000';
                        }
                        
                        info.textContent = infoText;
                    }
                } else if (serviceData.status === 'unavailable' || serviceData.health === 'unhealthy') {
                    dot.className = 'status-dot red';
                    text.textContent = 'Unavailable';
                    allRunning = false;
                    
                    if (info) {
                        info.textContent = serviceData.message || 'Service unavailable';
                    }
                } else if (serviceData.status === 'exited' || serviceData.status === 'stopped') {
                    dot.className = 'status-dot red';
                    text.textContent = 'Stopped';
                    allRunning = false;
                    
                    if (info) {
                        info.textContent = serviceData.message || 'Service stopped';
                    }
                } else {
                    dot.className = 'status-dot yellow';
                    text.textContent = serviceData.status || 'Unknown';
                    allRunning = false;
                    
                    if (info) {
                        info.textContent = serviceData.message || `Status: ${serviceData.status}`;
                    }
                }
            } else {
                dot.className = 'status-dot gray';
                text.textContent = 'Checking...';
                allRunning = false;
                
                if (info) {
                    info.textContent = 'Status checking...';
                }
            }
            
            // Individual start buttons have been permanently removed
            // Services can only be started via "Start All Services" button
        });
        
        // Calculate if all services are running
        allRunning = (runningCount === totalServices);
        console.log(`All running status: ${runningCount}/${totalServices} services running, allRunning=${allRunning}`);
        
        // Update toggle switch state based on service status
        updateServicesToggle(allRunning, anyRunning);
    }
    
    function updateDatabaseStats(stats) {
        // Main metrics
        document.getElementById('total-products').textContent = stats.total_products || 0;
        
        // Calculate success rate
        const successRate = stats.total_products > 0 && stats.failed_products !== undefined 
            ? (((stats.total_products - (stats.failed_products || 0)) / stats.total_products) * 100).toFixed(1) + '%'
            : '-';
        document.getElementById('success-rate').textContent = successRate;
        
        // Average processing time
        const avgTime = stats.average_scrape_time 
            ? formatProcessingDuration(stats.average_scrape_time)
            : '-';
        document.getElementById('avg-scrape-time').textContent = avgTime;
        
        document.getElementById('recent-products').textContent = stats.recent_additions_24h || 0;
        
        // Extended metrics
        const totalProcessingTime = stats.total_scrape_time 
            ? formatProcessingDuration(stats.total_scrape_time)
            : '-';
        document.getElementById('total-scrape-time').textContent = totalProcessingTime;
        
        document.getElementById('available-urls').textContent = stats.available_urls || '-';
        
        // Coverage percentage
        const coverage = stats.total_products > 0 && stats.available_urls > 0
            ? ((stats.total_products / stats.available_urls) * 100).toFixed(1) + '%'
            : '-';
        document.getElementById('url-coverage').textContent = coverage;
    }
    
    function formatProcessingDuration(seconds) {
        if (seconds < 1) return Math.round(seconds * 1000) + 'ms';
        if (seconds < 60) return seconds.toFixed(1) + 's';
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.round(seconds % 60);
        if (minutes < 60) return minutes + 'm ' + remainingSeconds + 's';
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = minutes % 60;
        return hours + 'h ' + remainingMinutes + 'm';
    }
    
    function updateSystemStats(stats) {
        if (!stats) return;
        
        // CPU Usage with smooth transitions
        const cpuPercent = Math.min(100, Math.max(0, stats.cpu_percent || 0));
        document.getElementById('cpu-usage').textContent = cpuPercent.toFixed(1) + '%';
        updateProgressBarSmoothly('cpu-progress', cpuPercent);
        document.getElementById('cpu-cores').textContent = stats.cpu_cores || '-';
        document.getElementById('cpu-load').textContent = stats.cpu_load_avg || '-';
        
        // Memory Usage with smooth transitions
        if (stats.memory) {
            const memoryPercent = Math.min(100, Math.max(0, stats.memory.percent || 0));
            const memoryUsed = formatBytes(stats.memory.total - stats.memory.available);
            const memoryTotal = formatBytes(stats.memory.total);
            const memoryAvailable = formatBytes(stats.memory.available);
            
            document.getElementById('memory-usage').textContent = memoryUsed + ' (' + memoryPercent.toFixed(1) + '%)';
            updateProgressBarSmoothly('memory-progress', memoryPercent);
            document.getElementById('memory-total').textContent = memoryTotal;
            document.getElementById('memory-available').textContent = memoryAvailable;
        }
        
        // Disk Usage with smooth transitions
        if (stats.disk) {
            const diskPercent = Math.min(100, Math.max(0, stats.disk.percent || 0));
            document.getElementById('disk-usage').textContent = diskPercent.toFixed(1) + '%';
            updateProgressBarSmoothly('disk-progress', diskPercent);
        }
        
        // Additional metrics
        document.getElementById('db-connections').textContent = stats.db_connections || '-';
        document.getElementById('system-uptime').textContent = stats.uptime ? formatDuration(stats.uptime) : '-';
    }
    
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    
    function updateProgressBarSmoothly(elementId, newPercent) {
        const progressBar = document.getElementById(elementId);
        if (!progressBar) return;
        
        const currentWidth = parseFloat(progressBar.style.width) || 0;
        const targetWidth = Math.min(100, Math.max(0, newPercent));
        
        // Only update if change is significant (prevents micro-jumps)
        if (Math.abs(targetWidth - currentWidth) > 0.5) {
            progressBar.style.width = targetWidth + '%';
        }
    }
    
    function updateSitemapStats(sitemapData) {
        const totalEl = document.getElementById('sitemap-total-count');
        const pendingEl = document.getElementById('sitemap-pending-count');
        const learnedEl = document.getElementById('sitemap-learned-count');
        const insertedEl = document.getElementById('sitemap-inserted-count');
        const messageEl = document.getElementById('sitemap-status-message');
        const completionRateEl = document.getElementById('sitemap-completion-rate');
        
        if (!sitemapData.success) {
            if (totalEl) totalEl.textContent = '-';
            if (pendingEl) pendingEl.textContent = '-';
            if (learnedEl) learnedEl.textContent = '-';
            if (insertedEl) insertedEl.textContent = '-';
            if (messageEl) messageEl.textContent = 'Error loading sitemap data';
            if (completionRateEl) completionRateEl.textContent = '0%';
            return;
        }
        
        const stats = sitemapData.stats;
        
        // Update sitemap download progress display to match backend status
        if (sitemapData.download_complete && sitemapData.download_progress === 100) {
            updateSitemapProgress('completed', 100, sitemapData.message || 'Download complete');
        } else if (sitemapData.download_progress > 0) {
            updateSitemapProgress('downloading', sitemapData.download_progress, sitemapData.message || 'Downloading...');
        }
        
        // Update sitemap URL display if we have a source URL from the downloaded sitemap
        if (stats && stats.source_url) {
            const sitemapDisplay = document.getElementById('sitemap-url');
            const sitemapStatus = document.getElementById('sitemap-status');
            const downloadBtn = document.getElementById('download-sitemap-btn');
            
            if (sitemapDisplay && sitemapDisplay.textContent.includes('Enter URL above')) {
                sitemapDisplay.textContent = stats.source_url;
                sitemapDisplay.style.color = '#10b981';
                if (sitemapStatus) sitemapStatus.innerHTML = `<span style="color: #10b981;">‚úì Sitemap found</span>`;
                if (downloadBtn) downloadBtn.disabled = false;
            }
        }
        
        // Store stats globally for use by other functions
        globalSitemapStats = stats;
        
        // Get counts from API
        const learned = stats.completed || 0;
        const inserted = stats.inserted || 0;
        
        // Update counts
        if (totalEl) totalEl.textContent = stats.total_urls.toLocaleString();
        if (pendingEl) pendingEl.textContent = stats.pending.toLocaleString();
        if (learnedEl) learnedEl.textContent = learned.toLocaleString();
        if (insertedEl) insertedEl.textContent = inserted.toLocaleString();
        
        // Update message
        if (messageEl) {
            if (sitemapData.status === 'not_found') {
                messageEl.textContent = 'No sitemap downloaded - click "Download Sitemap" first';
            } else if (sitemapData.status === 'empty') {
                messageEl.textContent = 'Sitemap downloaded but contains no product URLs';
            } else {
                messageEl.textContent = sitemapData.message || 'Sitemap ready for learning';
            }
        }
        
        // Update completion rate
        if (completionRateEl) {
            completionRateEl.textContent = stats.completion_rate + '%';
            
            // Color code the completion rate
            if (stats.completion_rate === 0) {
                completionRateEl.style.color = '#6b7280';
            } else if (stats.completion_rate < 50) {
                completionRateEl.style.color = '#f59e0b';
            } else if (stats.completion_rate < 100) {
                completionRateEl.style.color = '#3b82f6';
            } else {
                completionRateEl.style.color = '#10b981';
            }
        }
        
        // Update the "Start Learning" button state based on sitemap availability
        const startAcquisitionBtn = document.getElementById('start-acquisition');
        if (startAcquisitionBtn && sitemapData.status === 'not_found') {
            startAcquisitionBtn.title = 'Download a sitemap first to enable learning';
        } else if (startAcquisitionBtn) {
            startAcquisitionBtn.title = '';
        }
    }
    
    // Global variables for tracking
    let acquisitionStartTime = null;
    let lastUrlChange = null;
    let urlProcessingTimes = [];
    let etaInterval = null;
    
    function updateAcquisitionStatus(status) {
        acquisitionRunning = status.is_running;
        
        // Initialize start time if learning just started
        if (status.is_running && !acquisitionStartTime) {
            acquisitionStartTime = status.start_time ? new Date(status.start_time) : new Date();
        } else if (!status.is_running) {
            acquisitionStartTime = null;
            if (etaInterval) {
                clearInterval(etaInterval);
                etaInterval = null;
            }
        }
        
        document.getElementById('acquisition-status-text').textContent = 
            status.is_running ? 'Running' : 'Idle';
        
        document.getElementById('acquisition-mode-text').textContent = 
            status.mode || '-';
        
        // Stabilize progress percentage to prevent jumping
        const currentProgress = parseFloat((status.stats && status.stats.progress_percent) || 0);
        const displayProgress = Math.min(100, Math.max(0, currentProgress)); // Clamp between 0-100
        
        document.getElementById('acquisition-progress').textContent = 
            displayProgress.toFixed(1) + '%';
        
        // Smooth progress bar transitions
        const progressBar = document.getElementById('acquisition-progress-bar');
        if (progressBar) {
            const currentWidth = parseFloat(progressBar.style.width) || 0;
            const newWidth = displayProgress;
            
            // Only update if change is significant (prevents micro-jumps)
            if (Math.abs(newWidth - currentWidth) > 0.1) {
                progressBar.style.width = newWidth + '%';
            }
        }
        
        document.getElementById('acquisition-count').textContent = 
            (status.stats && status.stats.products_processed) || 0;
        
        document.getElementById('acquisition-total').textContent = 
            (status.stats && status.stats.estimated_total) || 0;
        
        document.getElementById('acquisition-success').textContent = 
            (status.stats && status.stats.success_count) || 0;
        
        document.getElementById('acquisition-errors').textContent = 
            (status.stats && status.stats.error_count) || 0;
        
        // Calculate and display runtime
        if (status.is_running) {
            let runtime = 0;
            
            if (acquisitionStartTime) {
                runtime = Math.floor((new Date() - acquisitionStartTime) / 1000);
            } else if (status.runtime_seconds) {
                runtime = Math.floor(status.runtime_seconds);
            }
            
            if (runtime > 0) {
                document.getElementById('acquisition-runtime').textContent = formatDuration(runtime);
                
                // Use rolling average read speed from API
                const avgReadSpeed = status.average_read_speed_pages_per_minute || 0;
                const successful = (status.stats && status.stats.success_count) || 0;
                
                // Update Average Read Speed
                if (avgReadSpeed > 0) {
                    document.getElementById('acquisition-speed').textContent = avgReadSpeed + ' pages/min';
                } else if (status.is_running && successful > 0) {
                    document.getElementById('acquisition-speed').textContent = 'Calculating...';
                } else if (!status.is_running && successful > 0) {
                    // When not running but has processed products, show completed status
                    document.getElementById('acquisition-speed').textContent = 'Completed';
                } else {
                    document.getElementById('acquisition-speed').textContent = 'Starting...';
                }
                
                // Update Counter (seconds since last read)
                const counterSeconds = status.counter_seconds_since_last_read || 0;
                if (status.is_running) {
                    document.getElementById('acquisition-counter').textContent = counterSeconds;
                } else {
                    document.getElementById('acquisition-counter').textContent = '--';
                }
                
                // Calculate ETA based on remaining items and average read speed
                if (avgReadSpeed > 0 && successful > 0) {
                    const remaining = ((status.stats && status.stats.estimated_total) || 0) - successful;
                    if (remaining > 0) {
                        const etaMinutes = Math.ceil(remaining / avgReadSpeed);
                        document.getElementById('acquisition-eta').textContent = 'ETA: ' + formatDuration(etaMinutes * 60);
                    } else {
                        document.getElementById('acquisition-eta').textContent = 'ETA: Complete';
                    }
                } else {
                    document.getElementById('acquisition-eta').textContent = 'ETA: Calculating...';
                }
            } else {
                document.getElementById('acquisition-runtime').textContent = 'Starting...';
                document.getElementById('acquisition-speed').textContent = 'Starting...';
                document.getElementById('acquisition-counter').textContent = '--';
                document.getElementById('acquisition-eta').textContent = 'ETA: Calculating...';
            }
        } else {
            // System is not running
            const successful = (status.stats && status.stats.success_count) || 0;
            
            document.getElementById('acquisition-runtime').textContent = '--';
            
            // Show "Completed" if we have processed products, otherwise show default
            if (successful > 0) {
                document.getElementById('acquisition-speed').textContent = 'Completed';
            } else {
                document.getElementById('acquisition-speed').textContent = '-- pages/min';
            }
            
            document.getElementById('acquisition-counter').textContent = '--';
            document.getElementById('acquisition-eta').textContent = 'ETA: --';
        }
        
        // Update current URL with visual feedback
        const currentUrlDiv = document.getElementById('current-url');
        const urlIndicator = document.getElementById('url-status-indicator');
        const previousUrl = currentUrlDiv.textContent;
        
        if (status.stats.current_url) {
            currentUrlDiv.textContent = status.stats.current_url;
            
            // Highlight URL change
            if (previousUrl !== status.stats.current_url && status.stats.current_url !== 'Starting learning...') {
                currentUrlDiv.style.backgroundColor = '#e3f2fd';
                urlIndicator.style.backgroundColor = '#4caf50';
                lastUrlChange = new Date();
                
                // Reset highlight after 2 seconds
                setTimeout(() => {
                    currentUrlDiv.style.backgroundColor = '#f3f4f6';
                    urlIndicator.style.backgroundColor = '#2196f3';
                }, 2000);
                
                // Track URL processing time for better ETA calculation
                if (urlProcessingTimes.length > 0) {
                    const processingTime = (new Date() - lastUrlChange) / 1000;
                    urlProcessingTimes.push(processingTime);
                    // Keep only last 10 measurements
                    if (urlProcessingTimes.length > 10) {
                        urlProcessingTimes = urlProcessingTimes.slice(-10);
                    }
                }
            }
        } else if (status.is_running) {
            currentUrlDiv.textContent = 'Starting learning...';
            urlIndicator.style.backgroundColor = '#ff9800';
        } else {
            // Check if sitemap is ready by looking at estimated_total
            if (status.stats && status.stats.estimated_total && status.stats.estimated_total > 0) {
                currentUrlDiv.textContent = 'Ready to learn';
                urlIndicator.style.backgroundColor = '#4caf50';
            } else {
                currentUrlDiv.textContent = 'Waiting for learning...';
                urlIndicator.style.backgroundColor = '#ccc';
            }
        }
        
        // Update buttons
        const startButton = document.getElementById('start-acquisition');
        const stopButton = document.getElementById('stop-acquisition');
        
        if (startButton) {
            startButton.disabled = status.is_running;
            
            // Update button text when learning actually starts
            if (status.is_running && (startButton.innerHTML.includes('Initiating') || 
                                      startButton.innerHTML.includes('Initializing') || 
                                      startButton.innerHTML.includes('Loading'))) {
                startButton.innerHTML = '<i class="fas fa-pause"></i> Learning Active';
                showAlert('AI learning process is now active!', 'success');
            } else if (!status.is_running && startButton.innerHTML.includes('Learning Active')) {
                startButton.innerHTML = '<i class="fas fa-play"></i> Start Learning';
            }
        }
        if (stopButton) {
            stopButton.disabled = !status.is_running;
        }
        
        // Update activity log
        if (status.recent_logs && status.recent_logs.length > 0) {
            updateActivityLog(status.recent_logs);
        }
        
        // Start ETA update interval if not already running
        if (status.is_running && !etaInterval) {
            etaInterval = setInterval(() => {
                if (acquisitionStartTime) {
                    const runtime = Math.floor((new Date() - acquisitionStartTime) / 1000);
                    document.getElementById('acquisition-runtime').textContent = formatDuration(runtime);
                }
            }, 1000);
        }
    }
    
    function formatDuration(seconds) {
        if (seconds < 60) return seconds + 's';
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        if (minutes < 60) return minutes + 'm ' + remainingSeconds + 's';
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = minutes % 60;
        return hours + 'h ' + remainingMinutes + 'm';
    }
    
    function updateActivityLog(logs) {
        const logDiv = document.getElementById('activity-log');
        const logLines = logs.map(log => 
            `[${new Date(log.timestamp).toLocaleTimeString()}] ${log.message}`
        ).join('\n');
        
        logDiv.textContent = logLines;
        logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    async function startContainer(name) {
        showLoading(`Starting ${name}...`);
        const result = await apiCall(`/api/docker/start/${name}`, 'POST');
        hideLoading();
        
        if (result.success) {
            showAlert(result.message, 'success');
        } else {
            showAlert(result.error, 'error');
        }
        
        setTimeout(loadDashboardData, 2000);
    }
    
    async function stopContainer(name) {
        if (!confirm(`Are you sure you want to stop ${name}?`)) return;
        
        showLoading(`Stopping ${name}...`);
        const result = await apiCall(`/api/docker/stop/${name}`, 'POST');
        hideLoading();
        
        if (result.success) {
            showAlert(result.message, 'success');
        } else {
            showAlert(result.error, 'error');
        }
        
        setTimeout(loadDashboardData, 2000);
    }
    
    async function startAllContainers() {
        showLoading('Starting all containers...');
        const result = await apiCall('/api/docker/start-all', 'POST');
        hideLoading();
        
        if (result.success) {
            showAlert(result.message, 'success');
        } else {
            showAlert(result.error, 'error');
        }
        
        setTimeout(loadDashboardData, 3000);
    }
    
    async function stopAllContainers() {
        if (!confirm('Are you sure you want to stop all containers?')) return;
        
        showLoading('Stopping all containers...');
        const result = await apiCall('/api/docker/stop-all', 'POST');
        hideLoading();
        
        if (result.success) {
            showAlert(result.message, 'success');
        } else {
            showAlert(result.error, 'error');
        }
        
        setTimeout(loadDashboardData, 3000);
    }
    
    async function loadCategorySelectionData() {
        try {
            const response = await fetch('/category_selection.json');
            const categoryData = await response.json();
            
            const categorySelect = document.getElementById('acquisition-category');
            categorySelect.innerHTML = '<option value="">Select a category...</option>';
            
            categoryData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = `${category.name} (${category.count.toLocaleString()} products - ${category.percentage}%)`;
                categorySelect.appendChild(option);
            });
            
            // Set up mode change handler
            const modeSelect = document.getElementById('acquisition-mode');
            modeSelect.addEventListener('change', function() {
                const categoryGroup = document.getElementById('category-selection-group');
                if (this.value === 'category') {
                    categoryGroup.style.display = 'block';
                } else {
                    categoryGroup.style.display = 'none';
                }
            });
            
        } catch (error) {
            console.error('Failed to load category data:', error);
            const categorySelect = document.getElementById('acquisition-category');
            categorySelect.innerHTML = '<option value="">Error loading categories</option>';
        }
    }
    
    async function startAcquisition() {
        const startBtn = document.getElementById('start-acquisition');
        const stopBtn = document.getElementById('stop-acquisition');
        
        // Immediate feedback - show button is working
        const originalText = startBtn.innerHTML;
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking system...';
        
        try {
            // First check if system is pre-warmed
            showAlert('Checking system pre-warm status...', 'info');
            const prewarmStatus = await apiCall('/api/acquisition/prewarm-status');
            
            if (prewarmStatus.success) {
                // If system is not ready, trigger pre-warming
                if (!prewarmStatus.is_prewarmed) {
                    startBtn.innerHTML = '<i class="fas fa-thermometer-half fa-spin"></i> Pre-warming...';
                    showAlert('System not ready - starting pre-warming process...', 'info');
                    
                    // Show the pre-warming status container
                    const container = document.getElementById('prewarm-status-container');
                    if (container) {
                        container.style.display = 'block';
                    }
                    
                    // Start pre-warming process
                    const prewarmResult = await apiCall('/api/acquisition/prewarm', 'POST');
                    
                    if (prewarmResult.success) {
                        showAlert('Pre-warming started - waiting for completion...', 'info');
                        
                        // Wait for pre-warming to complete
                        await waitForPrewarmCompletion();
                        
                        // After pre-warming is complete, proceed with learning
                        startBtn.innerHTML = '<i class="fas fa-rocket fa-spin"></i> Starting Learning...';
                        showAlert('Pre-warming complete - starting learning process...', 'success');
                    } else {
                        throw new Error('Failed to start pre-warming: ' + prewarmResult.error);
                    }
                } else {
                    // System is already ready
                    startBtn.innerHTML = '<i class="fas fa-rocket fa-spin"></i> Starting Learning...';
                    showAlert('System ready - starting learning process...', 'info');
                }
            } else {
                // Can't check prewarm status, proceed anyway
                startBtn.innerHTML = '<i class="fas fa-rocket fa-spin"></i> Starting Learning...';
                showAlert('Unable to check pre-warm status - proceeding with learning...', 'warning');
            }
            
            // Now start the actual learning process
            const mode = document.getElementById('acquisition-mode').value;
            const limit = document.getElementById('acquisition-limit').value;
            const fresh = document.getElementById('acquisition-fresh').checked;
            const batchSize = document.getElementById('acquisition-batch-size').value;
            const category = document.getElementById('acquisition-category').value;
            
            const data = { mode, fresh };
            if (mode === 'test' && limit) {
                data.limit = parseInt(limit);
            }
            if (mode === 'category' && category) {
                data.category = category;
            }
            if (batchSize) {
                data.batch_size = parseInt(batchSize);
            }
            
            const result = await apiCall('/api/acquisition/start', 'POST', data);
            
            if (result.success) {
                // Update to show initialization phase
                startBtn.innerHTML = '<i class="fas fa-cog fa-spin"></i> Initializing...';
                showAlert('Learning subprocess starting - initializing environment...', 'info');
                stopBtn.disabled = false;
                
                // Add more detailed feedback
                setTimeout(() => {
                    if (startBtn.innerHTML.includes('Initializing')) {
                        startBtn.innerHTML = '<i class="fas fa-brain fa-spin"></i> Loading AI...';
                        showAlert('Setting up AI learning environment...', 'info');
                    }
                }, 3000);
                
                setTimeout(() => {
                    if (startBtn.innerHTML.includes('Loading')) {
                        showAlert('AI learning process should begin shortly...', 'info');
                    }
                }, 6000);
                
            } else {
                // Reset button on error
                startBtn.disabled = false;
                startBtn.innerHTML = originalText;
                showAlert(result.error, 'error');
            }
        } catch (error) {
            // Reset button on API error
            startBtn.disabled = false;
            startBtn.innerHTML = originalText;
            showAlert('Failed to start learning: ' + error.message, 'error');
        }
        
        setTimeout(loadDashboardData, 1000);
    }
    
    // Helper function to wait for pre-warming completion
    async function waitForPrewarmCompletion() {
        return new Promise((resolve, reject) => {
            const checkInterval = setInterval(async () => {
                try {
                    const status = await apiCall('/api/acquisition/prewarm-status');
                    if (status.success) {
                        if (!status.prewarm_in_progress && status.is_prewarmed) {
                            clearInterval(checkInterval);
                            resolve();
                        } else if (!status.prewarm_in_progress && !status.is_prewarmed) {
                            clearInterval(checkInterval);
                            reject(new Error('Pre-warming failed: System not ready'));
                        }
                        // Continue waiting if still pre-warming
                    }
                } catch (error) {
                    clearInterval(checkInterval);
                    reject(error);
                }
            }, 1000);
            
            // Timeout after 5 minutes
            setTimeout(() => {
                clearInterval(checkInterval);
                reject(new Error('Pre-warming timed out after 5 minutes'));
            }, 300000);
        });
    }
    
    async function stopAcquisition() {
        if (!confirm('Are you sure you want to stop the learning process?')) return;
        
        const result = await apiCall('/api/acquisition/stop', 'POST');
        
        if (result.success) {
            showAlert(result.message, 'success');
        } else {
            showAlert(result.error, 'error');
        }
        
        setTimeout(loadDashboardData, 1000);
    }
    
    async function showLogs(containerName) {
        document.getElementById('logs-title').textContent = `${containerName} Logs`;
        document.getElementById('logs-modal').classList.add('active');
        document.getElementById('logs-content').textContent = 'Loading logs...';
        
        const result = await apiCall(`/api/docker/logs/${containerName}`);
        
        if (result.success) {
            document.getElementById('logs-content').textContent = result.logs;
        } else {
            document.getElementById('logs-content').textContent = 'Error loading logs: ' + result.error;
        }
    }
    
    // Standardized Diagnostic Functions (Phase 2)
    async function checkServiceHealth(serviceName) {
        showNotification(`Checking health for ${serviceName}...`, 'info');
        const result = await apiCall(`/api/service/${serviceName}/health`);
        
        if (result.success) {
            const health = result.health;
            const status = health.success ? 'healthy' : 'issues';
            const message = health.message || health.error || 'Health check completed';
            showNotification(`${serviceName}: ${message}`, status === 'healthy' ? 'success' : 'error');
            
            // Update UI elements
            updateServiceStatus(serviceName, status, message);
        } else {
            showNotification(`Health check failed for ${serviceName}: ${result.error}`, 'error');
        }
    }
    
    async function showServiceLogs(serviceName) {
        document.getElementById('logs-title').textContent = `${serviceName} Logs`;
        document.getElementById('logs-modal').classList.add('active');
        document.getElementById('logs-content').textContent = 'Loading logs...';
        
        const result = await apiCall(`/api/service/${serviceName}/logs`);
        
        if (result.success) {
            const logs = result.logs;
            document.getElementById('logs-content').textContent = logs.logs || logs.message || 'No logs available';
        } else {
            document.getElementById('logs-content').textContent = 'Error loading logs: ' + result.error;
        }
    }
    
    async function debugService(serviceName) {
        showNotification(`Running debug panel for ${serviceName}...`, 'info');
        const result = await apiCall(`/api/service/${serviceName}/debug`);
        
        if (result.success) {
            const debug = result.debug;
            const debugInfo = debug.debug_info || debug;
            showNotification(`Debug info retrieved for ${serviceName}`, 'success');
            
            // Show debug info in a formatted alert or modal
            const debugText = JSON.stringify(debugInfo, null, 2);
            alert(`Debug Info for ${serviceName}:\n\n${debugText}`);
        } else {
            showNotification(`Debug failed for ${serviceName}: ${result.error}`, 'error');
        }
    }
    
    // Runtime Environment Functions
    async function checkRuntimeHealth(componentName) {
        showNotification(`Checking runtime health for ${componentName}...`, 'info');
        const result = await apiCall(`/api/service/${componentName}/health`);
        
        if (result.success) {
            const health = result.health;
            const status = health.success ? 'healthy' : 'issues';
            const message = health.message || health.error || 'Runtime check completed';
            showNotification(`${componentName}: ${message}`, status === 'healthy' ? 'success' : 'error');
            
            updateRuntimeStatus(componentName, status, message);
        } else {
            showNotification(`Runtime health check failed for ${componentName}: ${result.error}`, 'error');
        }
    }
    
    async function showRuntimeLogs(componentName) {
        document.getElementById('logs-title').textContent = `${componentName} Runtime Logs`;
        document.getElementById('logs-modal').classList.add('active');
        document.getElementById('logs-content').textContent = 'Loading runtime logs...';
        
        const result = await apiCall(`/api/service/${componentName}/logs`);
        
        if (result.success) {
            const logs = result.logs;
            document.getElementById('logs-content').textContent = logs.logs || logs.message || 'No runtime logs available';
        } else {
            document.getElementById('logs-content').textContent = 'Error loading runtime logs: ' + result.error;
        }
    }
    
    async function debugRuntime(componentName) {
        showNotification(`Running runtime debug for ${componentName}...`, 'info');
        const result = await apiCall(`/api/service/${componentName}/debug`);
        
        if (result.success) {
            const debug = result.debug;
            const debugInfo = debug.debug_info || debug;
            showNotification(`Runtime debug info retrieved for ${componentName}`, 'success');
            
            const debugText = JSON.stringify(debugInfo, null, 2);
            alert(`Runtime Debug Info for ${componentName}:\n\n${debugText}`);
        } else {
            showNotification(`Runtime debug failed for ${componentName}: ${result.error}`, 'error');
        }
    }
    
    // Pre-warming System Functions
    async function checkPrewarmHealth(systemName) {
        showNotification(`Checking pre-warming health for ${systemName}...`, 'info');
        const result = await apiCall(`/api/service/${systemName}/health`);
        
        if (result.success) {
            const health = result.health;
            const status = health.status === 'ready' ? 'ready' : 'not_ready';
            const message = health.message || health.error || 'Pre-warming check completed';
            showNotification(`${systemName}: ${message}`, status === 'ready' ? 'success' : 'warning');
            
            updatePrewarmStatus(systemName, status, message);
        } else {
            showNotification(`Pre-warming health check failed for ${systemName}: ${result.error}`, 'error');
        }
    }
    
    async function showPrewarmLogs(systemName) {
        document.getElementById('logs-title').textContent = `${systemName} Pre-warming Logs`;
        document.getElementById('logs-modal').classList.add('active');
        document.getElementById('logs-content').textContent = 'Loading pre-warming logs...';
        
        const result = await apiCall(`/api/service/${systemName}/logs`);
        
        if (result.success) {
            const logs = result.logs;
            document.getElementById('logs-content').textContent = logs.logs || logs.message || 'No pre-warming logs available';
        } else {
            document.getElementById('logs-content').textContent = 'Error loading pre-warming logs: ' + result.error;
        }
    }
    
    async function debugPrewarm(systemName) {
        showNotification(`Running pre-warming debug for ${systemName}...`, 'info');
        const result = await apiCall(`/api/service/${systemName}/debug`);
        
        if (result.success) {
            const debug = result.debug;
            const debugInfo = debug.debug_info || debug;
            showNotification(`Pre-warming debug info retrieved for ${systemName}`, 'success');
            
            const debugText = JSON.stringify(debugInfo, null, 2);
            alert(`Pre-warming Debug Info for ${systemName}:\n\n${debugText}`);
        } else {
            showNotification(`Pre-warming debug failed for ${systemName}: ${result.error}`, 'error');
        }
    }
    
    // Helper functions for updating UI status
    function updateServiceStatus(serviceName, status, message) {
        const dot = document.getElementById(`${serviceName}-dot`);
        const text = document.getElementById(`${serviceName}-text`);
        const info = document.getElementById(`${serviceName}-info`);
        
        if (dot) {
            dot.className = `status-dot ${status === 'healthy' ? 'green' : 'red'}`;
        }
        if (text) {
            text.textContent = status === 'healthy' ? 'Online' : 'Issues';
        }
        if (info) {
            info.textContent = message;
        }
    }
    
    function updateRuntimeStatus(componentName, status, message) {
        const dot = document.getElementById(`${componentName}-runtime-dot`);
        const text = document.getElementById(`${componentName}-runtime-text`);
        const info = document.getElementById(`${componentName}-runtime-info`);
        
        if (dot) {
            dot.className = `status-dot ${status === 'healthy' ? 'green' : 'red'}`;
        }
        if (text) {
            text.textContent = status === 'healthy' ? 'Ready' : 'Issues';
        }
        if (info) {
            info.textContent = message;
        }
    }
    
    function updatePrewarmStatus(systemName, status, message) {
        const dot = document.getElementById(`${systemName}-prewarm-dot`);
        const text = document.getElementById(`${systemName}-prewarm-text`);
        const info = document.getElementById(`${systemName}-prewarm-info`);
        
        if (dot) {
            dot.className = `status-dot ${status === 'ready' ? 'green' : 'yellow'}`;
        }
        if (text) {
            text.textContent = status === 'ready' ? 'Ready' : 'Not Ready';
        }
        if (info) {
            info.textContent = message;
        }
    }
    
    function closeLogs() {
        document.getElementById('logs-modal').classList.remove('active');
    }
    
    async function viewProducts() {
        document.getElementById('products-modal').classList.add('active');
        loadProductsTable();
    }
    
    async function loadProductsTable() {
        document.getElementById('products-table').innerHTML = 'Loading products...';
        
        // Add cache-busting timestamp to force fresh data
        const timestamp = new Date().getTime();
        const result = await apiCall(`/api/database/products?limit=50&_t=${timestamp}`);
        
        if (result.success) {
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: #f3f4f6;">';
            html += '<th style="padding: 0.5rem; border: 1px solid #d1d5db;">SKU</th>';
            html += '<th style="padding: 0.5rem; border: 1px solid #d1d5db;">Title</th>';
            html += '<th style="padding: 0.5rem; border: 1px solid #d1d5db;">$/SF</th>';
            html += '<th style="padding: 0.5rem; border: 1px solid #d1d5db;">$/BX</th>';
            html += '<th style="padding: 0.5rem; border: 1px solid #d1d5db;">$/EA</th>';
            html += '<th style="padding: 0.5rem; border: 1px solid #d1d5db;">Learned Date & Time</th>';
            html += '</tr>';
            
            result.products.forEach(product => {
                html += '<tr>';
                html += `<td style="padding: 0.5rem; border: 1px solid #d1d5db;">${product.sku || ''}</td>`;
                html += `<td style="padding: 0.5rem; border: 1px solid #d1d5db;">${(product.title || '').substring(0, 50)}...</td>`;
                html += `<td style="padding: 0.5rem; border: 1px solid #d1d5db;">${product.price_per_sqft ? '$' + parseFloat(product.price_per_sqft).toFixed(2) : 'N/A'}</td>`;
                html += `<td style="padding: 0.5rem; border: 1px solid #d1d5db;">${product.price_per_box ? '$' + parseFloat(product.price_per_box).toFixed(2) : 'N/A'}</td>`;
                html += `<td style="padding: 0.5rem; border: 1px solid #d1d5db;">${product.price_per_piece ? '$' + parseFloat(product.price_per_piece).toFixed(2) : 'N/A'}</td>`;
                html += `<td style="padding: 0.5rem; border: 1px solid #d1d5db;">${product.scraped_at ? new Date(product.scraped_at).toLocaleString('en-US', {timeZone: 'America/New_York'}) : ''}</td>`;
                html += '</tr>';
            });
            
            html += '</table>';
            document.getElementById('products-table').innerHTML = html;
        } else {
            document.getElementById('products-table').innerHTML = 'Error loading products: ' + result.error;
        }
    }
    
    function closeProducts() {
        document.getElementById('products-modal').classList.remove('active');
    }
    
    async function exportProducts() {
        showLoading('Exporting products...');
        window.location.href = '/api/database/export?format=csv';
        hideLoading();
    }
    
    function refreshStatus() {
        loadDashboardData();
        showAlert('Status refreshed', 'success');
    }
    
    // Services Toggle Functions
    function updateServicesToggle(allRunning, anyRunning) {
        const toggleSwitch = document.querySelector('.toggle-switch');
        if (!toggleSwitch) return;
        
        // Update toggle state
        if (allRunning) {
            toggleSwitch.classList.add('on');
            toggleSwitch.classList.remove('disabled');
        } else if (anyRunning) {
            // Some services running - show as disabled/mixed state
            toggleSwitch.classList.remove('on');
            toggleSwitch.classList.add('disabled');
        } else {
            // All services stopped
            toggleSwitch.classList.remove('on', 'disabled');
        }
    }
    
    async function toggleAllServices() {
        const toggleSwitch = document.querySelector('.toggle-switch');
        if (toggleSwitch.classList.contains('disabled')) {
            // Don't allow toggle when in mixed state
            showAlert('Please wait for all services to finish starting or stopping', 'warning');
            return;
        }
        
        const isCurrentlyOn = toggleSwitch.classList.contains('on');
        
        if (isCurrentlyOn) {
            // Turn OFF - stop all services
            await stopAllServices();
        } else {
            // Turn ON - start all services  
            await startAllServices();
        }
    }
    
    // Sync Management Functions
    function updateSyncStatus(status) {
        const sourceStatus = document.getElementById('source-status');
        const targetStatus = document.getElementById('target-status');
        const syncReady = document.getElementById('sync-ready');
        const lastSync = document.getElementById('last-sync');
        
        if (status.connections) {
            const source = status.connections.source;
            const target = status.connections.target;
            
            sourceStatus.textContent = source ? 
                (source.connected ? `‚úì Connected (${source.product_count} products)` : `‚úó ${source.message}`) :
                'Unknown';
                
            targetStatus.textContent = target ? 
                (target.connected ? `‚úì Connected (${target.product_count} products)` : `‚úó ${target.message}`) :
                'Unknown';
                
            syncReady.textContent = status.ready_to_sync ? '‚úì Ready' : '‚úó Not Ready';
        }
        
        if (status.stats && status.stats.last_sync_time) {
            lastSync.textContent = new Date(status.stats.last_sync_time).toLocaleString();
        } else {
            lastSync.textContent = 'Never';
        }
    }
    
    async function testSyncConnections() {
        showLoading('Testing connections...');
        const result = await apiCall('/api/sync/test-connections');
        hideLoading();
        
        if (result.success) {
            updateSyncStatus({ connections: result.connections, ready_to_sync: 
                result.connections.source?.connected && result.connections.target?.connected });
            showAlert('Connection test completed', 'success');
        } else {
            showAlert('Connection test failed: ' + result.error, 'error');
        }
    }
    
    async function syncData() {
        if (!confirm('Sync data from Postgres to Supabase? This may take a few minutes.')) {
            return;
        }
        
        const forceFullSync = document.getElementById('force-full-sync').checked;
        
        showLoading('Syncing data...');
        const result = await apiCall('/api/sync/sync-data', 'POST', { 
            force_full_sync: forceFullSync 
        });
        hideLoading();
        
        if (result.success) {
            showAlert(`Sync completed: ${result.synced_count} new, ${result.updated_count} updated`, 'success');
            loadDashboardData(); // Refresh stats
        } else {
            showAlert('Sync failed: ' + result.error, 'error');
        }
    }
    
    async function showSyncComparison() {
        const result = await apiCall('/api/sync/comparison');
        
        if (result.success) {
            const comp = result.comparison;
            const message = `Data Comparison:
Source: ${comp.source_count} products
Target: ${comp.target_count} products
Sync: ${comp.sync_percentage}% (${comp.missing_count} missing)
Status: ${comp.is_in_sync ? 'In Sync' : 'Out of Sync'}`;
            
            alert(message);
        } else {
            showAlert('Comparison failed: ' + result.error, 'error');
        }
    }
    
    // Handle real-time updates from WebSocket
    function handlePageStatusUpdate(data) {
        if (data.docker) {
            updateDockerStatus(data.docker);
        }
        if (data.acquisition) {
            updateAcquisitionStatus(data.acquisition);
        }
    }
    
    // Handle learning progress updates
    if (socket) {
        socket.on('acquisition_progress', function(data) {
            if (data.type === 'log') {
                const logDiv = document.getElementById('activity-log');
                logDiv.innerHTML += `\n[${new Date().toLocaleTimeString()}] ${data.data.line}`;
                logDiv.scrollTop = logDiv.scrollHeight;
                
                // Update acquisition status directly from WebSocket data if available
                if (data.data && data.data.stats) {
                    // Create enhanced status object for real-time updates
                    const enhancedStatus = {
                        is_running: true, // We know it's running if we're getting logs
                        stats: data.data.stats
                    };
                    updateAcquisitionStatus(enhancedStatus);
                }
                
                // Also trigger sitemap status refresh
                loadSitemapStatus();
            } else if (data.type === 'completed') {
                loadDashboardData();
                showAlert('Learning completed', 'success');
                
                // Refresh all status after completion
                loadAcquisitionStatus();
                loadSitemapStatus();
            }
        });
    }
    
    // Environment Management Functions
    async function updateEnvironmentStatus() {
        try {
            // Check environment status
            const envStatus = await apiCall('/api/environment/status');
            
            if (envStatus.success) {
                const status = envStatus.status;
                
                // Python Environment
                updateStatusIndicator('python-env', status.python_env.status, 
                    status.python_env.message, status.python_env.details);
                
                // Dependencies
                updateStatusIndicator('dependencies', status.dependencies.status,
                    status.dependencies.message, status.dependencies.details);
                
                // Docker Daemon
                updateStatusIndicator('docker-daemon', status.docker_daemon.status,
                    status.docker_daemon.message, status.docker_daemon.details);
                
                // Infrastructure (containers)
                updateStatusIndicator('infrastructure', status.infrastructure.status,
                    status.infrastructure.message, status.infrastructure.details);
            }
        } catch (error) {
            console.error('Error checking environment status:', error);
            // Hide progress bars on error
            ['python-env', 'dependencies', 'docker-daemon', 'infrastructure'].forEach(envId => {
                hideEnvironmentProgress(envId);
            });
        }
    }
    
    function updateStatusIndicator(prefix, status, message, details) {
        const dot = document.getElementById(prefix + '-dot');
        const text = document.getElementById(prefix + '-text');
        const detailsEl = document.getElementById(prefix + '-details');
        
        // Update status dot color
        if (dot) {
            dot.className = 'status-dot ' + (status === 'healthy' ? 'green' : 
                                           status === 'warning' ? 'yellow' : 
                                           status === 'running' ? 'green' :
                                           status === 'partial' ? 'yellow' : 'red');
        }
        
        // Update text and details
        if (text) text.textContent = message;
        if (detailsEl) detailsEl.textContent = details;
        
        console.log(`Updated ${prefix}: status=${status}, message=${message}`);
    }
    
    async function startAllInfrastructure() {
        showLoading('Setting up complete infrastructure...');
        
        try {
            // Step 1: Setup environment
            const envResult = await apiCall('/api/environment/setup', 'POST');
            if (!envResult.success) {
                throw new Error('Environment setup failed: ' + envResult.error);
            }
            
            // Step 2: Start Docker containers
            const dockerResult = await apiCall('/api/docker/start-all', 'POST');
            if (!dockerResult.success) {
                throw new Error('Container startup failed: ' + dockerResult.error);
            }
            
            // Step 3: Verify all services
            await new Promise(resolve => setTimeout(resolve, 5000)); // Wait for services to start
            
            showAlert('Infrastructure started successfully!', 'success');
            
        } catch (error) {
            showAlert(error.message, 'error');
        } finally {
            hideLoading();
            setTimeout(loadDashboardData, 2000);
            setTimeout(updateEnvironmentStatus, 2000);
        }
    }
    
    async function setupEnvironment() {
        showLoading('Setting up Python environment and dependencies...');
        
        try {
            const result = await apiCall('/api/environment/setup', 'POST');
            
            if (result.success) {
                showAlert('Environment setup completed successfully!', 'success');
            } else {
                showAlert('Environment setup failed: ' + result.error, 'error');
            }
        } catch (error) {
            showAlert('Error setting up environment: ' + error.message, 'error');
        } finally {
            hideLoading();
            setTimeout(updateEnvironmentStatus, 2000);
        }
    }
    
    // Update loadDashboardData to include environment status
    const originalLoadDashboardData = loadDashboardData;
    loadDashboardData = async function() {
        await originalLoadDashboardData();
        await updateEnvironmentStatus();
        await updatePrewarmStatus();
    };
    
    // Pre-warming Status Functions
    let prewarmInterval = null;
    
    async function updatePrewarmStatus() {
        try {
            const prewarmStatus = await apiCall('/api/acquisition/prewarm-status');
            
            if (prewarmStatus.success) {
                const container = document.getElementById('prewarm-status-container');
                
                // Always show the pre-warming container (requested change)
                container.style.display = 'block';
                
                // Update overall status
                updatePrewarmOverallStatus(prewarmStatus);
                
                // Get database connection status from system stats
                const systemStats = await apiCall('/api/system/stats');
                let relationalDbStatus = false;
                let vectorDbStatus = false;
                
                if (systemStats.success && systemStats.stats.db_connections) {
                    const dbConnections = systemStats.stats.db_connections;
                    if (typeof dbConnections === 'string' && dbConnections.includes('/')) {
                        const [connected, total] = dbConnections.split('/').map(n => parseInt(n));
                        relationalDbStatus = connected >= 1; // At least one database connected
                        vectorDbStatus = connected >= 2; // Both databases connected
                    }
                }
                
                // Update individual component status
                updatePrewarmComponent('subprocess', prewarmStatus.prewarm_status.virtual_env);
                updatePrewarmComponent('relational-db', relationalDbStatus);
                updatePrewarmComponent('vector-db', vectorDbStatus);
                updatePrewarmComponent('sitemap', prewarmStatus.prewarm_status.sitemap_validation);
                updatePrewarmComponent('crawl4ai', prewarmStatus.prewarm_status.crawl4ai_service);
                
                // Update progress if pre-warming is active
                if (prewarmStatus.prewarm_in_progress) {
                    // Show progress during active pre-warming
                    updatePrewarmProgress(50); // Approximate progress
                    
                    // Start interval for updates if not already running
                    if (!prewarmInterval) {
                        prewarmInterval = setInterval(updatePrewarmStatus, 1000);
                    }
                } else {
                    // Stop interval if pre-warming is complete
                    if (prewarmInterval) {
                        clearInterval(prewarmInterval);
                        prewarmInterval = null;
                    }
                }
            }
        } catch (error) {
            console.error('Error checking prewarm status:', error);
            
            // Hide container on error
            const container = document.getElementById('prewarm-status-container');
            if (container) {
                container.style.display = 'none';
            }
        }
    }
    
    function updatePrewarmOverallStatus(status) {
        const overallStatusEl = document.getElementById('prewarm-overall-status');
        if (!overallStatusEl) return;
        
        if (status.prewarm_in_progress) {
            overallStatusEl.textContent = 'Pre-warming...';
            overallStatusEl.style.color = '#f59e0b';
        } else if (status.is_prewarmed) {
            overallStatusEl.textContent = 'Ready';
            overallStatusEl.style.color = '#10b981';
        } else {
            // Check how many components are ready
            const components = status.prewarm_status;
            const readyCount = Object.values(components).filter(Boolean).length;
            const totalCount = Object.keys(components).length;
            
            if (readyCount > 0) {
                overallStatusEl.textContent = `Partially Ready (${readyCount}/${totalCount})`;
                overallStatusEl.style.color = '#f59e0b';
            } else {
                overallStatusEl.textContent = 'Not Ready';
                overallStatusEl.style.color = '#ef4444';
            }
        }
    }
    
    function updatePrewarmComponent(componentName, componentStatus) {
        const dot = document.getElementById(`prewarm-${componentName}-dot`);
        const text = document.getElementById(`prewarm-${componentName}-text`);
        
        if (!dot || !text) return;
        
        // Update status dot color based on boolean status
        dot.className = 'status-dot ' + (componentStatus ? 'green' : 'red');
        
        // Update text with detailed status (similar to Runtime Environment Status)
        const baseText = getComponentDisplayName(componentName);
        const statusText = componentStatus ? 'Ready' : 'Error';
        text.textContent = `${baseText} ${componentStatus ? '‚úì' : '‚úó'} ${statusText}`;
    }
    
    function getComponentDisplayName(componentName) {
        const names = {
            'subprocess': 'Python subprocess startup',
            'relational-db': 'relational_db',
            'vector-db': 'vector_db',
            'sitemap': 'Sitemap validation',
            'crawl4ai': 'Crawler service'
        };
        return names[componentName] || componentName;
    }
    
    function updatePrewarmProgress(percentage) {
        const progressContainer = document.getElementById('prewarm-progress-container');
        const progressBar = document.getElementById('prewarm-progress-bar');
        const progressText = document.getElementById('prewarm-progress-text');
        
        if (progressContainer && progressBar && progressText) {
            progressContainer.style.display = 'block';
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}%`;
        }
    }
    
    // Unified Service Management Functions
    async function startAllServices() {
        setBulkOperationStatus('Starting all services...', 'info');
        
        try {
            const containers = ['relational_db', 'vector_db', 'crawler'];
            const results = [];
            
            for (const container of containers) {
                try {
                    const result = await apiCall(`/api/docker/start/${container}`, 'POST');
                    results.push({ container, success: result.success, message: result.message });
                } catch (error) {
                    results.push({ container, success: false, message: error.message });
                }
            }
            
            const successCount = results.filter(r => r.success).length;
            const totalServices = 8; // Total services in microservices directory
            const message = `Started ${successCount}/${containers.length} container services (${totalServices} total services)`;
            
            setBulkOperationStatus(message, successCount === containers.length ? 'success' : 'warning');
            setTimeout(() => setBulkOperationStatus('', ''), 3000);
            
        } catch (error) {
            setBulkOperationStatus('Failed to start services', 'error');
            setTimeout(() => setBulkOperationStatus('', ''), 3000);
        }
        
        setTimeout(loadDashboardData, 2000);
    }
    
    async function stopAllServices() {
        if (!confirm('Are you sure you want to stop all services?')) return;
        
        setBulkOperationStatus('Stopping all services...', 'info');
        
        try {
            const containers = ['relational_db', 'vector_db', 'crawler'];
            const results = [];
            
            for (const container of containers) {
                try {
                    const result = await apiCall(`/api/docker/stop/${container}`, 'POST');
                    results.push({ container, success: result.success, message: result.message });
                } catch (error) {
                    results.push({ container, success: false, message: error.message });
                }
            }
            
            const successCount = results.filter(r => r.success).length;
            const totalServices = 8; // Total services in microservices directory
            const message = `Stopped ${successCount}/${containers.length} container services (${totalServices} total services)`;
            
            setBulkOperationStatus(message, successCount === containers.length ? 'success' : 'warning');
            setTimeout(() => setBulkOperationStatus('', ''), 3000);
            
        } catch (error) {
            setBulkOperationStatus('Failed to stop services', 'error');
            setTimeout(() => setBulkOperationStatus('', ''), 3000);
        }
        
        setTimeout(loadDashboardData, 2000);
    }
    
    async function restartAllServices() {
        if (!confirm('Are you sure you want to restart all services?')) return;
        
        setBulkOperationStatus('Restarting all services...', 'info');
        
        try {
            const containers = ['relational_db', 'vector_db', 'crawler'];
            const results = [];
            
            for (const container of containers) {
                try {
                    const result = await apiCall(`/api/docker/restart/${container}`, 'POST');
                    results.push({ container, success: result.success, message: result.message });
                } catch (error) {
                    results.push({ container, success: false, message: error.message });
                }
            }
            
            const successCount = results.filter(r => r.success).length;
            const message = `Restarted ${successCount}/${containers.length} services successfully`;
            
            setBulkOperationStatus(message, successCount === containers.length ? 'success' : 'warning');
            setTimeout(() => setBulkOperationStatus('', ''), 3000);
            
        } catch (error) {
            setBulkOperationStatus('Failed to restart services', 'error');
            setTimeout(() => setBulkOperationStatus('', ''), 3000);
        }
        
        setTimeout(loadDashboardData, 2000);
    }
    
    async function refreshAllStatus() {
        setBulkOperationStatus('Refreshing all status...', 'info');
        await loadDashboardData();
        setBulkOperationStatus('Status refreshed', 'success');
        setTimeout(() => setBulkOperationStatus('', ''), 2000);
    }
    
    function setBulkOperationStatus(message, type) {
        const statusEl = document.getElementById('bulk-operation-status');
        statusEl.textContent = message;
        statusEl.className = '';
        
        if (type === 'success') {
            statusEl.style.color = '#16a34a';
        } else if (type === 'error') {
            statusEl.style.color = '#dc2626';
        } else if (type === 'warning') {
            statusEl.style.color = '#ea580c';
        } else {
            statusEl.style.color = '#3b82f6';
        }
    }
    
    async function checkEnvironmentStatus() {
        setBulkOperationStatus('Checking environment...', 'info');
        await updateEnvironmentStatus();
        setBulkOperationStatus('Environment checked', 'success');
        setTimeout(() => setBulkOperationStatus('', ''), 2000);
    }
    
    async function runComprehensiveHealthCheck() {
        setBulkOperationStatus('Running comprehensive health check for all 14 services...', 'info');
        
        try {
            // Get all services from our standardized API
            const servicesResult = await apiCall('/api/services/list');
            if (!servicesResult.success) {
                setBulkOperationStatus('Failed to get services list', 'error');
                return;
            }
            
            const allServices = [
                ...servicesResult.services.microservices,
                ...servicesResult.services.runtime,
                ...servicesResult.services.prewarm
            ];
            
            let healthResults = {
                total: allServices.length,
                healthy: 0,
                issues: 0,
                errors: 0,
                details: []
            };
            
            // Check health for each service
            for (const service of allServices) {
                const serviceName = service.name;
                setBulkOperationStatus(`Checking ${serviceName}... (${healthResults.healthy + healthResults.issues + healthResults.errors + 1}/${allServices.length})`, 'info');
                
                try {
                    const healthResult = await apiCall(`/api/service/${serviceName}/health`);
                    
                    if (healthResult.success && healthResult.health) {
                        const health = healthResult.health;
                        const status = health.success ? 'healthy' : 
                                     health.status === 'ready' ? 'healthy' : 
                                     health.status === 'not_ready' ? 'warning' : 'issues';
                        
                        if (status === 'healthy') {
                            healthResults.healthy++;
                            updateServiceStatusInUI(serviceName, service.service_type, 'healthy', health.message || 'OK');
                        } else if (status === 'warning') {
                            healthResults.issues++;
                            updateServiceStatusInUI(serviceName, service.service_type, 'warning', health.message || 'Issues detected');
                        } else {
                            healthResults.issues++;
                            updateServiceStatusInUI(serviceName, service.service_type, 'issues', health.message || health.error || 'Health check failed');
                        }
                        
                        healthResults.details.push({
                            service: serviceName,
                            type: service.service_type,
                            status: status,
                            message: health.message || health.error || 'No message'
                        });
                    } else {
                        healthResults.errors++;
                        updateServiceStatusInUI(serviceName, service.service_type, 'error', healthResult.error || 'Health check failed');
                        healthResults.details.push({
                            service: serviceName,
                            type: service.service_type,
                            status: 'error',
                            message: healthResult.error || 'Health check failed'
                        });
                    }
                } catch (error) {
                    healthResults.errors++;
                    healthResults.details.push({
                        service: serviceName,
                        type: service.service_type,
                        status: 'error',
                        message: error.message
                    });
                }
            }
            
            // Show final results
            const successRate = ((healthResults.healthy / healthResults.total) * 100).toFixed(1);
            const statusText = `Health Check Complete: ${healthResults.healthy}/${healthResults.total} healthy (${successRate}%)`;
            
            if (healthResults.errors > 0) {
                setBulkOperationStatus(statusText + ` - ${healthResults.errors} errors`, 'error');
            } else if (healthResults.issues > 0) {
                setBulkOperationStatus(statusText + ` - ${healthResults.issues} issues`, 'warning');
            } else {
                setBulkOperationStatus(statusText + ' - All systems operational!', 'success');
            }
            
            // Show detailed results modal
            showComprehensiveHealthModal(healthResults);
            
            setTimeout(() => setBulkOperationStatus('', ''), 8000);
            
        } catch (error) {
            setBulkOperationStatus('Comprehensive health check error: ' + error.message, 'error');
            setTimeout(() => setBulkOperationStatus('', ''), 5000);
        }
    }
    
    // Legacy health check function (keeping for compatibility)
    async function runHealthCheck() {
        // Redirect to the new comprehensive check
        await runComprehensiveHealthCheck();
    }
    
    function updateServiceStatusInUI(serviceName, serviceType, status, message) {
        // Update UI based on service type
        let dotId, textId, infoId;
        
        if (serviceType === 'microservice') {
            dotId = `${serviceName}-dot`;
            textId = `${serviceName}-text`;
            infoId = `${serviceName}-info`;
        } else if (serviceType === 'runtime') {
            dotId = `${serviceName}-runtime-dot`;
            textId = `${serviceName}-runtime-text`;
            infoId = `${serviceName}-runtime-info`;
        } else if (serviceType === 'prewarm') {
            dotId = `${serviceName}-prewarm-dot`;
            textId = `${serviceName}-prewarm-text`;
            infoId = `${serviceName}-prewarm-info`;
        }
        
        const dot = document.getElementById(dotId);
        const text = document.getElementById(textId);
        const info = document.getElementById(infoId);
        
        if (dot) {
            const colorClass = status === 'healthy' ? 'green' : 
                             status === 'warning' ? 'yellow' : 
                             status === 'issues' ? 'red' : 'gray';
            dot.className = `status-dot ${colorClass}`;
        }
        
        if (text) {
            const statusText = status === 'healthy' ? (serviceType === 'prewarm' ? 'Ready' : 'Online') :
                              status === 'warning' ? 'Warning' :
                              status === 'issues' ? 'Issues' : 'Error';
            text.textContent = statusText;
        }
        
        if (info) {
            info.textContent = message;
        }
    }
    
    function showComprehensiveHealthModal(healthResults) {
        let message = `Comprehensive Health Check Results\n`;
        message += `Total Services: ${healthResults.total}\n`;
        message += `Healthy: ${healthResults.healthy}\n`;
        message += `Issues: ${healthResults.issues}\n`;
        message += `Errors: ${healthResults.errors}\n`;
        message += `Success Rate: ${((healthResults.healthy / healthResults.total) * 100).toFixed(1)}%\n\n`;
        
        message += `Detailed Results:\n`;
        healthResults.details.forEach(detail => {
            const statusIcon = detail.status === 'healthy' ? '‚úÖ' : 
                              detail.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
            message += `${statusIcon} ${detail.service} (${detail.type}): ${detail.message}\n`;
        });
        
        alert(message);
    }
    
    let currentHealthResults = '';
    
    function showHealthCheckModal(health) {
        let message = `Health Check Results (${health.timestamp})\n\n`;
        message += `Overall Status: ${health.summary}\n\n`;
        
        Object.entries(health.checks).forEach(([category, check]) => {
            const statusIcon = check.status === 'healthy' ? '‚úÖ' : 
                             check.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå';
            message += `${statusIcon} ${category.toUpperCase()}: ${check.status}\n`;
            if (check.details) message += `   ${check.details}\n`;
            if (check.error) message += `   Error: ${check.error}\n`;
            message += '\n';
        });
        
        currentHealthResults = message;
        document.getElementById('health-check-content').textContent = message;
        document.getElementById('health-check-modal').style.display = 'flex';
    }
    
    function closeHealthCheck() {
        document.getElementById('health-check-modal').style.display = 'none';
    }
    
    function copyHealthResults() {
        if (currentHealthResults) {
            navigator.clipboard.writeText(currentHealthResults).then(() => {
                showAlert('Health check results copied to clipboard!', 'success');
            }).catch(err => {
                showAlert('Failed to copy to clipboard', 'error');
            });
        }
    }
    
    
    // Enhanced updateDockerStatus function to include environment indicator
    const originalUpdateDockerStatus = updateDockerStatus;
    updateDockerStatus = function(containers) {
        originalUpdateDockerStatus(containers);
        
        // Update environment status dot based on overall container health
        const runningCount = Object.values(containers).filter(c => c.status === 'running').length;
        const totalCount = Object.keys(containers).length;
        
        const envDot = document.getElementById('intelligence_platform-dot');
        const envText = document.getElementById('intelligence_platform-text');
        const envInfo = document.getElementById('intelligence_platform-info');
        
        if (runningCount === totalCount) {
            envDot.className = 'status-dot green';
            envText.textContent = 'All Services Running';
            envInfo.textContent = `${runningCount}/${totalCount} containers healthy`;
        } else if (runningCount > 0) {
            envDot.className = 'status-dot yellow';
            envText.textContent = 'Partial Services';
            envInfo.textContent = `${runningCount}/${totalCount} containers running`;
        } else {
            envDot.className = 'status-dot red';
            envText.textContent = 'Services Down';
            envInfo.textContent = 'No containers running';
        }
    };
    
    // AI Terminal Functions
    function openAITerminal() {
        document.getElementById('ai-terminal-modal').classList.add('active');
        document.getElementById('ai-input').focus();
    }
    
    function closeAITerminal() {
        document.getElementById('ai-terminal-modal').classList.remove('active');
    }
    
    async function sendAIMessage() {
        const input = document.getElementById('ai-input');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Add user message
        addAIMessage(message, 'user');
        input.value = '';
        
        // Show typing indicator
        const typingId = addTypingIndicator();
        
        try {
            // Call AI assistant API
            const response = await fetch('/api/ai-assistant', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            });
            
            const result = await response.json();
            
            // Remove typing indicator
            removeTypingIndicator(typingId);
            
            if (result.success) {
                addAIMessage(result.response, 'assistant');
            } else {
                addAIMessage('Sorry, I encountered an error: ' + (result.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            removeTypingIndicator(typingId);
            addAIMessage('Sorry, I couldn\'t process your request: ' + error.message, 'error');
        }
    }
    
    function addAIMessage(message, type) {
        const chatHistory = document.getElementById('ai-chat-history');
        const messageDiv = document.createElement('div');
        messageDiv.className = `ai-message ${type}`;
        
        const icon = type === 'user' ? 'üë§' : type === 'assistant' ? 'ü§ñ' : type === 'error' ? '‚ùå' : 'üí°';
        const label = type === 'user' ? 'You' : type === 'assistant' ? 'AI Assistant' : type === 'error' ? 'Error' : 'System';
        
        messageDiv.innerHTML = `<strong>${icon} ${label}:</strong> ${message.replace(/\n/g, '<br>')}`;
        
        chatHistory.appendChild(messageDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    
    function addTypingIndicator() {
        const chatHistory = document.getElementById('ai-chat-history');
        const typingDiv = document.createElement('div');
        const typingId = 'typing-' + Date.now();
        typingDiv.id = typingId;
        typingDiv.className = 'ai-message assistant';
        typingDiv.innerHTML = `
            <strong>ü§ñ AI Assistant:</strong> 
            <span class="ai-typing"></span>
            <span class="ai-typing"></span>
            <span class="ai-typing"></span>
        `;
        
        chatHistory.appendChild(typingDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        return typingId;
    }
    
    function removeTypingIndicator(typingId) {
        const typingDiv = document.getElementById(typingId);
        if (typingDiv) {
            typingDiv.remove();
        }
    }
    
    // Refresh sitemap status to sync frontend with backend
    async function refreshSitemapStatus() {
        try {
            const sitemapStatus = await apiCall('/api/acquisition/sitemap-status');
            if (sitemapStatus.success) {
                updateSitemapStats(sitemapStatus);
                showAlert('Sitemap status refreshed', 'success');
            } else {
                showAlert('Failed to refresh sitemap status', 'error');
            }
        } catch (error) {
            showAlert('Error refreshing sitemap status: ' + error.message, 'error');
        }
    }
    
    // Sitemap Download Functions
    async function downloadSitemap() {
        const sitemapUrl = document.getElementById('sitemap-url').textContent;
        
        if (!sitemapUrl || sitemapUrl === 'Enter URL above to detect sitemap...' || sitemapUrl === 'No sitemap found') {
            showAlert('Please detect a valid sitemap first', 'warning');
            return;
        }
        
        try {
            // Reset progress display
            updateSitemapProgress('preparing', 0, 'Preparing download...');
            
            const response = await fetch('/api/acquisition/download-sitemap', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sitemap_url: sitemapUrl })
            });
            
            const result = await response.json();
            
            if (result.success) {
                updateSitemapProgress('waiting', 0, 'Download started - watch for progress updates');
                
                // Disable download button during download
                const downloadBtn = document.getElementById('download-sitemap-btn');
                if (downloadBtn) {
                    downloadBtn.disabled = true;
                    downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
                }
                
                showAlert('Sitemap download started', 'success');
            } else {
                updateSitemapProgress('error', 0, result.message || 'Download failed');
                showAlert('Failed to start download: ' + (result.message || 'Unknown error'), 'error');
            }
        } catch (error) {
            updateSitemapProgress('error', 0, 'Download request failed: ' + error.message);
            showAlert('Error starting download: ' + error.message, 'error');
        }
    }
    
    function updateSitemapProgress(stage, progress, message, details) {
        const stageEl = document.getElementById('sitemap-download-stage');
        const progressTextEl = document.getElementById('sitemap-download-progress-text');
        const progressBarEl = document.getElementById('sitemap-download-progress-bar');
        const messageEl = document.getElementById('sitemap-download-message');
        const detailsEl = document.getElementById('sitemap-download-details');
        
        // Update stage text with appropriate styling
        const stageColors = {
            'preparing': '#3b82f6',
            'waiting': '#3b82f6',
            'downloading': '#f59e0b',
            'parsing': '#8b5cf6',
            'extracting': '#06b6d4',
            'filtering': '#10b981',
            'saving': '#6366f1',
            'completed': '#16a34a',
            'error': '#ef4444'
        };
        
        const stageLabels = {
            'preparing': 'Preparing',
            'waiting': 'Starting',
            'downloading': 'Downloading',
            'parsing': 'Parsing XML',
            'extracting': 'Extracting URLs',
            'filtering': 'Filtering Products',
            'saving': 'Saving Results',
            'completed': 'Complete',
            'error': 'Error'
        };
        
        if (stageEl) {
            stageEl.textContent = stageLabels[stage] || stage;
            stageEl.style.color = stageColors[stage] || '#4b5563';
        }
        
        // Update progress
        const progressPercent = Math.min(100, Math.max(0, progress));
        if (progressTextEl) {
            progressTextEl.textContent = progressPercent.toFixed(1) + '%';
        }
        if (progressBarEl) {
            progressBarEl.style.width = progressPercent + '%';
            
            // Change progress bar color based on stage
            if (stage === 'completed') {
                progressBarEl.style.background = 'linear-gradient(90deg, #10b981, #059669)';
            } else if (stage === 'error') {
                progressBarEl.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
            } else {
                progressBarEl.style.background = 'linear-gradient(90deg, #3b82f6, #1d4ed8)';
            }
        }
        
        // Update message
        if (messageEl) {
            messageEl.textContent = message;
        }
        
        // Update details if provided
        if (details && detailsEl) {
            let detailText = '';
            if (details.total_urls && details.filtered_urls) {
                detailText = `Total URLs: ${details.total_urls.toLocaleString()}, `;
                detailText += `Filtered: ${details.filtered_urls.toLocaleString()} `;
                detailText += `(${details.filter_percentage.toFixed(1)}%)`;
            }
            if (details.file_saved) {
                detailText += detailText ? ` ‚Ä¢ Saved to: ${details.file_saved}` : `Saved to: ${details.file_saved}`;
            }
            
            if (detailText) {
                detailsEl.textContent = detailText;
                detailsEl.style.display = 'block';
            }
        }
        
        // Re-enable download button when complete or error
        if (stage === 'completed' || stage === 'error') {
            const downloadBtn = document.getElementById('download-sitemap-btn');
            if (downloadBtn) {
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download Sitemap';
            }
        }
    }
    
    // Handle sitemap progress updates via WebSocket
    if (socket) {
        socket.on('sitemap_progress', function(data) {
            updateSitemapProgress(data.stage, data.progress, data.message, data.details);
            
            // Show completion alert and refresh stats
            if (data.stage === 'completed') {
                showAlert('Sitemap download completed successfully!', 'success');
                // Refresh sitemap statistics after completion
                setTimeout(async () => {
                    const sitemapStatus = await apiCall('/api/acquisition/sitemap-status');
                    if (sitemapStatus.success) {
                        updateSitemapStats(sitemapStatus);
                    }
                }, 1000);
            } else if (data.stage === 'error') {
                showAlert('Sitemap download failed: ' + data.message, 'error');
            }
        });
    }

    // SKU Lookup Function
    async function lookupSku() {
        const skuInput = document.getElementById('sku-input');
        const resultsDiv = document.getElementById('sku-results');
        const errorDiv = document.getElementById('sku-error');
        const loadingDiv = document.getElementById('sku-loading');
        const productInfo = document.getElementById('sku-product-info');
        
        const sku = skuInput.value.trim();
        
        if (!sku) {
            showAlert('Please enter a SKU to search', 'warning');
            return;
        }
        
        // Show loading state
        resultsDiv.style.display = 'none';
        errorDiv.style.display = 'none';
        loadingDiv.style.display = 'block';
        
        try {
            const response = await fetch(`/api/database/product/sku/${encodeURIComponent(sku)}`);
            const result = await response.json();
            
            loadingDiv.style.display = 'none';
            
            if (result.success) {
                if (result.found && result.product) {
                    // Display product information
                    displayProductInfo(result.product);
                    resultsDiv.style.display = 'block';
                    showAlert(`Product found: ${result.product.title || 'Untitled'}`, 'success');
                } else {
                    // No product found
                    errorDiv.innerHTML = `<strong>No product found</strong><br>${result.message || 'No product with this SKU exists in the database.'}`;
                    errorDiv.style.display = 'block';
                }
            } else {
                // API error
                errorDiv.innerHTML = `<strong>Search Error</strong><br>${result.error || 'Unknown error occurred'}`;
                errorDiv.style.display = 'block';
                showAlert('SKU search failed', 'error');
            }
        } catch (error) {
            loadingDiv.style.display = 'none';
            errorDiv.innerHTML = `<strong>Connection Error</strong><br>Unable to connect to database: ${error.message}`;
            errorDiv.style.display = 'block';
            showAlert('Database connection error', 'error');
        }
    }

    function displayProductInfo(product) {
        const productInfo = document.getElementById('sku-product-info');
        
        // Create comprehensive product view
        let html = `
            <div style="max-height: 600px; overflow-y: auto;">
                <!-- Product Header -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; position: relative;">
                    <!-- Close Button -->
                    <button onclick="closeProductPopup()" style="position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.2); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        <i class="fas fa-times"></i>
                    </button>
                    
                    <h3 style="margin: 0; font-size: 1.3rem; padding-right: 3rem;">
                        <i class="fas fa-cube"></i> ${product.title || 'Untitled Product'}
                    </h3>
                    
                    <!-- SKU and Enhanced Pricing Section -->
                    <div style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <span style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.9rem;">
                                SKU: <strong>${product.sku}</strong>
                            </span>
                        </div>
                        <div style="text-align: right;">
                            <!-- Enhanced Pricing Display -->
                            <div style="display: flex; flex-direction: column; gap: 0.25rem; align-items: flex-end;">
                                ${product.price_per_sqft ? `<div style="font-size: 1.2rem; font-weight: bold; background: rgba(255,255,255,0.15); padding: 0.25rem 0.75rem; border-radius: 15px;">$${parseFloat(product.price_per_sqft).toFixed(2)} /sf</div>` : ''}
                                ${product.price_per_box ? `<div style="font-size: 1.1rem; font-weight: 600; background: rgba(255,255,255,0.1); padding: 0.25rem 0.75rem; border-radius: 15px;">$${parseFloat(product.price_per_box).toFixed(2)} /bx</div>` : ''}
                                ${product.price_per_piece ? `<div style="font-size: 1.1rem; font-weight: 600; background: rgba(255,255,255,0.1); padding: 0.25rem 0.75rem; border-radius: 15px;">$${parseFloat(product.price_per_piece).toFixed(2)} /each</div>` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Complete Dataset Tabs View -->
                <div style="display: grid; gap: 1.5rem;">
        `;

        // Product Details Tab
        html += `
            <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                <div style="background: #f8fafc; padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <h4 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-info-circle" style="color: #3b82f6;"></i> Product Details
                    </h4>
                </div>
                <div style="padding: 1rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        `;

        // All available fields - comprehensive list with enhanced auto-expanded specifications
        const productFields = [
            // Basic Product Information
            { key: 'brand', label: 'Brand', icon: 'fas fa-tag' },
            { key: 'coverage', label: 'Coverage', icon: 'fas fa-ruler-combined' },
            { key: 'finish', label: 'Finish', icon: 'fas fa-paint-brush' },
            { key: 'color', label: 'Color', icon: 'fas fa-palette' },
            { key: 'size_shape', label: 'Size & Shape', icon: 'fas fa-shapes' },
            { key: 'product_category', label: 'Category', icon: 'fas fa-folder' },
            { key: 'slip_rating', label: 'Slip Rating', icon: 'fas fa-shield-alt' },
            
            // Enhanced Auto-Expanded Specification Fields
            { key: 'thickness', label: 'Thickness', icon: 'fas fa-ruler' },
            { key: 'box_quantity', label: 'Box Quantity', icon: 'fas fa-boxes' },
            { key: 'box_weight', label: 'Box Weight', icon: 'fas fa-weight-hanging' },
            { key: 'edge_type', label: 'Edge Type', icon: 'fas fa-cut' },
            { key: 'shade_variation', label: 'Shade Variation', icon: 'fas fa-adjust' },
            { key: 'number_of_faces', label: 'Number of Faces', icon: 'fas fa-layer-group' },
            { key: 'directional_layout', label: 'Directional Layout', icon: 'fas fa-arrows-alt', format: 'boolean' },
            { key: 'country_of_origin', label: 'Country of Origin', icon: 'fas fa-globe-americas' },
            { key: 'material_type', label: 'Material Type', icon: 'fas fa-hammer' },
            
            // Enhanced Categorization Fields
            { key: 'category', label: 'Primary Category', icon: 'fas fa-folder-open' },
            { key: 'subcategory', label: 'Subcategory', icon: 'fas fa-folder' },
            { key: 'product_type', label: 'Product Type', icon: 'fas fa-cube' },
            { key: 'application_areas', label: 'Applications', icon: 'fas fa-map-marker-alt', format: 'json_array' },
            { key: 'typical_use_cases', label: 'Typical Use Cases', icon: 'fas fa-home', format: 'json_array' },
            { key: 'installation_complexity', label: 'Installation Complexity', icon: 'fas fa-tools' },
            
            // Pricing
            { key: 'price_per_box', label: 'Price per Box', icon: 'fas fa-dollar-sign', format: 'currency' },
            { key: 'price_per_sqft', label: 'Price per Sq Ft', icon: 'fas fa-calculator', format: 'currency' },
            { key: 'price_per_piece', label: 'Price per Piece', icon: 'fas fa-coins', format: 'currency' },
            
            // System Information
            { key: 'scraped_at', label: 'Data Collected', icon: 'fas fa-clock', format: 'date' },
            { key: 'updated_at', label: 'Last Updated', icon: 'fas fa-sync-alt', format: 'date' }
        ];

        let fieldsDisplayed = 0;
        productFields.forEach(field => {
            if (product[field.key]) {
                let value = product[field.key];
                if (field.format === 'currency') {
                    value = `$${parseFloat(value).toFixed(2)}`;
                } else if (field.format === 'date') {
                    try {
                        const date = new Date(value);
                        value = date.toLocaleString('en-US', {
                            timeZone: 'America/New_York',
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch (e) {
                        // Keep original value if date parsing fails
                    }
                } else if (field.format === 'boolean') {
                    value = value ? 'Yes' : 'No';
                } else if (field.format === 'json_array') {
                    try {
                        if (typeof value === 'string') {
                            const parsed = JSON.parse(value);
                            value = Array.isArray(parsed) ? parsed.join(', ') : value;
                        } else if (Array.isArray(value)) {
                            value = value.join(', ');
                        }
                    } catch (e) {
                        // Keep original value if JSON parsing fails
                    }
                } else if (field.key === 'slip_rating') {
                    value = value.replace('_', ' ').toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
                } else if (field.key === 'product_category') {
                    value = value.replace('_', ' ').toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
                }
                
                fieldsDisplayed++;
                html += `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px;">
                        <i class="${field.icon}" style="color: #6b7280; width: 16px;"></i>
                        <div>
                            <div style="font-size: 0.8rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em;">${field.label}</div>
                            <div style="font-weight: 600; color: #1f2937;">${value}</div>
                        </div>
                    </div>
                `;
            }
        });

        // Show warning if minimal data available
        if (fieldsDisplayed < 3 || product.title === "The Tile Shop - High Quality Floor &amp; Wall Tile") {
            html += `
                <div style="grid-column: 1/-1; background: #fef3c7; border: 1px solid #f59e0b; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; color: #92400e;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <div style="font-weight: 600;">Limited Product Data</div>
                            <div style="font-size: 0.9rem; margin-top: 0.25rem;">
                                This product appears to have minimal extracted data. The learning system may need to re-process this URL to capture complete product information including pricing, specifications, and images.
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        html += `
                    </div>
                </div>
            </div>
        `;

        // Description Tab
        if (product.description) {
            html += `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <div style="background: #f8fafc; padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                        <h4 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-file-text" style="color: #10b981;"></i> Description
                        </h4>
                    </div>
                    <div style="padding: 1rem;">
                        <div style="line-height: 1.6; color: #374151;">${product.description}</div>
                    </div>
                </div>
            `;
        }

        // Specifications Tab
        if (product.specifications) {
            html += `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <div style="background: #f8fafc; padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                        <h4 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-cogs" style="color: #f59e0b;"></i> Technical Specifications
                        </h4>
                    </div>
                    <div style="padding: 1rem;">
            `;

            // Try to format specifications nicely
            try {
                let specs = typeof product.specifications === 'string' ? JSON.parse(product.specifications) : product.specifications;
                if (typeof specs === 'object' && specs !== null) {
                    html += `<div style="display: grid; gap: 0.75rem;">`;
                    Object.entries(specs).forEach(([key, value]) => {
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 6px; border-left: 4px solid #f59e0b;">
                                <span style="font-weight: 600; color: #374151; text-transform: capitalize;">${key.replace(/_/g, ' ')}</span>
                                <span style="color: #6b7280; font-family: monospace;">${value}</span>
                            </div>
                        `;
                    });
                    html += `</div>`;
                } else {
                    html += `<pre style="background: #f9fafb; padding: 1rem; border-radius: 6px; font-size: 0.9rem; overflow-x: auto;">${JSON.stringify(specs, null, 2)}</pre>`;
                }
            } catch (e) {
                html += `<pre style="background: #f9fafb; padding: 1rem; border-radius: 6px; font-size: 0.9rem; overflow-x: auto;">${product.specifications}</pre>`;
            }

            html += `
                    </div>
                </div>
            `;
        }

        // Resources Tab (PDFs, Installation Guides, etc.)
        if (product.resources) {
            html += `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <div style="background: #f8fafc; padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                        <h4 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-file-pdf" style="color: #dc2626;"></i> Resources & Downloads
                        </h4>
                    </div>
                    <div style="padding: 1rem;">
            `;

            // Try to format resources nicely
            try {
                let resources = typeof product.resources === 'string' ? JSON.parse(product.resources) : product.resources;
                if (typeof resources === 'object' && resources !== null) {
                    
                    // PDF Links
                    if (resources.pdf_links && resources.pdf_links.length > 0) {
                        html += `
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-file-pdf" style="color: #dc2626;"></i> PDF Documents
                                </h5>
                                <div style="display: grid; gap: 0.5rem;">
                        `;
                        resources.pdf_links.forEach(pdf => {
                            const title = pdf.title || pdf.url || 'PDF Document';
                            const url = pdf.url || pdf;
                            html += `
                                <a href="${url}" target="_blank" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; text-decoration: none; color: #991b1b; transition: all 0.2s ease;">
                                    <i class="fas fa-file-pdf" style="color: #dc2626; font-size: 1.2rem;"></i>
                                    <div>
                                        <div style="font-weight: 600;">${title}</div>
                                        <div style="font-size: 0.8rem; opacity: 0.7;">${url}</div>
                                    </div>
                                    <i class="fas fa-external-link-alt" style="margin-left: auto; opacity: 0.5;"></i>
                                </a>
                            `;
                        });
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    // Installation Guides
                    if (resources.installation_guides && resources.installation_guides.length > 0) {
                        html += `
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-tools" style="color: #059669;"></i> Installation Guides
                                </h5>
                                <div style="display: grid; gap: 0.5rem;">
                        `;
                        resources.installation_guides.forEach(guide => {
                            html += `
                                <a href="${guide.url}" target="_blank" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px; text-decoration: none; color: #065f46; transition: all 0.2s ease;">
                                    <i class="fas fa-tools" style="color: #059669; font-size: 1.2rem;"></i>
                                    <div>
                                        <div style="font-weight: 600;">${guide.title}</div>
                                        <div style="font-size: 0.8rem; opacity: 0.7;">${guide.url}</div>
                                    </div>
                                    <i class="fas fa-external-link-alt" style="margin-left: auto; opacity: 0.5;"></i>
                                </a>
                            `;
                        });
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    // Other resource types
                    ['spec_sheets', 'care_instructions', 'warranty_info'].forEach(resourceType => {
                        if (resources[resourceType] && resources[resourceType].length > 0) {
                            const typeLabels = {
                                'spec_sheets': { label: 'Specification Sheets', icon: 'fas fa-clipboard-list', color: '#3b82f6', bgColor: '#eff6ff', borderColor: '#bfdbfe' },
                                'care_instructions': { label: 'Care Instructions', icon: 'fas fa-heart', color: '#7c3aed', bgColor: '#f3f4f6', borderColor: '#d1d5db' },
                                'warranty_info': { label: 'Warranty Information', icon: 'fas fa-shield-alt', color: '#f59e0b', bgColor: '#fffbeb', borderColor: '#fde68a' }
                            };
                            const typeInfo = typeLabels[resourceType];
                            
                            html += `
                                <div style="margin-bottom: 1.5rem;">
                                    <h5 style="margin: 0 0 0.75rem 0; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="${typeInfo.icon}" style="color: ${typeInfo.color};"></i> ${typeInfo.label}
                                    </h5>
                                    <div style="display: grid; gap: 0.5rem;">
                            `;
                            resources[resourceType].forEach(item => {
                                html += `
                                    <a href="${item.url}" target="_blank" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: ${typeInfo.bgColor}; border: 1px solid ${typeInfo.borderColor}; border-radius: 6px; text-decoration: none; color: ${typeInfo.color}; transition: all 0.2s ease;">
                                        <i class="${typeInfo.icon}" style="color: ${typeInfo.color}; font-size: 1.2rem;"></i>
                                        <div>
                                            <div style="font-weight: 600;">${item.title}</div>
                                            <div style="font-size: 0.8rem; opacity: 0.7;">${item.url}</div>
                                        </div>
                                        <i class="fas fa-external-link-alt" style="margin-left: auto; opacity: 0.5;"></i>
                                    </a>
                                `;
                            });
                            html += `
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                } else {
                    html += `<pre style="background: #f9fafb; padding: 1rem; border-radius: 6px; font-size: 0.9rem; overflow-x: auto;">${JSON.stringify(resources, null, 2)}</pre>`;
                }
            } catch (e) {
                html += `<pre style="background: #f9fafb; padding: 1rem; border-radius: 6px; font-size: 0.9rem; overflow-x: auto;">${product.resources}</pre>`;
            }

            html += `
                    </div>
                </div>
            `;
        }

        // Images Tab
        if (product.images || product.primary_image) {
            html += `
                <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <div style="background: #f8fafc; padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                        <h4 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-images" style="color: #8b5cf6;"></i> Product Images
                        </h4>
                    </div>
                    <div style="padding: 1rem;">
            `;

            // Primary Image
            if (product.primary_image) {
                html += `
                    <div style="margin-bottom: 1.5rem;">
                        <h5 style="margin: 0 0 0.75rem 0; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-star" style="color: #fbbf24;"></i> Primary Image
                        </h5>
                        <div style="text-align: center; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 2px dashed #d1d5db;">
                            <img src="${product.primary_image}" alt="Primary product image" style="max-width: 300px; max-height: 300px; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div style="display: none; color: #6b7280; font-style: italic;">Image failed to load</div>
                            <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #6b7280; word-break: break-all;">${product.primary_image}</div>
                        </div>
                    </div>
                `;
            }

            // Additional Images
            if (product.images) {
                try {
                    let images = typeof product.images === 'string' ? JSON.parse(product.images) : product.images;
                    if (Array.isArray(images) && images.length > 0) {
                        html += `
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-images" style="color: #8b5cf6;"></i> Additional Images
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
                        `;
                        images.forEach((img, index) => {
                            html += `
                                <div style="text-align: center; padding: 0.5rem; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <img src="${img}" alt="Product image ${index + 1}" style="width: 100%; max-height: 120px; object-fit: cover; border-radius: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <div style="display: none; color: #6b7280; font-style: italic; font-size: 0.8rem;">Failed to load</div>
                                    <div style="margin-top: 0.25rem; font-size: 0.7rem; color: #6b7280; word-break: break-all;">${img}</div>
                                </div>
                            `;
                        });
                        html += `
                                </div>
                            </div>
                        `;
                    }
                } catch (e) {
                    html += `<pre style="background: #f9fafb; padding: 1rem; border-radius: 6px; font-size: 0.9rem; overflow-x: auto;">${product.images}</pre>`;
                }
            }

            html += `
                    </div>
                </div>
            `;
        }

        // Raw Data Tab
        html += `
            <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                <div style="background: #f8fafc; padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <h4 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-database" style="color: #8b5cf6;"></i> Complete Database Record
                    </h4>
                </div>
                <div style="padding: 1rem;">
                    <div style="display: grid; gap: 0.5rem; font-family: monospace; font-size: 0.85rem;">
        `;

        // Show ALL fields from the database (including null/empty to show complete schema)
        Object.entries(product).forEach(([key, value]) => {
            let displayValue = value;
            let valueStyle = 'color: #6b7280;';
            
            // Handle null/undefined/empty values
            if (value === null) {
                displayValue = 'null';
                valueStyle = 'color: #9ca3af; font-style: italic;';
            } else if (value === undefined) {
                displayValue = 'undefined';
                valueStyle = 'color: #9ca3af; font-style: italic;';
            } else if (value === '') {
                displayValue = '(empty string)';
                valueStyle = 'color: #9ca3af; font-style: italic;';
            } else {
                // Format different data types
                if (key.includes('_at') && typeof value === 'string') {
                    try {
                        const date = new Date(value);
                        displayValue = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                    } catch (e) {
                        displayValue = value;
                    }
                } else if (typeof value === 'object') {
                    if (Array.isArray(value) && value.length === 0) {
                        displayValue = '(empty array)';
                        valueStyle = 'color: #9ca3af; font-style: italic;';
                    } else if (typeof value === 'object' && Object.keys(value).length === 0) {
                        displayValue = '(empty object)';
                        valueStyle = 'color: #9ca3af; font-style: italic;';
                    } else {
                        displayValue = JSON.stringify(value, null, 2);
                    }
                } else if (typeof value === 'number') {
                    displayValue = value.toString();
                }
            }

            html += `
                <div style="display: grid; grid-template-columns: 140px 1fr; gap: 1rem; padding: 0.5rem; background: ${key === 'id' || key === 'sku' ? '#eff6ff' : '#f9fafb'}; border-radius: 4px; border-left: 3px solid ${key === 'id' || key === 'sku' ? '#3b82f6' : '#e5e7eb'};">
                    <span style="font-weight: 600; color: #374151; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">${key.replace(/_/g, ' ')}</span>
                    <span style="${valueStyle} word-break: break-all;">${displayValue}</span>
                </div>
            `;
        });

        html += `
                    </div>
                </div>
            </div>
        `;

        // Actions Tab
        html += `
            <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                <div style="background: #f8fafc; padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <h4 style="margin: 0; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-external-link-alt" style="color: #ef4444;"></i> External Links & Actions
                    </h4>
                </div>
                <div style="padding: 1rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
        `;

        // Handle both single URLs and batch URLs for batch processing
        const urls = [];
        
        // Primary URL
        if (product.url) {
            urls.push({
                url: product.url,
                label: 'Primary Product',
                icon: 'fas fa-shopping-cart'
            });
        }
        
        // Color variation URLs (batch processing)
        if (product.color_variations && Array.isArray(product.color_variations)) {
            product.color_variations.forEach((variation, index) => {
                if (variation.url) {
                    urls.push({
                        url: variation.url,
                        label: `${variation.color || 'Variation'} ${variation.sku ? '(SKU: ' + variation.sku + ')' : ''}`,
                        icon: 'fas fa-palette'
                    });
                }
            });
        }
        
        // Batch URLs from processing (if stored as array)
        if (product.batch_urls && Array.isArray(product.batch_urls)) {
            product.batch_urls.forEach((batchUrl, index) => {
                urls.push({
                    url: batchUrl.url || batchUrl,
                    label: batchUrl.label || `Batch Item ${index + 1}`,
                    icon: 'fas fa-layer-group'
                });
            });
        }
        
        // Display all URLs with responsive layout
        if (urls.length > 0) {
            html += `<div style="width: 100%; margin-bottom: 0.5rem;">`;
            
            if (urls.length === 1) {
                // Single URL - show as primary button
                const urlItem = urls[0];
                html += `
                    <a href="${urlItem.url}" target="_blank" class="btn btn-secondary" style="font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; width: 100%;">
                        <i class="${urlItem.icon}"></i> View ${urlItem.label}
                    </a>
                `;
            } else {
                // Multiple URLs - show batch processing layout
                html += `<div style="margin-bottom: 0.5rem; color: #4f46e5; font-weight: 600; font-size: 0.9rem;">
                    <i class="fas fa-layer-group"></i> Batch Processing (${urls.length} URLs)
                </div>`;
                
                html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 0.5rem;">`;
                
                urls.forEach((urlItem, index) => {
                    const buttonStyle = index === 0 ? 'btn-primary' : 'btn-outline-secondary';
                    html += `
                        <a href="${urlItem.url}" target="_blank" class="btn ${buttonStyle}" 
                           style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem; text-align: left; padding: 0.5rem 0.75rem;"
                           title="${urlItem.url}">
                            <i class="${urlItem.icon}" style="min-width: 12px;"></i> 
                            <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${urlItem.label}</span>
                        </a>
                    `;
                });
                
                html += `</div>`;
            }
            
            html += `</div>`;
        }

        html += `
                <button onclick="copyToClipboard('${product.sku}')" class="btn btn-secondary" style="font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-copy"></i> Copy SKU
                </button>
                <button onclick="copyToClipboard('${JSON.stringify(product, null, 2).replace(/'/g, "\\'")}'); showAlert('Product data copied to clipboard', 'success')" class="btn btn-secondary" style="font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-download"></i> Copy JSON Data
                </button>
        `;
        
        // Add re-learn button for products with limited data
        if (fieldsDisplayed < 5 || product.title === "The Tile Shop - High Quality Floor &amp; Wall Tile") {
            html += `
                <button onclick="relearnProduct('${product.url}', '${product.sku}')" class="btn btn-warning" style="font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-refresh"></i> Re-Learn Product
                </button>
            `;
        }
        
        html += `
                    </div>
                </div>
            </div>
        `;

        html += `
                </div>
            </div>
        `;
        
        productInfo.innerHTML = html;
        
        // Add click-outside-to-close functionality and ESC key support
        setTimeout(() => {
            const resultsDiv = document.getElementById('sku-results');
            if (resultsDiv && resultsDiv.style.display !== 'none') {
                // Add click event listener to the results container
                resultsDiv.onclick = function(event) {
                    // Only close if clicking on the background, not the content
                    if (event.target === resultsDiv) {
                        closeProductPopup();
                    }
                };
                
                // Make the results div act as a modal background
                resultsDiv.style.cursor = 'pointer';
                const productInfoDiv = document.getElementById('sku-product-info');
                if (productInfoDiv) {
                    productInfoDiv.style.cursor = 'default';
                }
                
                // Add ESC key listener
                document.addEventListener('keydown', handlePopupEscKey);
            }
        }, 100);
    }
    
    // Function to close the product popup
    function closeProductPopup() {
        const resultsDiv = document.getElementById('sku-results');
        const errorDiv = document.getElementById('sku-error');
        
        if (resultsDiv) {
            resultsDiv.style.display = 'none';
            resultsDiv.onclick = null; // Remove click listener
        }
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
        
        // Remove ESC key listener
        document.removeEventListener('keydown', handlePopupEscKey);
    }
    
    // Handle ESC key press for popup
    function handlePopupEscKey(event) {
        if (event.key === 'Escape') {
            closeProductPopup();
        }
    }

    // Function to re-learn a specific product
    async function relearnProduct(url, sku) {
        if (!confirm(`Re-learn product ${sku}?\n\nThis will trigger the learning system to re-process this specific URL and update the product data. This may take 30-60 seconds.`)) {
            return;
        }
        
        try {
            showAlert(`Starting re-learning process for SKU ${sku}...`, 'info');
            
            // Make API call to re-learn the specific product
            const response = await fetch('/api/acquisition/relearn-product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url: url,
                    sku: sku
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert(`Successfully started re-learning process for ${sku}. Check back in a few minutes for updated data.`, 'success');
                // Close popup and refresh after a delay
                setTimeout(() => {
                    closeProductPopup();
                    // Optionally refresh the product data
                    setTimeout(() => {
                        lookupSku(sku);
                    }, 2000);
                }, 2000);
            } else {
                showAlert(`Failed to start re-learning: ${result.error || 'Unknown error'}`, 'error');
            }
            
        } catch (error) {
            console.error('Re-learn error:', error);
            showAlert(`Error starting re-learning process: ${error.message}`, 'error');
        }
    }

    // Helper function to copy text to clipboard
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showAlert('Copied to clipboard!', 'success');
        }).catch(() => {
            showAlert('Failed to copy to clipboard', 'error');
        });
    }

    // Data Quality Check Functions
    async function checkDataQuality() {
        try {
            const result = await apiCall('/api/database/quality-check');
            
            if (result.success) {
                updateQualityDisplay(result);
                
                // Show alert if quality is poor
                if (result.alert_level === 'critical' || result.alert_level === 'warning') {
                    showQualityAlert(result);
                } else {
                    hideQualityAlert();
                }
            } else {
                console.error('Quality check failed:', result.error);
            }
        } catch (error) {
            console.error('Error checking data quality:', error);
        }
    }

    function updateQualityDisplay(data) {
        // Update quality statistics in any existing displays
        const elements = {
            'quality-total-products': data.total_recent_products || 0,
            'quality-high-quality': data.high_quality_products || 0,
            'quality-low-quality': data.low_quality_products || 0,
            'quality-percentage': Math.round(data.quality_percentage || 0) + '%'
        };

        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        });
    }

    function showQualityAlert(data) {
        const alertCard = document.getElementById('quality-alert-card');
        const alertDot = document.getElementById('quality-alert-dot');
        const alertTitle = document.getElementById('quality-alert-title');
        const alertSummary = document.getElementById('quality-alert-summary');

        if (alertCard) {
            // Set alert level styling
            alertDot.className = `status-dot ${data.alert_level === 'critical' ? 'red' : 'yellow'}`;
            
            // Update content
            alertTitle.textContent = data.alert_level === 'critical' 
                ? 'Critical: Data Extraction Failure' 
                : 'Warning: Poor Data Quality';
            
            alertSummary.textContent = `${data.low_quality_products} of ${data.total_recent_products} sampled products have insufficient data (< 4 of 10 basic fields populated)`;
            
            // Show the alert
            alertCard.style.display = 'block';
        }
    }

    function hideQualityAlert() {
        const alertCard = document.getElementById('quality-alert-card');
        if (alertCard) {
            alertCard.style.display = 'none';
        }
    }

    function refreshQualityCheck() {
        checkDataQuality();
    }

    function dismissQualityAlert() {
        hideQualityAlert();
    }

    // Add quality check to the main dashboard update cycle
    const originalLoadDashboardData2 = loadDashboardData;
    loadDashboardData = async function() {
        await originalLoadDashboardData2();
        await checkDataQuality();
    };
</script>
{% endblock %}